<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://unpkg.com https://accounts.google.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com data:;
    img-src 'self' data: blob: https://www.gstatic.com;
    connect-src 'self' https://generativelanguage.googleapis.com https://unpkg.com;
    frame-src 'self' https://accounts.google.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>Galvan AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --ease-out-quint: cubic-bezier(0.23, 1, 0.32, 1);
    --ease-in-out-cubic: cubic-bezier(0.65, 0, 0.35, 1);
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-spring-gentle: cubic-bezier(0.25, 1.5, 0.5, 1);
    --ease-soft-spring: cubic-bezier(0.4, 1.3, 0.6, 1);
    --ease-smoother: cubic-bezier(0.4, 0, 0.2, 1);
    --apple-spring: cubic-bezier(0.23, 1, 0.32, 1);
    --ease-squish: cubic-bezier(0.5, -0.1, 0.1, 1.01);
    --ease-expo-out: cubic-bezier(0.16, 1, 0.3, 1);
    --ease-elastic-gentle: cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-sleek: cubic-bezier(0.22, 1, 0.36, 1);
    --ease-elastic-out: cubic-bezier(0.34, 1.56, 0.64, 1);
    --fluid-ease: cubic-bezier(0.25, 1, 0.35, 1);
    --soft-bounce: cubic-bezier(0.34, 1.3, 0.64, 1);
    --anim-spring: cubic-bezier(0.19, 1, 0.22, 1);
    --header-height: 52px;
    --galvan-suggestions-top-offset: 50%;
    --galvan-logo-vertical-gap: 22vh;
    --galvan-logo-glow-std-deviation-large: 4.5;
    --galvan-logo-glow-std-deviation-small: 2.8;
    --galvan-logo-glow-opacity: 0.9;
    --galvan-vv-border-stroke-width-large: 10;
    --galvan-vv-border-stroke-width-small: 16;
    --galvan-blur-intensity-multiplier: 1;
    --galvan-ui-backdrop-blur-amount: 12px;
    --galvan-background-main-blur-amount: 12px;
    --galvan-background-main-blur-amount-dark-override: 15px;
    --galvan-body-bg-light: #003cff;
    --galvan-bg-primary-light: #ffffff00;
    --galvan-bg-secondary-light: #F8F9FC;
    --galvan-bg-tertiary-light: #EFF2F7;
    --galvan-text-primary-light: #111827;
    --galvan-text-secondary-light: #000000;
    --galvan-text-placeholder-light: #000000;
    --galvan-border-color-light: #E5E7EB;
    --galvan-icon-primary-light: #0041ff;
    --galvan-icon-active-light: #0041ff;
    --galvan-icon-static-light: #6B7280;
    --galvan-user-msg-bg-light: linear-gradient(135deg, #0061ff59, #2563EB);
    --galvan-bot-msg-bg-light: #f3f4f64d;
    --galvan-logo-stop-1-light: #0417a6;
    --galvan-logo-stop-2-light: #00a1ffe3;
    --galvan-logo-stop-3-light: #00ff26b3;
    --galvan-logo-glow-color-light: #60a5fa00;
    --galvan-greeting-grad-light: linear-gradient(120deg, #1D4ED8, #3B82F6);
    --galvan-body-bg-dark: rgb(1, 29, 113);
    --galvan-bg-primary-dark: #11182700;
    --galvan-bg-secondary-dark: #1F2937;
    --galvan-bg-tertiary-dark: #374151;
    --galvan-text-primary-dark: #F9FAFB;
    --galvan-text-secondary-dark: #dfe3ea;
    --galvan-text-placeholder-dark: #ffffff;
    --galvan-border-color-dark: #4a4c4f;
    --galvan-icon-primary-dark: #9ec9fd;
    --galvan-icon-active-dark: #93C5FD;
    --galvan-icon-static-dark: #eff5ff;
    --galvan-user-msg-bg-dark: linear-gradient(135deg, #2564eb72, #0263ff);
    --galvan-bot-msg-bg-dark: #0000002e;
    --galvan-logo-stop-1-dark: #00d5ffbc;
    --galvan-logo-stop-2-dark: #0658c5;
    --galvan-logo-stop-3-dark: #00ff00cf;
    --galvan-logo-glow-color-dark: #60A5FA;
    --galvan-wave-color-dark: rgba(96, 165, 250, 0.133);
    --galvan-logo-blur-grad-dark: radial-gradient(ellipse 90% 70% at 50% 120%, hsla(230, 50%, 15%, 0.8), transparent), radial-gradient(ellipse 60% 50% at 85% 25%, hsl(265, 90%, 60%), transparent), radial-gradient(ellipse 70% 50% at 15% 80%, hsl(190, 100%, 50%), transparent), radial-gradient(ellipse 80% 60% at 50% 50%, hsla(220, 100%, 50%, 0.5), transparent), radial-gradient(ellipse 50% 50% at 90% 90%, hsla(310, 100%, 50%, 0.4), transparent);
    --galvan-greeting-grad-dark: linear-gradient(120deg, #1D4ED8, #3B82F6);
    --app-body-bg-light: var(--galvan-body-bg-light);
    --app-bg-primary-light: var(--galvan-bg-primary-light);
    --app-bg-secondary-light: var(--galvan-bg-secondary-light);
    --app-bg-tertiary-light: var(--galvan-bg-tertiary-light);
    --app-text-primary-light: var(--galvan-text-primary-light);
    --app-text-secondary-light: var(--galvan-text-secondary-light);
    --app-text-placeholder-light: var(--galvan-text-placeholder-light);
    --app-border-color-light: var(--galvan-border-color-light);
    --app-icon-primary-light: var(--galvan-icon-primary-light);
    --app-icon-active-light: var(--galvan-icon-active-light);
    --app-icon-static-light: var(--galvan-icon-static-light);
    --app-shadow-color-light: transparent;
    --app-shadow-strong-light: transparent;
    --app-error-text-light: #ff0000;
    --app-link-color-light: var(--galvan-icon-active-light);
    --app-toast-bg-light: rgba(17, 24, 39, 0.92);
    --app-toast-text-light: #F9FAFB;
    --app-user-msg-bg-light: var(--galvan-user-msg-bg-light);
    --app-bot-msg-bg-light: var(--galvan-bot-msg-bg-light);
    --app-suggestions-bg-light: rgba(248, 249, 252, 0.3);
    --app-command-bar-bg-light: rgba(255, 255, 255, 0.78);
    --app-chat-blur-bg-light: rgba(240, 244, 248, 0.6);
    --app-like-color-light: #10B981;
    --app-dislike-color-light: #EF4444;
    --app-logo-stop-1-light: var(--galvan-logo-stop-1-light);
    --app-logo-stop-2-light: var(--galvan-logo-stop-2-light);
    --app-logo-stop-3-light: var(--galvan-logo-stop-3-light);
    --app-logo-glow-color-light: var(--galvan-logo-glow-color-light);
    --app-switch-bg-light: #ffffff;
    --app-switch-thumb-light: #ffffff;
    --app-greeting-grad-light: var(--galvan-greeting-grad-light);
    --app-body-bg-dark: var(--galvan-body-bg-dark);
    --app-bg-primary-dark: var(--galvan-bg-primary-dark);
    --app-bg-secondary-dark: var(--galvan-bg-secondary-dark);
    --app-bg-tertiary-dark: var(--galvan-bg-tertiary-dark);
    --app-text-primary-dark: var(--galvan-text-primary-dark);
    --app-text-secondary-dark: var(--galvan-text-secondary-dark);
    --app-text-placeholder-dark: var(--galvan-text-placeholder-dark);
    --app-border-color-dark: var(--galvan-border-color-dark);
    --app-icon-primary-dark: var(--galvan-icon-primary-dark);
    --app-icon-active-dark: var(--galvan-icon-active-dark);
    --app-icon-static-dark: var(--galvan-icon-static-dark);
    --app-shadow-color-dark: transparent;
    --app-shadow-strong-dark: transparent;
    --app-error-text-dark: #ff0000;
    --app-link-color-dark: #93C5FD;
    --app-toast-bg-dark: rgba(249, 250, 251, 0.92);
    --app-toast-text-dark: #1F2937;
    --app-user-msg-bg-dark: var(--galvan-user-msg-bg-dark);
    --app-bot-msg-bg-dark: var(--galvan-bot-msg-bg-dark);
    --app-suggestions-bg-dark: rgba(31, 41, 55, 0.05);
    --app-command-bar-bg-dark: rgba(17, 24, 39, 0.8);
    --app-chat-blur-bg-dark: rgba(31, 41, 55, 0.65);
    --app-like-color-dark: #34D399;
    --app-dislike-color-dark: #F87171;
    --app-logo-blur-grad-dark: var(--galvan-logo-blur-grad-dark);
    --app-logo-stop-1-dark: var(--galvan-logo-stop-1-dark);
    --app-logo-stop-2-dark: var(--galvan-logo-stop-2-dark);
    --app-logo-stop-3-dark: var(--galvan-logo-stop-3-dark);
    --app-logo-glow-color-dark: var(--galvan-logo-glow-color-dark);
    --app-switch-bg-dark: #ffffff;
    --app-switch-thumb-dark: #ffffff;
    --app-wave-color-dark: var(--galvan-wave-color-dark);
    --app-greeting-grad-dark: var(--galvan-greeting-grad-dark);
    --app-font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --app-font-size: 16px;
    --current-internal-animated-grad: linear-gradient(120deg, rgba(173, 216, 230, 0.55), rgba(144, 238, 144, 0.55), rgba(255, 255, 224, 0.6), rgba(255, 192, 203, 0.55), rgba(173, 216, 230, 0.55));
    --logo-rotate-speed: 1s;
    --logo-blur-rotate-speed: 10s;
    --logo-blur-rotate-speed-inner: 14s;
    --typing-speed: 15ms;
    --logo-transition-speed: 1.3s;
    --welcome-fade-speed: 0.4s;
    --chat-bg-rotate-speed: 25s;
    --internal-gradient-anim-speed: 8s;
    --message-fade-out-duration: 0.3s;
    --message-regen-out-duration: 0.4s;
    --toggle-width: 48px;
    --toggle-height: 28px;
    --handle-size: 20px;
    --handle-padding: 4px;
    --handle-color: #ffffff2e;
    --animation-duration: 0.5s;
    --animation-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1);
    --glass-surface: rgba(255, 255, 255, 0.04);
    --glass-border: rgba(255, 255, 255, 0.08);
    --glass-highlight: rgba(255, 255, 255, 0.15);
    --crystal-surface: rgba(255, 255, 255, 0.03);
    --crystal-highlight: rgba(255, 255, 255, 0.08);
    --c1: rgba(0, 60, 255, 0.1);
    --c2: rgba(0, 60, 255, 0.05);
    --c3: rgba(255, 255, 255, 0.02);
    --c4: rgba(255, 255, 255, 0.01);
    --bts: rgba(0, 0, 0, 0.1);
    --lock-hub-size: 52px;
    --aurora-gradient: conic-gradient(from 180deg, #FF0080, #7928CA, #FF0080);
    --blue-gradient: conic-gradient(from 180deg, #4facfe 0%, #00f2fe 100%);
    --liquid-blur: blur(10px) saturate(120%);
    --incognito-accent: #8b5cf6;
    --incognito-dark-bg: #110e1b;
    --incognito-light-bg: #ffffff;
    --qa-motion: cubic-bezier(0.16, 1, 0.3, 1);
    --qa-snap: cubic-bezier(0.32, 0.72, 0, 1);
}

body.light-mode {
    --current-body-bg: var(--app-body-bg-light);
    --current-bg-primary: var(--app-bg-primary-light);
    --current-bg-secondary: var(--app-bg-secondary-light);
    --current-bg-tertiary: var(--app-bg-tertiary-light);
    --current-text-primary: var(--app-text-primary-light);
    --current-text-secondary: var(--app-text-secondary-light);
    --current-text-placeholder: var(--app-text-placeholder-light);
    --current-border-color: var(--app-border-color-light);
    --current-icon-primary: var(--app-icon-primary-light);
    --current-icon-active: var(--app-icon-active-light);
    --current-icon-static: var(--app-icon-static-light);
    --current-shadow-color: var(--app-shadow-color-light);
    --current-shadow-strong: var(--app-shadow-strong-light);
    --current-error-text: var(--app-error-text-light);
    --current-link-color: var(--app-link-color-light);
    --current-toast-bg: var(--app-toast-bg-light);
    --current-toast-text: var(--app-toast-text-light);
    --current-user-msg-bg: var(--app-user-msg-bg-light);
    --current-bot-msg-bg: var(--app-bot-msg-bg-light);
    --current-suggestions-bg: var(--app-suggestions-bg-light);
    --current-command-bar-bg: var(--app-command-bar-bg-light);
    --current-chat-blur-bg: var(--app-chat-blur-bg-light);
    --current-like-color: var(--app-like-color-light);
    --current-dislike-color: var(--app-dislike-color-light);
    --current-logo-blur-grad: var(--app-logo-blur-grad-light);
    --current-logo-stop-1: var(--app-logo-stop-1-light);
    --current-logo-stop-2: var(--app-logo-stop-2-light);
    --current-logo-stop-3: var(--app-logo-stop-3-light);
    --current-logo-glow-color: var(--app-logo-glow-color-light);
    --current-switch-bg: var(--app-switch-bg-light);
    --current-switch-bg-active: var(--app-icon-active-light);
    --current-switch-thumb: var(--app-switch-thumb-light);
    --current-settings-select-bg: var(--app-bg-tertiary-light);
    --current-action-active-bg: color-mix(in srgb, var(--app-icon-active-light) 10%, transparent);
    --current-prompt-focus-shadow: transparent;
    --current-prompt-border-color: var(--app-border-color-light);
    --current-wave-color: var(--app-wave-color-light); 
    --current-greeting-grad: var(--app-greeting-grad-light);
    --current-suggestion-swipe-send-bg: var(--app-like-color-light);
    --current-suggestion-swipe-delete-bg: var(--app-dislike-color-light);
    --current-suggestion-grad-idle: linear-gradient(135deg, var(--app-bg-primary-light), color-mix(in srgb, var(--app-bg-secondary-light) 80%, var(--app-bg-primary-light)));
    --current-suggestion-grad-active: linear-gradient(135deg, color-mix(in srgb, #0078ff 5%, #035759), color-mix(in srgb, var(--app-icon-active-light) 15%, var(--app-bg-secondary-light)));
    --current-background-main-blur-amount-actual: var(--galvan-background-main-blur-amount); 
    --current-font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: #f0f7ff !important;
    background-image: linear-gradient(45deg, rgba(59, 130, 246, 0.06) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.06) 75%), linear-gradient(-45deg, rgba(59, 130, 246, 0.06) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.06) 75%), linear-gradient(45deg, transparent 40%, rgba(37, 99, 235, 0.08) 40%, rgba(37, 99, 235, 0.08) 60%, transparent 60%), linear-gradient(-45deg, transparent 40%, rgba(37, 99, 235, 0.08) 40%, rgba(37, 99, 235, 0.08) 60%, transparent 60%), radial-gradient(circle at 50% 50%, #ffffff 0%, #dbeafe 100%) !important;
    background-size: 60px 60px, 60px 60px, 120px 120px, 120px 120px, 100% 100% !important;
    background-position: 0 0, 30px 30px, 0 0, 60px 60px, 0 0 !important;
    background-attachment: fixed !important;
}

body:not(.light-mode) {
    --current-body-bg: #0d0d1a;
    --current-bg-primary: var(--app-bg-primary-dark);
    --current-bg-secondary: var(--app-bg-secondary-dark);
    --current-bg-tertiary: var(--app-bg-tertiary-dark);
    --current-text-primary: var(--app-text-primary-dark);
    --current-text-secondary: var(--app-text-secondary-dark);
    --current-text-placeholder: var(--app-text-placeholder-dark);
    --current-border-color: var(--app-border-color-dark);
    --current-icon-primary: var(--app-icon-primary-dark);
    --current-icon-active: var(--app-icon-active-dark);
    --current-icon-static: var(--app-icon-static-dark);
    --current-shadow-color: transparent;
    --current-shadow-strong: transparent;
    --current-error-text: var(--app-error-text-dark);
    --current-link-color: var(--app-link-color-dark);
    --current-toast-bg: var(--app-toast-bg-dark);
    --current-toast-text: var(--app-toast-text-dark);
    --current-user-msg-bg: var(--app-user-msg-bg-dark);
    --current-bot-msg-bg: var(--app-bot-msg-bg-dark);
    --current-suggestions-bg: var(--app-suggestions-bg-dark);
    --current-command-bar-bg: var(--app-command-bar-bg-dark);
    --current-chat-blur-bg: var(--app-chat-blur-bg-dark);
    --current-background-main-blur-amount-actual: var(--galvan-background-main-blur-amount-dark-override);
    --current-like-color: var(--app-like-color-dark);
    --current-dislike-color: var(--app-dislike-color-dark);
    --current-logo-blur-grad: var(--app-logo-blur-grad-dark);
    --current-logo-stop-1: var(--app-logo-stop-1-dark);
    --current-logo-stop-2: var(--app-logo-stop-2-dark);
    --current-logo-stop-3: var(--app-logo-stop-3-dark);
    --current-logo-glow-color: var(--app-logo-glow-color-dark);
    --current-switch-bg: var(--app-switch-bg-dark);
    --current-switch-bg-active: var(--app-icon-active-dark);
    --current-switch-thumb: var(--app-switch-thumb-dark);
    --current-settings-select-bg: var(--app-bg-tertiary-dark);
    --current-action-active-bg: color-mix(in srgb, var(--app-icon-active-dark) 10%, transparent);
    --current-prompt-focus-shadow: transparent;
    --current-prompt-border-color: var(--app-border-color-dark);
    --current-wave-color: var(--app-wave-color-dark);
    --current-greeting-grad: var(--app-greeting-grad-dark);
    --current-suggestion-swipe-send-bg: var(--app-like-color-dark);
    --current-suggestion-swipe-delete-bg: var(--app-dislike-color-dark);
    --current-suggestion-grad-idle: linear-gradient(135deg, var(--app-bg-primary-dark), color-mix(in srgb, var(--app-bg-secondary-dark) 80%, var(--app-bg-primary-dark)));
    --current-suggestion-grad-active: linear-gradient(135deg, color-mix(in srgb, #0078ff 5%, #035759), color-mix(in srgb, var(--app-icon-active-dark) 15%, var(--app-bg-secondary-dark)));
    --current-font-family: var(--app-font-family);
    position: relative;
    z-index: 0;
    background-color: #02040a !important;
    background-image: linear-gradient(45deg, rgba(59, 130, 246, 0.08) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.08) 75%), linear-gradient(-45deg, rgba(59, 130, 246, 0.08) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.08) 75%), linear-gradient(45deg, transparent 40%, rgba(37, 99, 235, 0.1) 40%, rgba(37, 99, 235, 0.1) 60%, transparent 60%), linear-gradient(-45deg, transparent 40%, rgba(37, 99, 235, 0.1) 40%, rgba(37, 99, 235, 0.1) 60%, transparent 60%), radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%) !important;
    background-size: 60px 60px, 60px 60px, 120px 120px, 120px 120px, 100% 100% !important;
    background-position: 0 0, 30px 30px, 0 0, 60px 60px, 0 0 !important;
    background-attachment: fixed !important;
}

input, textarea, button, select { font-family: inherit; }
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; font-size: 16px; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; scroll-behavior: smooth; }
html.lenis { height: auto; }
.lenis.lenis-smooth { scroll-behavior: auto; }
.lenis.lenis-smooth [data-lenis-prevent] { overscroll-behavior: contain; }
.lenis.lenis-stopped { overflow: hidden; }
.lenis.lenis-scrolling iframe { pointer-events: none; }

body {
    height: 100%;
    overscroll-behavior-y: contain;
    font-family: var(--current-font-family);
    font-size: 16px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    color: var(--current-text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    background-color: var(--current-body-bg);
    overflow: auto !important;
    -webkit-overflow-scrolling: auto;
    position: relative;
    width: 100%;
    min-height: 100vh;
    isolation: isolate;
}

body::before {
    content: "";
    position: fixed;
    inset: 0;
    z-index: -1;
    background-size: 20px 20px;
    filter: blur(0.5px);
    pointer-events: none;
}

body:not(.light-mode)::before {
    background-image: repeating-linear-gradient(45deg, rgba(96, 165, 250, 0.05) 0px, rgba(96, 165, 250, 0.05) 1px, transparent 1px, transparent 10px), repeating-linear-gradient(-45deg, rgba(96, 165, 250, 0.05) 0px, rgba(96, 165, 250, 0.05) 1px, transparent 1px, transparent 10px);
}

body.light-mode::before {
    background-image: repeating-linear-gradient(45deg, rgba(30, 64, 175, 0.03) 0px, rgba(30, 64, 175, 0.03) 1px, transparent 1px, transparent 10px), repeating-linear-gradient(-45deg, rgba(30, 64, 175, 0.03) 0px, rgba(30, 64, 175, 0.03) 1px, transparent 1px, transparent 10px);
}

ion-icon { font-size: 28px; }
::-webkit-scrollbar { width: 10px; background: transparent; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.2); border-radius: 20px; height: 10px; border: 3px solid transparent; background-clip: content-box; }
::-webkit-scrollbar-thumb:hover { background: rgba(150, 150, 150, 0.4); border: 3px solid transparent; background-clip: content-box; }

#app, .app-root, .galvan-app { height: 100%; display: flex; flex-direction: column; }
.main-content { flex: 1; min-height: 0; display: flex; }

.galvan-app-blocker {
    position: fixed; inset: 0; z-index: 10001; background: transparent; pointer-events: auto; touch-action: none; display: none; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.5s ease;
}
.galvan-app-blocker.active { display: block; opacity: 1; pointer-events: all; }

body.app-locked { overflow: hidden !important; touch-action: none !important; position: fixed; width: 100%; }
body.app-locked .galvan-container, body.app-locked .galvan-top-nav-island, body.app-locked .galvan-prompt-form, body.app-locked .galvan-notification-hub, body.app-locked #galvan-customize-hub { filter: blur(20px) !important; pointer-events: none !important; user-select: none !important; transition: filter 0.4s ease; }

.galvan-lock-hub {
    position: fixed; top: calc(var(--safe-top, 0px) + 12px); left: 16px; z-index: 10002; width: var(--lock-hub-size); height: var(--lock-hub-size); border-radius: 50%; background: var(--current-bot-msg-bg); backdrop-filter: blur(5px); border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.12)); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); transform-origin: top left; transition: width 0.6s var(--ease-squish), height 0.6s var(--ease-squish), border-radius 0.6s var(--ease-squish), background-color 0.4s ease, transform 0.5s var(--ease-expo-out), box-shadow 0.4s ease; will-change: width, height, transform, border-radius; cursor: pointer; animation: lockHubSlideUp 0.8s var(--ease-expo-out) backwards; background-clip: padding-box !important; -webkit-background-clip: padding-box !important; -webkit-transform: translate3d(0, 0, 0); backface-visibility: hidden; filter: none !important; pointer-events: auto !important; touch-action: auto !important;
}
body.light-mode .galvan-lock-hub { background: var(--current-bot-msg-bg); border-color: rgba(0, 0, 0, 0.1); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); }
.galvan-lock-hub:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
.galvan-lock-hub:active { transform: scale(0.94); }
.galvan-lock-hub.expanded { width: 320px; height: 680px; max-height: 85vh; border-radius: 36px; cursor: default; transform: scale(1); box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.3); overflow: hidden !important; display: flex; flex-direction: column; }

.lock-icon-layer { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; transition: opacity 0.3s ease, transform 0.5s var(--ease-squish); pointer-events: none; }
.lock-main-icon { font-size: 24px; color: var(--current-text-primary); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); transition: color 0.3s ease; }
.lock-pulse-ring { position: absolute; inset: 0; border-radius: 50%; opacity: 0; }
body.app-locked .lock-pulse-ring { animation: lockPulse 2s infinite; }
.galvan-lock-hub.expanded .lock-icon-layer { opacity: 0; transform: scale(0.4) rotate(-45deg); }

.lock-content-layer { position: absolute; inset: 0; padding: 24px; display: flex; flex-direction: column; opacity: 0; pointer-events: none; overflow-y: auto; }
.galvan-lock-hub.expanded .lock-content-layer { position: relative; flex: 1; overflow-y: auto !important; overflow-x: hidden; padding: 24px; -webkit-overflow-scrolling: touch; opacity: 1 !important; pointer-events: auto; transition: opacity 0.4s ease 0.2s; }
.galvan-lock-hub.expanded .lock-content-layer>* { animation: contentStagger 0.6s var(--ease-expo-out) forwards; opacity: 0; }
.galvan-lock-hub.expanded .lock-header-section { animation-delay: 0.15s; opacity: 0; transform: translateY(20px) scale(0.98); animation: glassSlideUp 0.8s cubic-bezier(0.19, 1, 0.22, 1) forwards 0.1s; will-change: transform, opacity; backface-visibility: hidden; background: var(--current-bot-msg-bg); --liquid-blur: blur(0px); }
.galvan-lock-hub.expanded .lock-header-section>* { opacity: 0; filter: blur(12px); transform: translateY(10px); animation: contentFogReveal 0.8s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
.galvan-lock-hub.expanded .lock-header-section .lock-status-icon-wrapper { animation-delay: 0.2s; }
.galvan-lock-hub.expanded .lock-header-section .lock-text-stack { animation-delay: 0.25s; }
.galvan-lock-hub.expanded .lock-header-section #lock-close-btn { animation-delay: 0.3s; }
.galvan-lock-hub.expanded .pin-interface-wrapper { animation-delay: 0.3s; opacity: 0; filter: blur(5px); transform: translateY(20px); animation: contentFogReveal 0.9s cubic-bezier(0.19, 1, 0.22, 1) forwards 0.3s; }

.lock-internal-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; animation: fadeIn 0.5s ease; }
.reset-spinner-container { position: relative; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; }
.reset-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: var(--current-icon-active); animation: spinRing 1s linear infinite; }
.reset-shield-icon { font-size: 32px; color: var(--current-text-primary); animation: pulseIcon 1.5s ease-in-out infinite; z-index: 2; }
.reset-ripple { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(90deg, #0046f6, #001297); opacity: 0.2; animation: rippleEffect 2s infinite; }

.lock-header-section { display: flex; flex-direction: column; align-items: center; padding: 20px; text-align: center; margin: 15px; position: sticky; top: -5px; z-index: 2; background: var(--current-bot-msg-bg); border-radius: 20px; }
.lock-status-icon-wrapper { width: 64px; height: 64px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 32px; color: var(--current-icon-active); box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); }
body.light-mode .lock-status-icon-wrapper { background: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.08); }
.lock-text-stack h3 { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--current-text-primary); letter-spacing: -0.02em; }
.lock-text-stack span { font-size: 0.9rem; color: var(--current-text-secondary); opacity: 0.7; }
#lock-close-btn { position: absolute; top: -10px; right: -10px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
body.light-mode #lock-close-btn { background: rgba(0, 0, 0, 0.05); color: #000; }

.pin-dots-container { display: flex; justify-content: center; gap: 24px; margin-bottom: 36px; height: 20px; align-items: center; }
.pin-dot { width: 16px; height: 16px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); transform: scale(1); transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: none; }
body.light-mode .pin-dot { border-color: rgba(0, 0, 0, 0.673); background: rgba(0, 0, 0, 0.436); }
.pin-dot.filled { border-color: transparent; background: var(--current-icon-active); opacity: 1; transform: scale(1.2); box-shadow: 0 2px 12px var(--current-prompt-focus-shadow); animation: dotFillSpring 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
.pin-dot.error { background: var(--current-dislike-color); border-color: var(--current-dislike-color); transform: scale(1); animation: shakeError 0.3s ease-in-out; }

.pin-numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; width: 100%; max-width: 280px; margin: 0 auto; }
.pin-key { aspect-ratio: 1; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.03); color: var(--current-text-primary); font-size: 1.7rem; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, sans-serif; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease; position: relative; overflow: hidden; }
body.light-mode .pin-key { background: rgba(0, 0, 0, 0.03); border-color: rgba(0, 0, 0, 0.08); color: #000; }
.pin-key:active { transform: scale(0.9); background: var(--current-text-primary) !important; color: var(--current-body-bg) !important; border-color: transparent !important; transition: transform 0.1s cubic-bezier(0.25, 1, 0.5, 1), background 0s; }
@media(hover: hover) { .pin-key:hover { background: rgba(255, 255, 255, 0.12); } body.light-mode .pin-key:hover { background: rgba(0, 0, 0, 0.08); } }
.pin-key.action { background: transparent !important; border-color: transparent !important; font-size: 1.8rem; box-shadow: none !important; }
.pin-key.action.delete { color: var(--current-dislike-color); }
.pin-key.action.confirm { color: var(--current-like-color); }

.lock-text-link { display: block; margin-top: 24px; background: none; border: none; color: var(--current-text-secondary); font-size: 0.85rem; font-weight: 500; text-decoration: none; opacity: 0.6; cursor: pointer; width: 100%; text-align: center; }
.lock-text-link:hover { opacity: 1; text-decoration: underline; }
.biometric-toggle-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; max-width: 200px; margin: 20px auto 0 auto; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 100px; color: var(--current-icon-active); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); backdrop-filter: blur(5px); }
body.light-mode .biometric-toggle-btn { background: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.1); }
.biometric-toggle-btn:hover { transform: scale(1.05); background: var(--current-icon-active); color: #fff; border-color: transparent; box-shadow: 0 4px 15px var(--current-prompt-focus-shadow); }
.biometric-toggle-btn ion-icon { font-size: 1.4rem; }

.galvan-container { width: 80%; max-width: 90%; height: 100%; background: none; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 1; transition: background-color 0.5s var(--ease-smoother); padding-top: var(--safe-top); box-shadow: none; border-radius: 0; }
.galvan-container.locked { pointer-events: none; }
body:not(.app-ready) .galvan-container { opacity: 0; }
#galvan-boot-screen { position: fixed;inset: 0;z-index: 999999 !important;display: flex;flex-direction: column;justify-content: center;align-items: center;gap: 40px;overflow: hidden;transition:opacity 0.6s cubic-bezier(0.33, 1, 0.68, 1),transform 0.8s cubic-bezier(0.33, 1, 0.68, 1),visibility 0.6s linear !important;opacity: 1;visibility: visible;}
body.app-ready #galvan-boot-screen { opacity: 0; visibility: hidden; pointer-events: none; }

#galvan-boot-screen::before {content: '';position: absolute;inset: -20px;z-index: -1;filter: blur(5px);background-color: #02040a !important;background-image:linear-gradient(45deg, rgba(59, 130, 246, 0.08) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.08) 75%),linear-gradient(-45deg, rgba(59, 130, 246, 0.08) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.08) 75%),linear-gradient(45deg, transparent 40%, rgba(37, 99, 235, 0.1) 40%, rgba(37, 99, 235, 0.1) 60%, transparent 60%),linear-gradient(-45deg, transparent 40%, rgba(37, 99, 235, 0.1) 40%, rgba(37, 99, 235, 0.1) 60%, transparent 60%),radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%) !important;background-size: 60px 60px, 60px 60px, 120px 120px, 120px 120px, 100% 100% !important;background-position: 0 0, 30px 30px, 0 0, 60px 60px, 0 0 !important;}

body.light-mode #galvan-boot-screen::before {background-color: #f0f7ff !important;background-image:linear-gradient(45deg, rgba(59, 130, 246, 0.06) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.06) 75%),linear-gradient(-45deg, rgba(59, 130, 246, 0.06) 25%, transparent 25%, transparent 75%, rgba(59, 130, 246, 0.06) 75%),linear-gradient(45deg, transparent 40%, rgba(37, 99, 235, 0.08) 40%, rgba(37, 99, 235, 0.08) 60%, transparent 60%),linear-gradient(-45deg, transparent 40%, rgba(37, 99, 235, 0.08) 40%, rgba(37, 99, 235, 0.08) 60%, transparent 60%),radial-gradient(circle at 50% 50%, #ffffff 0%, #dbeafe 100%) !important;}
#galvan-boot-screen.boot-complete {opacity: 0 !important;visibility: hidden !important;pointer-events: none !important;transform: scale(1.1);}
.boot-content { display: flex; flex-direction: column; align-items: center; gap: 32px; transform: scale(1); transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }
body.app-ready .boot-content { transform: scale(1.15); }
.boot-title { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro", sans-serif; font-size: 3rem; font-weight: 700; letter-spacing: -0.02em; margin: 0; color: var(--current-text-primary); background: linear-gradient(120deg, var(--current-text-primary), var(--current-text-secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; opacity: 0; -webkit-mask-image: linear-gradient(-75deg, rgba(0, 0, 0, 1) 40%, rgba(0, 0, 0, 0) 60%); mask-image: linear-gradient(-75deg, rgba(0, 0, 0, 1) 40%, rgba(0, 0, 0, 0) 60%); -webkit-mask-size: 250%; mask-size: 250%; -webkit-mask-position: 130%; mask-position: 130%; animation: appleWriteReveal 2.5s cubic-bezier(0.19, 1, 0.22, 1) 0.3s forwards; will-change: mask-position, -webkit-mask-position; }
.boot-status { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; font-size: 0.8rem; font-weight: 600; color: var(--current-text-secondary); letter-spacing: 0.04em; text-transform: uppercase; opacity: 0; animation: statusFadeIn 1s ease 1.5s forwards; }
.boot-spinner { width: 36px; height: 36px; color: var(--current-text-primary); filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3)); opacity: 0; animation: spinnerFloatIn 0.8s ease 0.1s forwards, iosSpinnerSpin 1s steps(12) infinite; }

.galvan-chat-background-blur, .galvan-user-image-background-blur { content: none !important; display: none !important; background: none !important; }
.galvan-welcome-spinner { display: block; width: 42px; height: 42px; margin: 0 auto 32px auto; color: var(--current-icon-active); animation: iosSpinnerSpin 1s steps(12) infinite; will-change: transform; }
.galvan-welcome-spinner line { stroke: currentColor; stroke-width: 4.5; stroke-linecap: round; }
.galvan-welcome-spinner line:nth-child(1) { opacity: 1; } .galvan-welcome-spinner line:nth-child(2) { opacity: 0.85; } .galvan-welcome-spinner line:nth-child(3) { opacity: 0.7; } .galvan-welcome-spinner line:nth-child(4) { opacity: 0.55; } .galvan-welcome-spinner line:nth-child(5) { opacity: 0.4; } .galvan-welcome-spinner line:nth-child(6) { opacity: 0.25; } .galvan-welcome-spinner line:nth-child(7) { opacity: 0.1; } .galvan-welcome-spinner line:nth-child(8) { opacity: 0.1; } .galvan-welcome-spinner line:nth-child(9) { opacity: 0.1; } .galvan-welcome-spinner line:nth-child(10) { opacity: 0.1; } .galvan-welcome-spinner line:nth-child(11) { opacity: 0.1; } .galvan-welcome-spinner line:nth-child(12) { opacity: 0.1; }

.galvan-top-nav-island {
    position: fixed; top: calc(var(--safe-top) + 16px); left: 50%; transform: translateX(-50%); z-index: 900; display: flex; padding: 4px; gap: 0; background: var(--current-bot-msg-bg); --fx-filter: blur(4px) liquid-glass(2, 10) saturate(1.25); border-radius: 100px; width: auto; min-width: 200px; height: 48px; opacity: 0; transition: opacity 0.5s ease, transform 0.6s var(--apple-spring), background-color 0.3s ease; background-clip: padding-box !important; -webkit-background-clip: padding-box !important; transform: translate3d(-50%, 0, 0); backface-visibility: hidden; -webkit-backface-visibility: hidden; perspective: 1000px; outline: 1px solid transparent; --liquid-blur: blur(1px) saturate(180%);
}
body.app-ready .galvan-top-nav-island, body.app-loaded .galvan-top-nav-island { opacity: 1; transform: translate3d(-50%, 0, 0); }

.nav-island-backdrop { position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 100px; z-index: 1; transition: transform 0.5s var(--apple-spring), width 0.5s var(--apple-spring), background-color 0.3s ease; transform: translate3d(0, 0, 0); transform-origin: center center; will-change: transform; }
.galvan-top-nav-island[data-active="chats"] .nav-island-backdrop { transform: translate3d(100%, 0, 0); }
.galvan-top-nav-island[data-active="home"] .nav-island-backdrop { transform: translate3d(0, 0, 0); }

.nav-island-btn { flex: 1; position: relative; background: transparent; border: none; cursor: pointer; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; font-size: 0.9rem; font-weight: 600; letter-spacing: -0.01em; color: rgba(255, 255, 255, 0.5); display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 2; transition: color 0.3s ease; outline: none; white-space: nowrap; }
.nav-island-btn.active { color: #ffffff; text-shadow: none; }
.nav-island-btn ion-icon { font-size: 1.15rem; transition: transform 0.4s var(--apple-spring), color 0.3s ease; transform: scale(1); color: currentColor; }
.nav-island-btn.active ion-icon { transform: scale(1.15); color: #fff; }
body.light-mode .nav-island-backdrop { background: #ffffff; border: 0.5px solid rgba(0, 0, 0, 0.04); }
body.light-mode .nav-island-btn { color: rgba(0, 0, 0, 0.5); }
body.light-mode .nav-island-btn.active { color: #000000; }
body.light-mode .nav-island-btn.active ion-icon { color: #000000; filter: none; }

.galvan-welcome-screen { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-bottom: 120px; z-index: 1; pointer-events: none; }
.galvan-user-greeting { font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 40px; background: var(--current-greeting-grad); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; pointer-events: auto; }
.galvan-suggestions-wrapper { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 30px; z-index: 10; pointer-events: none; transition: none; }
body:not(.chats-active):not(.hide-suggestions) .galvan-suggestions-wrapper { pointer-events: auto; }

.galvan-premium-grid { width: 100%; max-width: 700px; padding: 10px 20px; display: grid; gap: 16px; }
.premium-card { position: relative; height: 85px; width: 100%; background: var(--current-bot-msg-bg) !important; --fx-filter: blur(4px) liquid-glass(2, 10) saturate(1.25); display: flex; border-radius: 100px; align-items: center; padding: 0 24px; gap: 18px; cursor: pointer; user-select: none; transform: translateZ(0); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; isolation: isolate; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s ease, border-color 0.3s ease; opacity: 0; visibility: hidden; }
body.light-mode .premium-card { background:var(--current-bot-msg-bg) !important; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05); }
body:not(.chats-active):not(.hide-suggestions) .premium-card { animation: cardGlassReveal 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; visibility: visible; }
body.chats-active .premium-card { animation: cardGlassHide 0.3s ease-in forwards; }
.premium-card:hover { transform: scale(1.02) translateZ(0); background: rgba(50, 50, 70, 0.6) !important; z-index: 10; }
.premium-card:active { transform: scale(0.97) translateZ(0); transition-duration: 0.1s; }
.galvan-premium-grid .premium-card { animation: none !important; opacity: 1 !important; transform: none !important; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), border-color 0.3s ease, background-color 0.3s ease !important; }

.premium-icon-box { width: 48px; height: 48px; border-radius: 100px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: rgba(255, 255, 255, 0.08); color: var(--card-color, var(--current-icon-active)); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.4s ease, background-color 0.3s ease, color 0.3s ease; }
body.light-mode .premium-icon-box { background: rgba(0, 0, 0, 0.06); }
.premium-card:hover .premium-icon-box { transform: scale(1.15) rotate(-6deg); background: var(--card-color, var(--current-icon-active)); color: #ffffff; }
.premium-text-stack { display: flex; flex-direction: column; justify-content: center; gap: 4px; flex: 1; }
.premium-title { font-size: 1.05rem; font-weight: 700; color: var(--current-text-primary); letter-spacing: -0.01em; }
.premium-subtitle { font-size: 0.85rem; font-weight: 500; color: var(--current-text-secondary); opacity: 0.8; }
.premium-card ion-icon[name="arrow-forward"] { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease; transform: translateX(-15px); opacity: 0; color: var(--current-icon-active); font-size: 20px; }
.premium-card:hover ion-icon[name="arrow-forward"] { transform: translateX(0); opacity: 1; }

.galvan-chats-container {
    position: absolute; inset: 0; background: var(--current-bot-msg-bg); width: 100%; backdrop-filter: blur(10px); margin-top: 100px; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; gap: 32px; padding-left: 16px; margin-bottom: 100px; border-radius: 30px; padding-right: 16px; scroll-behavior: smooth; opacity: 0; transition: opacity 0.6s cubic-bezier(0.23, 1, 0.32, 1) 0.1s, transform 0.6s cubic-bezier(0.23, 1, 0.32, 1) 0.1s, padding-bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2; visibility: hidden; transform: translateY(25px) scale(0.97); will-change: scroll-position, opacity, transform, visibility, padding-bottom; transform: translateZ(0);
}
body.bot-responding .galvan-chats-container { scroll-behavior: auto !important; }
body.chats-active .galvan-chats-container { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
.galvan-chats-container:not(:has(.galvan-message)) { display: none !important; visibility: hidden !important; pointer-events: none; }

.galvan-message { width: 100%; max-width: 720px; display: flex; flex-direction: column; position: relative; animation: iosSlideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(20px); }
.galvan-message-bubble { position: relative; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; font-size: 1.05rem; line-height: 1.6; letter-spacing: -0.015em; color: var(--current-text-primary); background: transparent; box-shadow: none; border: none; backdrop-filter: none; }
.user-message { align-items: flex-end !important; width: 100%; display: flex; flex-direction: column; margin-bottom: 24px; }
.user-message .galvan-message-bubble { background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%) !important; padding: 14px 28px; border-radius: 24px !important; border-bottom-right-radius: 4px !important; margin-top: 10px; color: var(--current-text-primary); font-weight: 500; max-width: 85% !important; min-width: 60px !important; overflow: hidden; text-align: left !important; backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 5px solid rgba(255, 255, 255, 0.1); transform: translateY(0); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); letter-spacing: 0.01em; display: flex !important; flex-direction: column !important; align-items: flex-start !important; gap: 10px !important; box-sizing: border-box; }

.galvan-img-attachment { width: 100%; height: auto; max-height: 400px; object-fit: cover; border-radius: 16px; display: block; margin: 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
.galvan-file-attachment { display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(0, 0, 0, 0.15); border-radius: 14px; width: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); }
body.light-mode .galvan-file-attachment { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0, 0, 0, 0.05); }
.galvan-file-attachment svg.file-icon-svg { width: 28px; height: 28px; flex-shrink: 0; fill: currentColor; opacity: 0.9; }
.galvan-file-attachment p { margin: 0; font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; flex: 1; color: inherit; }

.bot-message { align-items: flex-start; }
.bot-message .galvan-message-bubble { width: 100%; text-align: left; max-width: 85%; }
.galvan-message.is-editing .galvan-message-bubble { padding: 0 30px !important; height: 54px !important; max-width: 500px !important; min-width: 120px; display: flex !important; align-items: center !important; justify-content: center !important; line-height: 1 !important; border-radius: 100px !important; outline: 2px dashed var(--current-icon-active); outline-offset: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1); transform: scale(0.97); }
.galvan-message.is-editing .galvan-action-dock { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.galvan-action-dock { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; opacity: 0; transform: translateY(-5px); transition: all 0.4s ease; pointer-events: none; }
.galvan-message:hover .galvan-action-dock, .bot-message.loading .galvan-action-dock { opacity: 1; transform: translateY(0); pointer-events: auto; }
@media (hover: none) { .galvan-action-dock { opacity: 1; transform: translateY(0); pointer-events: auto; } }

.bot-message.loading .galvan-message-bubble { display: flex; align-items: center; gap: 12px; font-weight: 600; color: var(--current-text-secondary); background: var(--current-bot-msg-bg); padding: 12px 24px; border-radius: 100px; width: fit-content; border: 1px solid rgba(255, 255, 255, 0.1); }
.fast-btn-anim { background: #007AFF; color: white; border: none; border-radius: 100px; padding: 6px 14px; font-size: 0.75rem; font-weight: 800; letter-spacing: 0.05em; margin-left: 12px; opacity: 0; transform: scale(0.5); animation: springPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); cursor: pointer; }
.galvan-message-text { opacity: 1; }
.galvan-message-text p { margin-bottom: 0.8em; }
.galvan-message-text strong { color: var(--current-text-primary); font-weight: 700; }
.galvan-response-action-button { background: var(--current-bot-msg-bg); border: none; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--current-icon-primary); cursor: pointer; transform-origin: center; transition: transform 0.3s var(--ease-spring-gentle), color 0.4s var(--ease-out-quint); will-change: transform, color, filter; }

.ios-action-btn { position: relative; background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 14px; padding: 8px 16px; display: flex; align-items: center; gap: 8px; color: var(--current-text-secondary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); animation: buttonIdlePulse 4s ease-in-out infinite; }
.ios-action-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--current-text-primary); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); }
.ios-action-btn:active { transform: scale(0.95); }
.ios-action-btn ion-icon { font-size: 1.1em; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
.ios-action-btn.success { background: var(--current-like-color); color: #fff; border-color: transparent; animation: none; }

.galvan-code-wrapper { margin: 16px 0; background: #1e1e24; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 18px; overflow: hidden; box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3); }
.galvan-code-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.galvan-code-lang { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: rgba(255, 255, 255, 0.5); letter-spacing: 0.05em; }
.galvan-code-actions { display: flex; gap: 8px; }
.galvan-code-btn { background: rgba(225, 225, 225, 0.1); border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; padding: 10px; border-radius: 100px; display: flex; align-items: center; gap: 6px; transition: all 0.3s ease; font-size: 0.8rem; position: relative; overflow: hidden; }
.galvan-code-btn span { font-weight: 500; }
.galvan-code-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
.galvan-code-btn ion-icon { font-size: 1.1rem; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease; }
.galvan-code-btn.success { color: var(--current-like-color); background: rgba(16, 185, 129, 0.1); }
.galvan-code-btn.success ion-icon { transform: scale(1.2); }
.galvan-code-wrapper pre { margin: 0; padding: 16px; overflow: auto; max-height: 500px; width: 100%; }
.galvan-code-wrapper code { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; color: #e2e8f0; line-height: 1.6; white-space: pre; display: block; }
.galvan-code-wrapper pre::-webkit-scrollbar { width: 8px; height: 8px; }
.galvan-code-wrapper pre::-webkit-scrollbar-track { background: transparent; }
.galvan-code-wrapper pre::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }
.galvan-code-wrapper pre::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

.galvan-prompt-form { position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding: 0 16px calc(16px + env(safe-area-inset-bottom)) 16px; pointer-events: none; transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); }
.galvan-prompt-container {
    width: 100%; max-width: 400px; background: var(--current-bot-msg-bg); --fx-filter: blur(4px) liquid-glass(2, 10) saturate(1.25); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 32px; box-shadow: none; pointer-events: auto; transition: transform 0.4s var(--ease-smoother), box-shadow 0.4s var(--ease-smoother), border-color 0.4s var(--ease-smoother); position: relative; z-index: 100; transform: translateZ(0); outline: 1px solid transparent; background-clip: padding-box !important; -webkit-background-clip: padding-box !important; -webkit-transform: translate3d(0, 0, 0); backface-visibility: hidden; -webkit-backface-visibility: hidden; perspective: 1000px; overflow: hidden;
}
body.light-mode .galvan-prompt-container { border: 1px solid rgba(0, 0, 0, 0.08); }
.prompt-input::-webkit-scrollbar { display: none; }
.prompt-input::placeholder { color: var(--current-text-secondary); opacity: 0.5; }
.galvan-prompt-wrapper { display: flex; flex-direction: column; padding: 12px 16px 12px 16px; gap: 12px; position: relative; width: 100%; }
.prompt-input-row { width: 100%; }
.prompt-input { width: 100%; min-height: 24px; max-height: 160px; padding: 4px 0; text-align:center; margin: 0; font-size: 16px; line-height: 1.5; background: transparent; border: none; outline: none; color: var(--current-text-primary); resize: none; }
.prompt-controls-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
.controls-left { display: flex; align-items: center; gap: 8px; }
.prompt-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--current-bot-msg-bg); color: var(--current-icon-primary); display: grid; place-items: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); flex-shrink: 0; padding: 0; position: relative; overflow: hidden; }
.prompt-btn:hover { background: rgba(125, 125, 125, 0.08); transform: scale(1.05); }
.prompt-btn ion-icon, .prompt-btn svg { font-size: 22px; pointer-events: none; }
#send-btn { width: 50px; height: 50px; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); color: #ffffff; box-shadow: none; }
#add-file-btn { margin-left: 2px; }
body.light-mode .prompt-btn { background: rgba(0, 0, 0, 0.04); }
body.light-mode .prompt-btn:hover { background: rgba(0, 0, 0, 0.08); }
.prompt-btn:active { transform: scale(0.95); }
#add-file-btn .icon-add, #add-file-btn .icon-cancel-file { position: absolute; inset: 0; display: grid; place-items: center; transition: all 0.3s ease; }
#add-file-btn .icon-cancel-file { opacity: 0; transform: rotate(-90deg) scale(0.5); color: var(--current-dislike-color); }
body.bot-responding #add-file-btn { width: 0; padding: 0; margin: 0; opacity: 0; pointer-events: none; }
body.light-mode #send-btn:not(:disabled) { background: var(--current-icon-active) !important; color: #ffffff !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4) !important; transform: scale(1); opacity: 1; }
body.light-mode #send-btn:not(:disabled):hover { color: var(--current-icon-active) !important; background: rgba(0, 0, 0, 0.05) !important; box-shadow: none !important; }
#send-btn:disabled { background: var(--current-bg-tertiary); color: var(--current-text-secondary); box-shadow: none; opacity: 0.6; cursor: default; transform: none; }
#send-btn:not(:disabled):hover { transform: scale(1.05) translateY(-1px); box-shadow: none; }
#send-btn .icon-container { position: relative; width: 24px; height: 24px; display: grid; place-items: center; }
#send-btn .icon-send, #send-btn .icon-stop { position: absolute; transition: all 0.4s ease; display: flex; }
#send-btn .icon-send { opacity: 1; transform: scale(1) rotate(0deg); }
#send-btn .icon-stop { opacity: 0; transform: scale(0.5) rotate(-90deg); }
#send-btn.stop-active { background: var(--current-dislike-color); box-shadow: none; }
#send-btn.stop-active .icon-send { opacity: 0; transform: scale(0.5) rotate(90deg); }
#send-btn.stop-active .icon-stop { opacity: 1; transform: scale(1) rotate(0deg); }
#send-btn .btn-label-text { display: none; }

.galvan-file-upload-wrapper {
    position: absolute; bottom: 100%; margin-bottom: -24px; padding: 12px 16px 28px; background: var(--current-bot-msg-bg); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.12); border-bottom: none; border-radius: 24px 24px 0 0; display: flex; align-items: center; justify-content: space-between; gap: 12px; z-index: 90; opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.96); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: none; background-clip: padding-box !important; -webkit-background-clip: padding-box !important; -webkit-transform: translate3d(0, 0, 0); backface-visibility: hidden; -webkit-backface-visibility: hidden; perspective: 1000px; overflow: hidden; outline: 1px solid transparent;
}
body:not(.light-mode) .galvan-file-upload-wrapper { border: 1px solid rgba(255, 255, 255, 0.08); border-bottom: none; box-shadow: none; }
.galvan-file-upload-wrapper.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; display: flex; animation: fileTabSlideUp 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
.galvan-file-preview-container { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
.galvan-file-preview-container img.file-preview, .file-preview-icon-svg { width: 28px; height: 28px; border-radius: 6px; object-fit: cover; flex-shrink: 0; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1); }
.file-preview-icon-svg { padding: 5px; fill: var(--current-icon-primary); }
.galvan-file-name { font-size: 0.85rem; font-weight: 600; color: var(--current-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; opacity: 0.9; }
#cancel-file-btn { width: 26px; height: 26px; border-radius: 50%; border: none; background: rgba(255, 59, 48, 0.1); color: var(--current-dislike-color); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s ease; margin-bottom: 2px; padding: 4px; }
#cancel-file-btn:hover { background: var(--current-dislike-color); color: white; transform: scale(1.1); }

.vertical-suggestions-container { position: absolute; bottom: 100%; left: 0; right: 0; display: flex; justify-content: center; align-items: flex-end; padding: 0 16px 20px 16px; pointer-events: none; z-index: 95; visibility: hidden; }
.galvan-prompt-form.suggestions-active .vertical-suggestions-container { pointer-events: auto; visibility: visible; }
.glass-panel-backdrop { position: fixed; inset: 0; backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px); opacity: 0; transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1); z-index: -1; pointer-events: none; }
.galvan-prompt-form.suggestions-active .glass-panel-backdrop { opacity: 1; }
.suggestions-vertical-list { width: 100%; max-width: 400px; max-height: 60vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 22px; border-radius: 28px; background: var(--current-bot-msg-bg); border: 1px solid rgba(255, 255, 255, 0.12); backdrop-filter: blur(5px); opacity: 0; transform: translateY(40px) scale(0.92); transform-origin: bottom center; transition: opacity 0.4s cubic-bezier(0.19, 1, 0.22, 1), transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); scrollbar-width: none; background-clip: padding-box; -webkit-background-clip: padding-box; }
.suggestions-vertical-list::-webkit-scrollbar { display: none; }
.galvan-prompt-form.suggestions-active .suggestions-vertical-list { opacity: 1; transform: translateY(0) scale(1); transition-delay: 0.05s; }
.vertical-suggestion-item { display: grid; grid-template-columns: 48px 1fr 32px; align-items: center; gap: 20px; padding: 12px; border-radius: 100px; background: transparent; border: 1px solid transparent; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.3s ease; position: relative; overflow: visible; min-height: 74px; backface-visibility: hidden; -webkit-backface-visibility: hidden; transform: translateZ(0); transform: scale(1.02) translateZ(0); border-color: rgba(255, 255, 255, 0.1); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); background: var(--current-bot-msg-bg); z-index: 10; }
.vertical-suggestion-item::before { content: ''; position: absolute; inset: 0; border-radius: 100px; background: var(--current-icon-active); opacity: 0; transition: opacity 0.3s ease; z-index: -1; pointer-events: none; }
.sugg-icon-box { width: 48px; height: 48px; border-radius: 50%; background: var(--current-bot-msg-bg); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--current-icon-primary); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.3s ease, background-color 0.3s ease; z-index: 2; border: 1px solid rgba(255, 255, 255, 0.05); flex-shrink: 0; }
.sugg-text-content { display: flex; flex-direction: column; gap: 2px; z-index: 2; justify-content: center; overflow: hidden; }
.sugg-title { font-size: 0.95rem; font-weight: 600; color: var(--current-text-primary); letter-spacing: -0.01em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sugg-desc { font-size: 0.75rem; color: var(--current-text-secondary); opacity: 0.7; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sugg-arrow { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--current-text-secondary); opacity: 0; transform: translateX(-10px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 2; }
@media (hover: hover) {
    .vertical-suggestion-item:hover { transform: scale(1.02) translateZ(0); border-color: rgba(255, 255, 255, 0.1); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); background: var(--current-bot-msg-bg); z-index: 10; }
    .vertical-suggestion-item:hover::before { opacity: 0.04; }
    .vertical-suggestion-item:hover .sugg-icon-box { color: white; transform: rotate(-8deg) scale(1.1); box-shadow: 0 8px 16px -4px var(--current-prompt-focus-shadow); background: var(--current-icon-active); border-color: transparent; }
    .vertical-suggestion-item:hover .sugg-arrow { opacity: 1; transform: translateX(0); color: var(--current-icon-active); }
    body.light-mode .vertical-suggestion-item:hover { border-color: rgba(0, 0, 0, 0.05); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
    body.light-mode .vertical-suggestion-item:hover .sugg-icon-box { color: white !important; background: var(--current-icon-active) !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important; }
    body.light-mode .vertical-suggestion-item:hover .sugg-arrow { color: var(--current-icon-active) !important; opacity: 1; }
}
.vertical-suggestion-item:active { transform: scale(0.97) translateZ(0); transition-duration: 0.1s; }

.galvan-attachment-menu { position: absolute; bottom: 100%; left: 0; right: 0; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding: 0 16px 12px 16px; pointer-events: none; z-index: 95; visibility: hidden; }
.galvan-attachment-list {
    width: 100%; max-width: 400px; --fx-filter: blur(4px) liquid-glass(2, 10) saturate(1.25); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 28px; padding: 12px; display: flex; flex-direction: column; gap: 8px; opacity: 0; transform: translateY(20px) scale(0.95); transform-origin: bottom center; transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1); visibility: hidden;
}
.galvan-prompt-form.attachment-active .galvan-attachment-list { visibility: visible; opacity: 1; transform: translateY(0) scale(1); transition: opacity 0.1s ease-out 0.05s, transform 0.1s ease-out 0.05s; }
body:not(.light-mode) .galvan-attachment-list { border: 1px solid rgba(255, 255, 255, 0.08); }
.galvan-prompt-form.attachment-active .galvan-attachment-menu { visibility: visible; pointer-events: auto; }
.galvan-prompt-form.attachment-active .galvan-attachment-list { opacity: 1; transform: translateY(0) scale(1); }
.attach-option-btn { display: grid; grid-template-columns: 48px 1fr 32px; align-items: center; gap: 12px; padding: 8px; border-radius: 100px; background: transparent; border: 1px solid transparent; cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s ease; width: 100%; text-align: left; position: relative; }
.attach-icon-box { width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--current-icon-primary); transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
.attach-text-content { display: flex; flex-direction: column; justify-content: center; gap: 2px; overflow: hidden; }
.attach-title { font-size: 0.95rem; font-weight: 600; color: var(--current-text-primary); letter-spacing: -0.01em; }
.attach-desc { font-size: 0.75rem; color: var(--current-text-secondary); opacity: 0.7; font-weight: 500; }
.attach-arrow { font-size: 24px; color: var(--current-text-secondary); opacity: 0; transform: translateX(-10px); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
@media (hover: hover) {
    .attach-option-btn:hover { background: var(--current-bot-msg-bg); transform: scale(1.02); border-color: rgba(255, 255, 255, 0.1); z-index: 2; }
    .attach-option-btn:hover .attach-icon-box { background: var(--current-icon-active); color: white; transform: rotate(-8deg) scale(1.1); border-color: transparent; box-shadow: 0 4px 12px var(--current-prompt-focus-shadow); }
    .attach-option-btn:hover .attach-arrow { opacity: 1; transform: translateX(0); color: var(--current-icon-active); }
}
.attach-option-btn:active { transform: scale(0.96); }
.galvan-attachment-backdrop { position: fixed; inset: 0; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); opacity: 0; pointer-events: none; z-index: 94; }
.galvan-prompt-form.attachment-active .galvan-attachment-backdrop { opacity: 1; pointer-events: auto; }

#incognito-btn { position: relative; z-index: 5; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
#incognito-btn.active { background: var(--incognito-accent); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); transform: scale(1.05); }
#incognito-btn.active ion-icon { animation: spyIconSwitch 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
.suggestions-vertical-list::before { content: ''; position: absolute; inset: -3px; z-index: -1; background: linear-gradient(60deg, #0077ff, #27db30, #0051ff, #ff0059); background-size: 300% 300%; animation: incognitoFlow 3s ease infinite; border-radius: 34px; opacity: 0.5; }

.galvan-switch { --w: 58px; --h: 34px; --knob: 20px; --offset: 7px; position: relative; width: var(--w); height: var(--h); display: inline-block; flex-shrink: 0; cursor: pointer; z-index: 1; -webkit-tap-highlight-color: transparent; }
.galvan-switch input { opacity: 0; width: 0; height: 0; position: absolute; pointer-events: none; }
.galvan-switch .slider { position: absolute; inset: 0; background: rgba(120, 120, 128, 0.16); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 100px; transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.15), inset 0 -1px 1px rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.04); }
body.light-mode .galvan-switch .slider { background: rgba(0, 0, 0, 0.06); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.02); }
.galvan-switch input:checked+.slider { background: #32d74b; box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2); }
.galvan-switch .handle { position: absolute; top: var(--offset); left: var(--offset); width: var(--knob); height: var(--knob); border-radius: 50%; background: #ffffff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.1), inset 0 2px 4px rgba(255, 255, 255, 1), inset 0 -2px 3px rgba(0, 0, 0, 0.02); transition: transform 0.6s cubic-bezier(0.3, 1.3, 0.2, 1), width 0.3s ease, left 0.6s cubic-bezier(0.3, 1.3, 0.2, 1); z-index: 2; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); }
.galvan-switch input:checked~.handle { transform: translateX(calc(var(--w) - var(--knob) - (var(--offset) * 2))); box-shadow: -2px 4px 12px rgba(0, 80, 20, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1), inset 0 2px 4px rgba(255, 255, 255, 1); }
.galvan-switch:active .handle { width: calc(var(--knob) + 6px); }
.galvan-switch:active input:checked~.handle { transform: translateX(calc(var(--w) - var(--knob) - (var(--offset) * 2) - 6px)); }
.galvan-switch:hover .handle { transform: scale(1.05); }
.galvan-switch:hover input:checked~.handle { transform: translateX(calc(var(--w) - var(--knob) - (var(--offset) * 2))) scale(1.05); }

#galvan-reset-overlay {
    position: fixed; inset: 0; z-index: 200000 !important; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0s linear 0.4s; pointer-events: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif; transform: translateZ(1000px) !important;
}
#galvan-reset-overlay.show { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.4s ease, visibility 0s linear 0s; }
.reset-hud-container { display: flex; flex-direction: column; align-items: center; gap: 32px; transform: scale(0.96); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); width: 300px; }
#galvan-reset-overlay.show .reset-hud-container { transform: scale(1); }
.apple-spinner-svg { width: 48px; height: 48px; animation: iosSpinnerSpin 1s steps(12) infinite; color: var(--current-text-primary); }
.apple-spinner-svg line { stroke: currentColor; stroke-width: 4; stroke-linecap: round; }
.apple-spinner-svg line:nth-child(1) { opacity: 1; } .apple-spinner-svg line:nth-child(2) { opacity: 0.9; } .apple-spinner-svg line:nth-child(3) { opacity: 0.8; } .apple-spinner-svg line:nth-child(4) { opacity: 0.7; } .apple-spinner-svg line:nth-child(5) { opacity: 0.6; } .apple-spinner-svg line:nth-child(6) { opacity: 0.5; } .apple-spinner-svg line:nth-child(7) { opacity: 0.4; } .apple-spinner-svg line:nth-child(8) { opacity: 0.3; } .apple-spinner-svg line:nth-child(9) { opacity: 0.25; } .apple-spinner-svg line:nth-child(10) { opacity: 0.2; } .apple-spinner-svg line:nth-child(11) { opacity: 0.15; } .apple-spinner-svg line:nth-child(12) { opacity: 0.1; }
.reset-info-wrapper { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; text-align: center; }
.reset-title { font-size: 17px; font-weight: 600; color: var(--current-text-primary); letter-spacing: -0.01em; margin: 0; }
.reset-status-log { font-size: 13px; color: var(--current-text-secondary); opacity: 0.7; font-weight: 400; min-height: 1.2em; transition: opacity 0.2s ease; }
.reset-progress-track { width: 80%; height: 10px; background: rgba(125, 125, 125, 0.2); border-radius: 100px; overflow: hidden; position: relative; }
.reset-progress-fill { height: 100%; width: 0%; background: var(--current-icon-active); border-radius: 100px; transition: width 0.4s cubic-bezier(0.33, 1, 0.68, 1); }

#galvan-confirm-modal {
    position: fixed; inset: 0; z-index: 200000 !important; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, backdrop-filter 0.4s ease, visibility 0s linear 0.4s; pointer-events: none; transform: translateZ(1000px) !important;
}
#galvan-confirm-modal.visible { opacity: 1; visibility: visible; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); transition: opacity 0.4s ease, backdrop-filter 0.4s ease, visibility 0s linear 0s; pointer-events: auto !important; }
#galvan-confirm-modal.closing { opacity: 0; transition: opacity 0.3s ease; }
.galvan-confirm-box { width: 85%; max-width: 320px; background: var(--current-bot-msg-bg); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: none; padding: 32px 24px 24px; border-radius: 36px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 12px; transform: translateY(-60px) scale(0.9); opacity: 0; filter: blur(20px); transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.5s ease-out, filter 0.6s cubic-bezier(0.19, 1, 0.22, 1); will-change: transform, opacity, filter; }
#galvan-confirm-modal.visible .galvan-confirm-box { transform: translateY(0) scale(1); opacity: 1; filter: blur(0px); transition-delay: 0.05s; }
#galvan-confirm-modal.closing .galvan-confirm-box { transform: translateY(-80px) scale(0.85); opacity: 0; filter: blur(15px); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease-in, filter 0.3s ease-in; transition-delay: 0s; }
.galvan-confirm-icon { font-size: 44px; color: var(--current-icon-active); margin-bottom: 8px; animation: modalIconFloat 3s ease-in-out infinite; filter: drop-shadow(0 10px 20px var(--current-prompt-focus-shadow)); }
#galvan-confirm-title { font-size: 1.35rem; font-weight: 700; color: var(--current-text-primary); margin: 0; letter-spacing: -0.01em; }
#galvan-confirm-text { font-size: 0.95rem; color: var(--current-text-secondary); margin: 0 0 16px 0; line-height: 1.5; opacity: 0.85; }
.galvan-confirm-actions { display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 5px; }
.galvan-modal-btn { width: 100%; padding: 15px; border-radius: 50px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s ease, background-color 0.3s; }
.galvan-modal-btn:active { transform: scale(0.96); }
.galvan-modal-btn ion-icon { font-size: 1.25rem; }
.galvan-modal-btn.secondary { background: rgba(255, 255, 255, 0.05); color: var(--current-text-secondary); border: 1px solid rgba(255, 255, 255, 0.1); }
.galvan-modal-btn.primary { background: var(--current-icon-active); color: #ffffff; box-shadow: none; }
.galvan-modal-btn.primary.destructive { background: var(--current-error-text); box-shadow: none; }

.galvan-notification-hub {
    position: fixed; top: calc(var(--safe-top, 0px) + 12px); right: 16px; z-index: 10000; width: 52px; height: 52px; max-height: 52px; border-radius: 50% !important; background: var(--current-bot-msg-bg); backdrop-filter: blur(5px) !important; -webkit-backdrop-filter: blur(5px) !important; border: 1px solid rgba(255, 255, 255, 0.189) !important; transform-origin: top right; transition: width 0.7s var(--ease-expo-out), height 0.7s var(--ease-expo-out), max-height 0.7s var(--ease-expo-out), border-radius 0.6s var(--ease-squish), background-color 0.4s ease, transform 0.5s var(--ease-expo-out), box-shadow 0.4s ease !important; will-change: width, height, transform, border-radius; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; font-family: var(--font-stack); -webkit-font-smoothing: antialiased; background-clip: padding-box !important; -webkit-background-clip: padding-box !important; -webkit-transform: translate3d(0, 0, 0); backface-visibility: hidden; -webkit-backface-visibility: hidden; perspective: 1000px; outline: 1px solid transparent;
}
body:not(.light-mode) #galvan-notification-hub { border: 1px solid rgba(255, 255, 255, 0.1) !important; box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important; }
.galvan-notification-hub:hover { transform: scale(1.05); box-shadow: none; }
.galvan-notification-hub:active { transform: scale(0.94); }
.galvan-notification-hub.expanded { width: min(400px, 94vw); height: auto; max-height: min(85vh, 820px); border-radius: 44px !important; background: var(--current-bot-msg-bg); cursor: default; pointer-events: auto; transform: scale(1); box-shadow: none; display: flex; flex-direction: column; }

.hub-icon-layer { position: absolute; inset: 0; height: 52px; width: 52px; margin-left: auto; display: flex; align-items: center; justify-content: center; color: var(--current-text-primary); transition: opacity 0.3s ease, transform 0.6s var(--ease-expo-out); z-index: 5; pointer-events: none; }
.hub-icon-layer ion-icon { font-size: 26px; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)); animation: floatBreathing 4s ease-in-out infinite; }
.galvan-notification-hub.expanded .hub-icon-layer { opacity: 0; transform: scale(0.4) rotate(-90deg); }
.hub-badge { position: absolute; top: 8px !important; right: 8px !important; width: 12px; height: 12px; min-width: 0; padding: 0; background: #FF3B30 !important; border: 2px solid var(--current-body-bg) !important; border-radius: 50%; color: transparent !important; font-size: 0 !important; display: flex; align-items: center; justify-content: center; transform: scale(0); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 20; box-shadow: 0 2px 5px rgba(255, 59, 48, 0.4) !important; overflow: hidden; }
body:not(.light-mode) .hub-badge { border-color: #2c2c2c !important; }
.galvan-notification-hub.has-unread .hub-badge { transform: scale(1); }
.galvan-notification-hub.pulsing { animation: pulseRing 3s infinite; }

.hub-contents-layer { width: 100%; opacity: 0; display: flex; flex-direction: column; flex: 1; padding: 20px; gap: 20px; pointer-events: auto !important; mask-image: linear-gradient(to bottom, black calc(100% - 20px), transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black calc(100% - 20px), transparent 100%); height: 100%; min-height: 0; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
.hub-contents-layer::-webkit-scrollbar { width: 0px; background: transparent; }
.galvan-notification-hub.expanded .hub-contents-layer { opacity: 1; pointer-events: auto; transition: opacity 0.4s ease 0.2s; }
.galvan-notification-hub.expanded .hub-contents-layer>* { opacity: 0; animation: contentStagger 0.7s var(--ease-sleek) forwards; }
.galvan-notification-hub.expanded .hub-contents-layer>*:nth-child(1) { animation-delay: 0.15s; }
.galvan-notification-hub.expanded .hub-contents-layer>*:nth-child(2) { animation-delay: 0.22s; }
.galvan-notification-hub.expanded .hub-contents-layer>*:nth-child(3) { animation-delay: 0.29s; }

.hub-sector { background: rgba(255, 255, 255, 0.5) !important; border: 1px solid rgba(255, 255, 255, 0.4) !important; border-radius: 32px !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03) !important; margin-bottom: 12px; }
body:not(.light-mode) .hub-sector { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.08) !important; }
.system-sector { padding: 20px; position: relative; flex-shrink: 0; }
.sector-header { padding: 15px 10px; display: flex; backdrop-filter: blur(5px) saturate(180%); border-radius: 100px; background: var(--current-bot-msg-bg); flex-shrink: 0; margin-bottom: 16px; }
.sector-label { font-size: 0.7rem; font-weight: 800; letter-spacing: 0.12em; color: var(--current-text-secondary); text-transform: uppercase; opacity: 0.9; font-family: var(--font-stack); }
.sector-actions { position: absolute; right: 3px; bottom: 3px; display: flex; gap: 5px; background: var(--current-bot-msg-bg); border-radius: 100px; padding: 2px; }
.hub-action-btn { width: 32px; height: 32px; border-radius: 50% !important; border: none !important; display: flex; align-items: center; justify-content: center; background: var(--glass-surface); color: var(--current-text-secondary); cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s ease; box-shadow: none !important; }
.hub-action-btn:hover { transform: scale(1.1); filter: brightness(0.95); }
.hub-action-btn:active { transform: scale(0.92); }
.hub-action-btn.close-btn { background: rgba(255, 59, 48, 0.15) !important; color: #FF3B30 !important; }
.hub-action-btn.tick-btn { background: rgba(52, 199, 89, 0.15) !important; color: #34C759 !important; }
body:not(.light-mode) .hub-action-btn.close-btn { background: rgba(255, 69, 58, 0.25) !important; color: #FF453A !important; }
body:not(.light-mode) .hub-action-btn.tick-btn { background: rgba(48, 209, 88, 0.25) !important; color: #30D158 !important; }
.sector-body-list { display: flex; flex-direction: column; gap: 12px; max-height: 200px; overflow-y: auto; padding-right: 4px; scrollbar-width: none; }
.hub-msg-item { display: flex; align-items: flex-start; gap: 14px; border-radius: 20px; padding: 14px; background: rgba(255, 255, 255, 0.02); border: 1px solid transparent; transition: all 0.3s ease; cursor: pointer; }
.hub-msg-item:hover { background: rgba(255, 255, 255, 0.05); transform: translateX(4px); border-color: rgba(255, 255, 255, 0.05); }
.msg-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--current-icon-active); margin-top: 6px; flex-shrink: 0; box-shadow: none; position: relative; }
.msg-dot::after { content: ''; position: absolute; inset: -3px; border-radius: 50%; background: var(--current-icon-active); opacity: 0.3; animation: pulseRing 2s infinite; }
.msg-text { font-size: 0.92rem; color: var(--current-text-primary); line-height: 1.5; font-weight: 500; letter-spacing: -0.01em; }

.notice-sector { position: relative; width: 100%; margin-bottom: 12px; flex-shrink: 0; border-radius: 22px !important; border: 1px solid rgba(0, 0, 0, 0.06) !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02), inset 0 1px 0 rgba(255, 255, 255, 1); transform: translateZ(0); will-change: transform, box-shadow, height; transition: all 0.5s var(--apple-spring); overflow: hidden; z-index: 1; }
.notice-sector:hover { transform: scale(1.02); border-color: var(--glass-highlight); box-shadow: none; }
.notice-sector.active { transform: scale(1.015) translateY(-2px); z-index: 10; border-color: rgba(0, 0, 0, 0) !important; cursor: default; }
body:not(.light-mode) .notice-sector { border: 1px solid rgba(255, 255, 255, 0.08) !important; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
body:not(.light-mode) .notice-sector.active { border-color: rgba(255, 255, 255, 0.08) !important; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6); }
.notice-sector.spatial-edition { border: 1px solid rgba(255, 255, 255, 0.1) !important; border-radius: 26px !important; overflow: hidden; position: relative; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); transform: translateZ(0); z-index: 1; }
body.light-mode .notice-sector.spatial-edition { border: 1px solid rgba(0, 0, 0, 0.08) !important; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
.notice-sector.spatial-edition.active { border-color: #3b82f6 !important; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2), 0 20px 50px rgba(0,0,0,0.5) !important; transform: scale(1.02); z-index: 100; border-color: transparent !important; }
.spatial-preview { height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; cursor: pointer; position: relative; z-index: 2; overflow: hidden; }
.scan-line { position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transform: skewX(-20deg); transition: left 0.5s; pointer-events: none; }
.notice-sector.spatial-edition:hover .scan-line { left: 200%; transition: left 1s ease-in-out; }
.preview-left { display: flex; align-items: center; gap: 16px; }
.sys-icon-box { width: 44px; height: 44px; position: relative; display: flex; align-items: center; justify-content: center; }
.icon-core { font-size: 24px; color: #3b82f6; z-index: 2; }
.icon-ring { position: absolute; inset: 0; border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px; transform: rotate(45deg); transition: transform 0.5s ease; }
.notice-sector.spatial-edition.active .icon-ring { transform: rotate(0deg) scale(1.1); border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
.sys-info { display: flex; flex-direction: column; }
.sys-label { font-size: 0.65rem; letter-spacing: 0.15em; color: #64748b; font-weight: 700; }
.sys-ver { font-size: 1.1rem; color: var(--current-text-primary); font-weight: 700; letter-spacing: -0.01em; }
.preview-right { display: flex; align-items: center; }
.status-pill { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: 6px 12px; border-radius: 100px; display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 600; color: #10b981; }
.pill-dot { width: 6px; height: 6px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px #10b981; animation: pulseDot 2s infinite; }
.spatial-content-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.6s cubic-bezier(0.19, 1, 0.22, 1); }
.notice-sector.spatial-edition.active .spatial-content-wrapper { grid-template-rows: 1fr; }
.spatial-inner { overflow: hidden; overflow-y: auto; min-height:min(85vh, 270px); padding: 0 24px 28px 24px; }
.holo-deck { height: 140px; background: radial-gradient(circle at center, #1e1b4b, #000000); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; display: flex; align-items: center; padding: 20px; margin-bottom: 20px; margin-top: 10px; }
body.light-mode .holo-deck { background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.02), 0 20px 40px -10px rgba(0, 0, 0, 0.05); }
.holo-grid-bg { position: absolute; inset: 0; background-image: linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px); background-size: 20px 20px; perspective: 500px; transform: perspective(300px) rotateX(20deg) scale(1.5); opacity: 0.5; }
body.light-mode .holo-grid-bg { background-image: linear-gradient(rgba(0, 0, 0, 0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.04) 1px, transparent 1px); opacity: 0.8; }
.holo-obj { width: 60px; height: 60px; margin-right: 20px; position: relative; perspective: 800px; }
.cube-spinner { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: spinCube 8s infinite linear; }
.face { position: absolute; width: 40px; height: 40px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.6); top: 10px; left: 10px; }
.front { transform: rotateY(0deg) translateZ(20px); } .back { transform: rotateY(180deg) translateZ(20px); } .right { transform: rotateY(90deg) translateZ(20px); } .left { transform: rotateY(-90deg) translateZ(20px); } .top { transform: rotateX(90deg) translateZ(20px); } .bottom { transform: rotateX(-90deg) translateZ(20px); }
.holo-meta { display: flex; flex-direction: column; justify-content: center; position: relative; z-index: 2; padding-left: 10px; border-left: 2px solid rgba(59, 130, 246, 0.3); }
.holo-meta h3 { margin: 0; font-size: 1.6rem; font-weight: 800; letter-spacing: -0.03em; background: linear-gradient(180deg, #ffffff 0%, rgba(255, 255, 255, 0.7) 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.5)); line-height: 1; }
.holo-meta p { margin: 8px 0 0 0; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2em; color: #60a5fa; display: flex; align-items: center; gap: 8px; text-shadow: 0 0 10px rgba(96, 165, 250, 0.4); }
.holo-meta p::before { content: ''; display: block; width: 6px; height: 6px; background: #60a5fa; border-radius: 50%; box-shadow: 0 0 8px #60a5fa, 0 0 15px #60a5fa; animation: metaDotPulse 2s ease-in-out infinite; }
body.light-mode .holo-meta { border-left-color: rgba(37, 99, 235, 0.2); }
body.light-mode .holo-meta h3 { background: linear-gradient(180deg, #1e293b 0%, #475569 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.1)); }
body.light-mode .holo-meta p { color: #2563eb; text-shadow: none; }
body.light-mode .holo-meta p::before { background: #2563eb; box-shadow: 0 0 8px rgba(37, 99, 235, 0.4); }
.tech-specs-row { display: flex; gap: 12px; margin-bottom: 20px; }
.spec-chip { flex: 1; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 8px; text-align: center; display: flex; flex-direction: column; }
body.light-mode .spec-chip { background: #f8fafc; border-color: #e2e8f0; }
.spec-key { font-size: 0.6rem; color: #64748b; font-weight: 700; margin-bottom: 2px; }
.spec-val { font-size: 0.9rem; color: var(--current-text-primary); font-weight: 600; font-family: monospace; }
.feature-manifest { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
.manifest-item { display: flex; align-items: center; gap: 12px; font-size: 0.9rem; color: var(--current-text-secondary); padding: 20px; background: rgba(255, 255, 255, 0.02); border-radius: 100px; transition: transform 0.2s; }
.manifest-item:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); }
body.light-mode .manifest-item { background: #f1f5f9; }
.interaction-zone { margin-top: 10px; }
.hold-trigger-btn { width: 100%; height: 50px; background: #1e293b; border-radius: 100px; position: relative; border: none; overflow: hidden; cursor: pointer; user-select: none; touch-action: none; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3); }
body.light-mode .hold-trigger-btn { background: #e2e8f0; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
.hold-track { position: absolute; inset: 0; background: transparent; }
.hold-progress { width: 0%; height: 100%; background: linear-gradient(90deg, #0046f6, #001297); transition: width 0.1s linear; border-radius: 100px; }
.hold-trigger-btn.held .hold-progress { width: 100%; transition: width 1.5s linear; }
.hold-trigger-btn.complete .hold-progress { width: 100%; background: linear-gradient(90deg, #0046f6, #001297); transition: background 0.3s; }
.hold-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 10px; color: rgba(255,255,255,0.5); font-weight: 600; transition: opacity 0.2s; }
body.light-mode .hold-label { color: rgba(0,0,0,0.4); }
.hold-trigger-btn.held .hold-label { color: white; opacity: 1; }
.finger-icon { font-size: 24px; animation: fingerPulse 2s infinite; }
.success-layer { position: absolute; inset: 0; background: linear-gradient(90deg, #0046f6, #001297); display: flex; align-items: center; justify-content: center; gap: 10px; color: white; font-weight: 700; font-size: 1.1rem; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
.hold-trigger-btn.complete .success-layer { transform: translateY(0); }
.hold-trigger-btn.complete .hold-label { opacity: 0; }
.notice-sector.spatial-edition::before { content: ''; position: absolute; inset: 0; padding: 2px; border-radius: 26px; background: linear-gradient(115deg, #3b82f6, #8b5cf6, #0029f7, #3b82f6); background-size: 300% 300%; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; z-index: 10; }
.notice-sector.spatial-edition.active::before, body.ios-update-focus .notice-sector.spatial-edition::before { opacity: 1; animation: spatialGradientFlow 4s linear infinite; }

#galvan-customize-hub { position: fixed; top: calc(var(--safe-top) + 74px); right: 16px; z-index: 9998; transform-origin: top right; }
.galvan-notification-hub:hover, #galvan-customize-hub:hover { transform: scale(1.05); }
.galvan-notification-hub:active, #galvan-customize-hub:active { transform: scale(0.94); }
.galvan-notification-hub.expanded, #galvan-customize-hub.expanded { width: min(400px, 94vw); height: auto; max-height: min(85vh, 820px); border-radius: 36px !important; background: var(--current-bot-msg-bg); cursor: default; pointer-events: auto; transform: scale(1); display: flex; flex-direction: column; overflow: hidden !important; transition: width 0.65s cubic-bezier(0.19, 1, 0.22, 1), height 0.65s cubic-bezier(0.19, 1, 0.22, 1), max-height 0.65s cubic-bezier(0.19, 1, 0.22, 1), border-radius 0.65s cubic-bezier(0.19, 1, 0.22, 1), background-color 0.4s ease, transform 0.5s cubic-bezier(0.19, 1, 0.22, 1), box-shadow 0.4s ease; }
.galvan-notification-hub.expanded .hub-content-layer>*, .galvan-notification-hub.expanded .hub-contents-layer>*, #galvan-customize-hub.expanded .hub-content-layer>* { opacity: 0; animation: smoothHubSlideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
.galvan-notification-hub.expanded .hub-icon-layer, #galvan-customize-hub.expanded .hub-icon-layer { opacity: 0; transform: scale(0.4) rotate(-90deg); }
.hub-content-layer { width: 100%; opacity: 0; display: flex; flex-direction: column; flex: 1; padding: 20px; gap: 20px; pointer-events: none; mask-image: linear-gradient(to bottom, black calc(100% - 20px), transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black calc(100% - 20px), transparent 100%); min-height: 0; -webkit-overflow-scrolling: touch; }
.galvan-notification-hub.expanded .hub-content-layer, #galvan-customize-hub.expanded .hub-content-layer { opacity: 1; pointer-events: auto; transition: opacity 0.4s ease 0.2s; }
.galvan-notification-hub.expanded .hub-content-layer>, #galvan-customize-hub.expanded .hub-content-layer>* { opacity: 0; animation: contentStagger 0.7s var(--ease-sleek) forwards; }
#galvan-customize-hub.expanded .hub-content-layer>:nth-child(1) { animation-delay: 0.15s; } #galvan-customize-hub.expanded .hub-content-layer>:nth-child(2) { animation-delay: 0.22s; } #galvan-customize-hub.expanded .hub-content-layer>*:nth-child(3) { animation-delay: 0.29s; }

.studio-sector { position: relative; display: flex; flex-direction: column; height: 100%; overflow: hidden; isolation: isolate; max-height: min(80vh, 710px); }
.studio-header { position: absolute; top: 0; left: 0; right: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin: 16px; background: var(--current-bot-msg-bg); border-radius: 100px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; --fx-filter: blur(4px) liquid-glass(2, 10) saturate(1.25); }
.studio-sector::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(to top, var(--current-bot-msg-bg), transparent); z-index: 25; pointer-events: none; }
.studio-title-stack { display: flex; flex-direction: column; gap: 2px; }
.studio-label { font-size: 0.95rem; font-weight: 800; letter-spacing: 0.05em; color: var(--current-text-primary); text-transform: uppercase; font-family: var(--font-stack); }
.studio-sublabel { font-size: 0.7rem; color: var(--current-text-secondary); opacity: 0.7; font-weight: 500; }
#hub-viewport { flex: 1; position: relative; overflow: hidden; width: 100%; display: flex; flex-direction: column; min-height: 0; height: 100%; }
#hub-track { flex: 1; display: flex; width: 100%; height: 100%; min-height: 0; }
.hub-view-pane { width: 100%; height: 100%; flex-shrink: 0; display: flex; flex-direction: column; min-height: 0; }
.customize-scroll-content { flex: 1; overflow-y: auto !important; overflow-x: hidden; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; padding: 90px 20px 80px 20px; pointer-events: auto; min-height: min(85vh, 480px); position: relative; scrollbar-width: none; height: 100%; max-height: 100%; }
.customize-scroll-content::-webkit-scrollbar { display: none; width: 0; background: transparent; }
.customize-scroll-content > * { transform: translateZ(0); }
.studio-group { background: var(--current-bot-msg-bg); border: 1px solid rgb(255 255 255 / 16%); border-radius: 24px; padding: 10px; margin-top: 30px; margin-bottom: 30px; }
.studio-group-label { font-size: 0.65rem; font-weight: 700; color: var(--current-text-secondary); opacity: 0.5; text-transform: uppercase;letter-spacing: 0.1em; padding: 0 0 8px 12px; display: block; }
.notice-setting-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: transparent; border: none; border-radius: 100px; transition: background 0.2s; margin-bottom: 2px; }
.notice-setting-row:hover { background: rgba(255, 255, 255, 0.04); }
.row-info { display: flex; align-items: center; gap: 14px; }
.icon-squircle { width: 50px; height: 50px; background: rgba(255, 255, 255, 0.1); border-radius: 100px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--current-text-primary); }
.setting-label-small { font-size: 0.95rem; font-weight: 600; color: var(--current-text-primary); }

.oneui-palette-container { background: var(--current-bot-msg-bg); border-radius: 28px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 20px; border: 1px solid rgba(255,255,255,0.1); will-change: transform; }
body.light-mode .oneui-palette-container { background: var(--current-bot-msg-bg); }
.oneui-tabs-wrapper { position: relative; display: flex; background: rgba(0,0,0,0.05); border-radius: 100px; padding: 4px; height: 44px; transform-origin: center center; will-change: transform; touch-action: none; -webkit-user-select: none; user-select: none; z-index: 10; }
body.light-mode .oneui-tabs-wrapper { background: #f2f2f2; }
.oneui-tab-glider { position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); background: #ffffff; border-radius: 100px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.5s var(--apple-spring), width 0.3s ease; z-index: 1; will-change: transform; }
body:not(.light-mode) .oneui-tab-glider { background: rgba(255,255,255,0.15); }
.oneui-tabs-wrapper.show-basic .oneui-tab-glider { transform: translateX(100%); }
.oneui-tabs-wrapper.is-dragging .oneui-tab-glider { transition: none !important; cursor: grabbing; }
.oneui-tabs-wrapper.is-dragging { cursor: grabbing; transition: none !important; }
.oneui-tabs-wrapper.is-snapping { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
.oneui-tabs-wrapper.is-snapping .oneui-tab-glider { transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
.oneui-tab-btn { flex: 1; position: relative; z-index: 2; background: transparent; border: none; font-size: 0.85rem; font-weight: 600; color: var(--current-text-secondary); cursor: pointer; transition: color 0.3s ease; }
.oneui-tab-btn.active { color: var(--current-text-primary); }
.oneui-swatch-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; justify-items: center; padding: 8px 0; min-height: 120px; }
.oneui-swatch { width: 48px; height: 48px; border-radius: 50%; position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
.oneui-swatch:hover { transform: scale(1.1); }
.oneui-swatch:active { transform: scale(0.95); }
.oneui-swatch.active::after { content: ''; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: center; background-size: 24px; background-color: rgba(0,0,0,0.2); border-radius: 50%; animation: checkPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
.oneui-swatch.dropper { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%); display: flex; align-items: center; justify-content: center; }
.oneui-swatch.dropper ion-icon { font-size: 20px; color: #333; }
.oneui-color-input-hidden { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

.sticky-bottom-nav { margin: 0 16px 16px 16px; padding: 4px; background: var(--current-bot-msg-bg); border-radius: 100px; height: 56px; flex-shrink: 0; position: relative; z-index: 10; backdrop-filter: blur(20px) saturate(25); }
.hub-nav-glider { background: var(--current-bot-msg-bg); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); border-radius: 100px; z-index: 1; transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
.hub-nav-tab { flex: 1; position: relative; z-index: 2; background: transparent; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.85rem; font-weight: 700; color: var(--current-text-secondary); cursor: pointer; outline: none; border-radius: 100px; height: 100%; width: 50%; float: left; }
.hub-nav-tab.active { color: var(--current-text-primary); }
.toggle-card { background: var(--crystal-surface); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 24px; padding: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; transition: all 0.4s var(--fluid-ease); cursor: pointer; position: relative; overflow: hidden; }
.toggle-card ion-icon { font-size: 1.5rem; color: var(--current-text-primary); transition: transform 0.5s var(--soft-bounce); }
.toggle-card:hover ion-icon { transform: scale(1.15) rotate(6deg); color: var(--current-icon-active); }
.hub-nav-header { --liquid-blur: blur(0px); }
.oneui-palette-container, .galvan-prompt-container, .galvan-file-upload-wrapper, .galvan-notification-hub, .glass-card, .premium-card, .galvan-top-nav-island, .oneui-tab-glider, .galvan-switch .handle, .premium-icon-box { background-clip: padding-box !important; -webkit-background-clip: padding-box !important; transform: translate3d(0, 0, 0); -webkit-transform: translate3d(0, 0, 0); backface-visibility: hidden; -webkit-backface-visibility: hidden; perspective: 1000px; overflow: hidden; outline: 1px solid transparent; }
.oneui-palette-container, .glass-card { will-change: transform; }
.customize-panel, .customize-scroll-content { contain: layout paint size; }

.quick-actions-hub {
    position: fixed; z-index: 10005; background: rgba(30, 30, 35, 0); backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 rgba(0,0,0,0); overflow: hidden; opacity: 0; pointer-events: none; display: flex; flex-direction: column; transform-origin: center; will-change: width, height, top, left, border-radius, opacity, background-color, backdrop-filter, box-shadow; transition: width 0.4s var(--qa-snap), height 0.4s var(--qa-snap), top 0.4s var(--qa-snap), left 0.4s var(--qa-snap), border-radius 0.4s var(--qa-snap), opacity 0.3s ease, background-color 0.3s ease, backdrop-filter 0.3s ease, box-shadow 0.3s ease;
}
.quick-actions-hub.active { opacity: 1; pointer-events: auto; background: var(--current-bot-msg-bg); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.15); transition: width 0.65s var(--qa-motion), height 0.65s var(--qa-motion), top 0.65s var(--qa-motion), left 0.65s var(--qa-motion), border-radius 0.65s var(--qa-motion), opacity 0.1s linear, background-color 0.5s ease, backdrop-filter 0.5s ease, box-shadow 0.6s ease; }
.qa-content-layer { opacity: 0; display: flex; flex-direction: column; width: 100%; height: 100%; padding: 16px; transform: translateY(60px) scale(0.92); transition: opacity 0.2s ease, transform 0.2s ease; }
.quick-actions-hub.active .qa-content-layer { opacity: 1; transform: translateY(0) scale(1); transition: opacity 0.5s ease 0.1s, transform 0.7s var(--qa-motion) 0.1s; }
.qa-action-row { display: flex; justify-content: space-between; padding: 0 8px 12px 8px; flex-shrink: 0; background: var(--current-bot-msg-bg); perspective: 1000px; padding: 14px 10px 10px 10px; margin-bottom: 10px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.05); }
.qa-quick-action { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: var(--current-text-primary); width: 60px; }
.qa-icon-circle { width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid rgba(255, 255, 255, 0.05); transform: scale(0.5) rotate(-90deg); opacity: 0; }
.quick-actions-hub.active .qa-icon-circle { animation: spinEnter 0.6s var(--qa-motion) forwards; animation-delay: calc(var(--delay) + 0.1s); }
.qa-quick-action span { font-size: 0.65rem; font-weight: 600; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
.quick-actions-hub.active .qa-quick-action span { opacity: 0.8; transform: translateY(0); transition-delay: calc(var(--delay) + 0.3s); }
.qa-divider { height: 1px; background: rgba(255, 255, 255, 0.1); width: 100%; margin-bottom: 8px; flex-shrink: 0; opacity: 0; transform: scaleX(0); transform-origin: left; }
.quick-actions-hub.active .qa-divider { opacity: 1; transform: scaleX(1); transition: opacity 0.4s ease 0.3s, transform 0.6s var(--qa-motion) 0.3s; }
.qa-scroll-view { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; scrollbar-width: none; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
.qa-list-item { display: flex; align-items: center; gap: 12px; padding: 14px; border-radius: 18px; cursor: pointer; background: rgba(255,255,255,0.03); border: 1px solid rgba(255, 255, 255, 0.02); color: var(--current-text-primary); opacity: 0; transform: translateY(30px); }
.quick-actions-hub.active .qa-list-item { animation: slideUpList 0.7s var(--qa-motion) forwards; }
.qa-list-icon { font-size: 20px; opacity: 0.8; color: var(--current-icon-active); }
.qa-list-text { font-size: 0.95rem; font-weight: 500; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.qa-list-delete { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: none; background: transparent; color: var(--current-dislike-color); opacity: 0; transition: 0.2s; }
.qa-list-item:hover { background: rgba(255,255,255,0.06); }
.qa-list-item:hover .qa-list-delete { opacity: 1; background: rgba(255, 69, 58, 0.15); }
.qa-empty { font-size: 0.9rem; text-align: center; padding: 40px 20px; opacity: 0.5; color: var(--current-text-secondary); }

#galvan-wallpaper-layer { position: fixed; inset: 0; width: 100%; height: 100%; z-index: -1; background-color: #000; background-position: center; background-size: cover; background-repeat: no-repeat; opacity: 0; transform: scale(1.1); transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); pointer-events: none; will-change: transform, opacity; }
#galvan-wallpaper-layer.active { opacity: 1; transform: scale(1); }
body.wallpaper-active { background: transparent !important; background-color: transparent !important; background-image: none !important; }
body.wallpaper-active::before { display: none !important; }
body.wallpaper-active .galvan-container { background: transparent; }
body.wallpaper-active .galvan-prompt-container, body.wallpaper-active .galvan-top-nav-island, body.wallpaper-active .galvan-notification-hub, body.wallpaper-active #galvan-customize-hub, body.wallpaper-active .galvan-chats-container { border: 1px solid rgba(255, 255, 255, 0.1); }
body.light-mode.wallpaper-active .galvan-prompt-container, body.light-mode.wallpaper-active .galvan-top-nav-island, body.light-mode.wallpaper-active .galvan-notification-hub, body.light-mode.wallpaper-active #galvan-customize-hub, body.light-mode.wallpaper-active .galvan-chats-container { border: 1px solid rgba(255, 255, 255, 0.4); }

.premium-glass-group { background: transparent !important; border: none !important; padding: 0 !important; margin-top: 20px; margin-bottom: 40px; }
.premium-header { display: flex; justify-content: space-between; align-items: center; padding: 0 4px 12px 4px; }
.premium-label { font-size: 1.1rem; font-weight: 700; color: var(--current-text-primary); letter-spacing: -0.01em; }
.premium-preview-card { position: relative; width: 100%; height: 180px; background-color: var(--current-bg-secondary); border-radius: 24px; overflow: hidden; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--current-border-color); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
.premium-preview-card:active { transform: scale(0.98); }
.preview-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--galvan-bg-tertiary-light); background: var(--current-bg-tertiary); position: relative; }
#wp-preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
.preview-icon-stack { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--current-text-secondary); opacity: 0.6; }
.preview-icon-stack ion-icon { font-size: 32px; }
.preview-icon-stack span { font-size: 0.85rem; font-weight: 500; }
.preview-actions { position: absolute; bottom: 12px; right: 12px; display: flex; gap: 8px; }
.ios-text-btn { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: none; padding: 6px 14px; border-radius: 100px; font-size: 0.8rem; font-weight: 600; color: #007AFF; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s ease; }
body:not(.light-mode) .ios-text-btn { background: rgba(40, 40, 40, 0.8); color: #0A84FF; }
.ios-text-btn.destructive { color: #FF3B30; }
.ios-text-btn:active { transform: scale(0.95); filter: brightness(0.9); }
.premium-slider-section { padding: 0 4px; transition: opacity 0.3s ease; }
.slider-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 16px; }
.slider-label { font-size: 1rem; font-weight: 600; color: var(--current-text-primary); }
.slider-value { font-size: 0.9rem; font-weight: 500; color: var(--current-text-secondary); font-variant-numeric: tabular-nums; }
.ios-slider-container { display: flex; align-items: center; gap: 16px; border-radius: 100px; background: var(--current-bot-msg-bg); height: 44px; padding: 20px; }
.slider-icon { color: var(--current-text-secondary); opacity: 0.5; }
.slider-icon.small { font-size: 16px; }
.slider-icon.large { font-size: 24px; }
.slider-track-wrapper { flex: 1; position: relative; height: 4px; display: flex; align-items: center; }
.slider-track-wrapper input[type=range] { -webkit-appearance: none; width: 100%; height: 4px; background: transparent; outline: none; z-index: 2; margin: 0; position: relative; }
.slider-track-wrapper input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: linear-gradient(to right, #007AFF var(--slider-fill-percent, 0%), rgba(120,120,128, 0.2) var(--slider-fill-percent, 0%)); }
body:not(.light-mode) .slider-track-wrapper input[type=range]::-webkit-slider-runnable-track { background: linear-gradient(to right, #0A84FF var(--slider-fill-percent, 0%), rgba(255,255,255, 0.2) var(--slider-fill-percent, 0%)); }
.slider-track-wrapper input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 28px; width: 48px; border-radius: 50px; background: #ffffff; box-shadow: 0 2px 6px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1); margin-top: -12px; cursor: grab; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
.slider-track-wrapper input[type=range]::-webkit-slider-thumb:active { transform: scale(1.1); cursor: grabbing; }
.slider-ticks { position: absolute; top: 50%; left: 0; right: 0; height: 4px; transform: translateY(-50%); z-index: 1; pointer-events: none; background-image: repeating-linear-gradient(to right, transparent 0, transparent calc(10% - 1px), rgba(0,0,0,0.05) calc(10% - 1px), rgba(0,0,0,0.05) 10%); opacity: 0; border-radius: 2px; }
.premium-caption { margin-top: 12px; font-size: 0.8rem; line-height: 1.4; color: var(--current-text-secondary); opacity: 0.7; text-align: center; padding: 0 10px; }
.premium-preview-card { position: relative; overflow: hidden; }
.wp-loader-overlay { position: absolute; inset: 0; background: transparent; border-radius:24px; backdrop-filter:blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
.premium-preview-card.is-loading .wp-loader-overlay { opacity: 1; pointer-events: auto; }
.wp-spinner { width: 40px; height: 40px; border: 3px solid rgba(255, 255, 255, 0.1); border-top-color: #fff; border-radius: 50%; animation: wpSpin 1s infinite linear; margin-bottom: 12px; }
.wp-loading-text { font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 8px; letter-spacing: 0.02em; }
.wp-progress-track { width: 60%; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; overflow: hidden; }
.wp-progress-fill { height: 100%; width: 0%; background: #fff; border-radius: 10px; transition: width 0.2s ease-out; }
#galvan-wallpaper-layer { transition: transform 1.2s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.8s ease, filter 0.8s ease; will-change: transform, opacity, filter; }
#galvan-wallpaper-layer.prepare-entry { opacity: 0; transform: scale(1.15); filter: blur(20px) !important; }
#galvan-wallpaper-layer.active { opacity: 1; transform: scale(1); }
@media (pointer: fine) { .customize-panel * { box-shadow: none; } }

.galvan-chat-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 360px; z-index: 5; background: rgba(20, 20, 25, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 40px; --fx-filter: blur(4px) liquid-glass(2, 10) saturate(1.25); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; text-align: center; overflow: hidden; isolation: isolate; visibility: hidden; opacity: 0; pointer-events: none; transition: none; }
body.chats-active .galvan-chat-placeholder.visible { visibility: visible; opacity: 1; pointer-events: auto; transition: none; }
body.light-mode .galvan-chat-placeholder { background: rgba(255, 255, 255, 0.3); border: 1px solid rgba(0, 0, 0, 0.05); }
.placeholder-glow { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at center, var(--current-icon-active), transparent 60%); opacity: 0.08; pointer-events: none; z-index: -1; animation: placeholderGlowRotate 10s linear infinite; }
.placeholder-icon-ring { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); opacity: 0; }
body.chats-active .galvan-chat-placeholder.visible .placeholder-icon-ring { animation: blurReveal 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
body.light-mode .placeholder-icon-ring { background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.4)); border-color: rgba(0,0,0,0.05); }
.placeholder-icon { font-size: 32px; color: var(--current-icon-active); filter: drop-shadow(0 0 10px var(--current-icon-active)); }
.placeholder-title { font-size: 1.75rem; font-weight: 800; margin: 0 0 8px 0; background: linear-gradient(120deg, var(--current-text-primary), var(--current-text-secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.02em; opacity: 0; }
body.chats-active .galvan-chat-placeholder.visible .placeholder-title { animation: blurReveal 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) 0.1s forwards; }
.placeholder-desc { font-size: 0.9rem; color: var(--current-text-secondary); opacity: 0; margin: 0; line-height: 1.5; max-width: 240px; }
body.chats-active .galvan-chat-placeholder.visible .placeholder-desc { animation: blurReveal 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) 0.2s forwards; }

#mic-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--current-bot-msg-bg); color: var(--current-icon-primary); display: grid; place-items: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); flex-shrink: 0; padding: 0; margin-right: 8px; position: relative; z-index: 20; outline: none; -webkit-tap-highlight-color: transparent; }
#mic-btn ion-icon { font-size: 24px; transition: all 0.3s ease; pointer-events: none; z-index: 2; }
#mic-btn.listening { background: #FF3B30 !important; color: #ffffff !important; box-shadow: 0 4px 25px rgba(255, 59, 48, 0.4); transform: scale(1.1); }
#mic-btn.listening ion-icon { transform: scale(1); animation: iconBreath 2s infinite ease-in-out; }
#mic-btn::after { content: ''; position: absolute; inset: 0; border-radius: 50%; background: rgba(255, 59, 48, 0.2); opacity: 0; z-index: 1; transform: scale(1); transition: all 0.2s ease; }
#mic-btn.listening::after { animation: rippleWave 1.5s infinite cubic-bezier(0.4, 0, 0.2, 1); }
.voice-status-overlay { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(10px); background: rgba(15, 15, 20, 0.6); --fx-filter: blur(8px) liquid-glass(1, 5) saturate(1.2); backdrop-filter: none !important; -webkit-backdrop-filter: none !important; padding: 8px 16px; border-radius: 20px; color: white; font-size: 0.85rem; font-weight: 600; pointer-events: none; opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 90; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.15); white-space: nowrap; display: flex; align-items: center; gap: 8px; overflow: hidden; }
.voice-status-overlay.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
.voice-status-overlay.countdown-mode { background: rgba(255, 59, 48, 0.8); border-color: transparent; --fx-filter: none; backdrop-filter: blur(10px) !important; }
.voice-wave-bar { width: 3px; height: 12px; background: white; border-radius: 2px; animation: soundWave 0.8s ease-in-out infinite; }
.voice-wave-bar:nth-child(2) { animation-delay: 0.1s; }
.voice-wave-bar:nth-child(3) { animation-delay: 0.2s; }

.ios-titanium { will-change: transform; z-index: 10000; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
.titanium-active { cursor: grabbing !important; z-index: 10010 !important; }
#galvan-top-nav-island { transform-origin: 50% 0%; }
#galvan-notification-hub, #galvan-customize-hub { transform-origin: 50% 50%; }
.ios-titanium.expanded { transform: translate3d(-50%, 0, 0) scale(1) !important; touch-action: manipulation !important; }
#galvan-notification-hub.expanded, #galvan-customize-hub.expanded { transform: translate3d(0, 0, 0) scale(1) !important; }

.qa-search-box { margin: 0 10px 10px 10px; position: relative; height: 36px; opacity: 0; transform: translateY(10px); animation: qaSearchEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.1s forwards; flex-shrink: 0; }
.qa-search-input { width: 100%; height: 100%; background: rgba(118, 118, 128, 0.12); border: none; border-radius: 10px; padding: 0 32px; font-size: 14px; color: var(--current-text-primary); font-weight: 500; outline: none; transition: all 0.2s ease; }
body.light-mode .qa-search-input { background: rgba(0, 0, 0, 0.05); }
.qa-search-input:focus { background: rgba(118, 118, 128, 0.2); box-shadow: 0 0 0 2px var(--current-icon-active); }
.qa-search-input::placeholder { color: var(--current-text-secondary); opacity: 0.6; }
.qa-search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 16px; color: var(--current-text-secondary); opacity: 0.7; pointer-events: none; }
.qa-search-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(120, 120, 120, 0.5); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; visibility: hidden; transition: all 0.2s ease; border: none; }
.qa-search-input:not(:placeholder-shown) + .qa-search-clear { opacity: 1; visibility: visible; }
.qa-no-results { text-align: center; padding: 20px 0; font-size: 0.85rem; color: var(--current-text-secondary); opacity: 0.7; display: none; }

.hello-container { width: 260px; display: flex; justify-content: center; align-items: center; }
.hello-svg { width: 100%; height: auto; overflow: visible; }
.hello-path { fill: none; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 40px; stroke-dasharray: 5800; stroke-dashoffset: 5800; animation: signHello 4s cubic-bezier(0.45, 0, 0.55, 1) forwards; stroke: url(#gradDark); filter: drop-shadow(0 4px 12px rgba(0,0,0,0.15)); }
body.light-mode .hello-path { stroke: url(#gradLight) !important; }
.apple-spinner-wrap { width: 36px; height: 36px; position: relative; opacity: 0; animation: spinnerFadeIn 0.5s ease forwards 0.3s; }
.as-blade { position: absolute; top: 0; left: 16px; width: 4px; height: 10px; border-radius: 2px; background-color: #ffffff; transform-origin: 2px 18px; opacity: 0.1; animation: bladeFade 1s linear infinite; }
body.light-mode .as-blade { background-color: #0f172a; }
.as-blade:nth-child(1) { transform: rotate(0deg); animation-delay: -0.9167s; }
.as-blade:nth-child(2) { transform: rotate(30deg); animation-delay: -0.8333s; }
.as-blade:nth-child(3) { transform: rotate(60deg); animation-delay: -0.7500s; }
.as-blade:nth-child(4) { transform: rotate(90deg); animation-delay: -0.6667s; }
.as-blade:nth-child(5) { transform: rotate(120deg); animation-delay: -0.5833s; }
.as-blade:nth-child(6) { transform: rotate(150deg); animation-delay: -0.5000s; }
.as-blade:nth-child(7) { transform: rotate(180deg); animation-delay: -0.4167s; }
.as-blade:nth-child(8) { transform: rotate(210deg); animation-delay: -0.3333s; }
.as-blade:nth-child(9) { transform: rotate(240deg); animation-delay: -0.2500s; }
.as-blade:nth-child(10) { transform: rotate(270deg); animation-delay: -0.1667s; }
.as-blade:nth-child(11) { transform: rotate(300deg); animation-delay: -0.0833s; }
.as-blade:nth-child(12) { transform: rotate(330deg); animation-delay: 0s; }

.galvan-msg-header { display: flex; justify-content: flex-start; margin-bottom: 6px; padding-left: 4px; opacity: 0; animation: fadeIn 0.5s ease forwards; }
.galvan-sound-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 100px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--current-text-secondary); transition: all 0.2s ease; backdrop-filter: blur(4px); }
.galvan-sound-btn:hover { background: var(--current-icon-active); color: #ffffff; border-color: transparent; transform: scale(1.1); }
.galvan-sound-btn.speaking { background: var(--current-icon-active); color: #ffffff; border-color: transparent; animation: pulse-speaking 1.5s infinite; }
body.light-mode .galvan-sound-btn { background: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.05); color: var(--current-text-secondary); }
body.light-mode .galvan-sound-btn:hover, body.light-mode .galvan-sound-btn.speaking { color: #ffffff; }

.nature-edition { --nature-accent: #4ade80; --nature-dark: #022c22; --nature-glass: rgba(255, 255, 255, 0.1); }
.hub-sector.nature-edition { background: linear-gradient(160deg, rgba(6, 78, 59, 0.4), rgba(2, 44, 34, 0.6)) !important; border: 1px solid rgba(255, 255, 255, 0.05) !important; box-shadow: 0 4px 20px rgba(0,0,0,0.2) !important; transition: all 0.5s ease; overflow: hidden; }
.hub-sector.nature-edition.active { border-color: rgba(74, 222, 128, 0.3) !important; box-shadow: 0 15px 40px -10px rgba(74, 222, 128, 0.15) !important; }
body.light-mode .hub-sector.nature-edition { background: #f0fdf4 !important; border-color: rgba(0,0,0,0.05) !important; }
body.light-mode .hub-sector.nature-edition.active { border-color: #86efac !important; }
.nature-preview { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; cursor: pointer; z-index: 5; position: relative; }
.nature-icon-box { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--nature-accent); background: rgba(74, 222, 128, 0.1); font-size: 20px; }
.nature-info { display: flex; flex-direction: column; }
.nature-label { font-size: 0.7rem; color: var(--nature-accent); font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; }
.nature-ver { font-size: 1.1rem; color: #fff; font-weight: 700; }
body.light-mode .nature-ver { color: #064e3b; }
body.light-mode .nature-icon-box { color: #15803d; background: #dcfce7; }
body.light-mode .nature-label { color: #15803d; }
.nature-badge { font-size: 0.7rem; font-weight: 800; background: var(--nature-accent); color: #064e3b; padding: 4px 10px; border-radius: 100px; }
.nature-deck { height: 180px; background: radial-gradient(circle at bottom, #064e3b 0%, #000 70%); border-radius: 20px; margin: 0 20px 20px 20px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.08); }
body.light-mode .nature-deck { background: radial-gradient(circle at bottom, #bbf7d0 0%, #fff 70%); border-color: rgba(0,0,0,0.05); }
.showcase-btn { position: relative; padding: 14px 32px; font-size: 0.9rem; font-weight: 700; color: white; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 100px; cursor: pointer; z-index: 10; margin-bottom: 20px; --fx-filter: liquid-glass(8, 15) saturate(1.2); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; }
.showcase-btn:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.15); }
.showcase-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: translateX(-100%); transition: transform 0.6s ease; }
.showcase-btn.running::before { animation: shinePass 1.5s infinite; }
.showcase-btn.done { background: #4ade80; color: #064e3b; border-color: transparent; --fx-filter: none; }
.grass-container { position: absolute; bottom: -5px; left: 0; width: 100%; height: 50px; display: flex; justify-content: space-evenly; align-items: flex-end; filter: blur(0.4px); pointer-events: none; }
.blade { width: 4px; background: linear-gradient(to top, #064e3b, #4ade80); border-radius: 50% 50% 0 0; transform-origin: bottom; animation: sway 4s ease-in-out infinite; }
body.light-mode .blade { background: linear-gradient(to top, #166534, #86efac); }
.blade:nth-child(odd) { height: 35px; animation-duration: 3s; }
.blade:nth-child(even) { height: 50px; animation-duration: 5s; animation-delay: 0.5s; }
.bloom { position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; box-shadow: 0 0 10px #fff; animation: float 3s ease-in-out infinite; }
.changelog-list { padding: 0 24px 20px 24px; }
.log-item { display: flex; gap: 12px; margin-bottom: 12px; }
.log-icon { color: var(--nature-accent); margin-top: 3px; }
body.light-mode .log-icon { color: #16a34a; }
.log-content h4 { margin: 0; font-size: 0.9rem; color: #fff; }
.log-content p { margin: 2px 0 0 0; font-size: 0.8rem; color: rgba(255,255,255,0.6); }
body.light-mode .log-content h4 { color: #000; }
body.light-mode .log-content p { color: rgba(0,0,0,0.6); }

.voice-trigger-card { background: var(--current-bg-secondary); border: 1px solid var(--current-border-color); border-radius: 20px; padding: 16px; margin-top: 16px; margin-bottom: 16px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: transform 0.2s ease, background 0.2s; position: relative; overflow: hidden; }
.voice-trigger-card:active { transform: scale(0.97); background: var(--current-bg-tertiary); }
.vt-icon-box { width: 40px; height: 40px; border-radius: 12px; background: rgba(59, 130, 246, 0.15); color: #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 14px; }
.vt-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.vt-title { font-size: 0.95rem; font-weight: 600; color: var(--current-text-primary); }
.vt-value { font-size: 0.8rem; color: var(--current-text-secondary); opacity: 0.8; }
.voice-popup-backdrop { position: fixed; inset: 0; z-index: 10050; background: rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
.voice-popup-backdrop.active { opacity: 1; pointer-events: auto; }
.voice-floating-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px) scale(0.95); width: 90%; max-width: 360px; max-height: 60vh; --fx-filter: blur(3px) liquid-glass(2, 10) saturate(1.2); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 32px; display: flex; flex-direction: column; z-index: 10051; opacity: 0; transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); overflow: hidden; }
.voice-popup-backdrop.active .voice-floating-box { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
body.light-mode .voice-floating-box { background: rgba(255, 255, 255, 0.85); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 20px 50px -10px rgba(0,0,0,0.15); }
.vp-header { padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
body.light-mode .vp-header { border-bottom-color: rgba(0,0,0,0.05); }
.vp-title { font-size: 1rem; font-weight: 700; color: var(--current-text-primary); }
.vp-close { width: 30px; height: 30px; border-radius: 50%; background: rgba(125,125,125,0.15); border: none; color: var(--current-text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
.vp-list { padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
.voice-item { padding: 14px 16px; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; color: var(--current-text-primary); font-size: 0.9rem; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: background 0.2s; }
.voice-item:hover { background: rgba(125,125,125,0.08); }
.voice-item.active { color: #3b82f6; border-color: rgba(59, 130, 246, 0.2); }
.voice-item ion-icon { opacity: 0; transform: scale(0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
.voice-item.active ion-icon { opacity: 1; transform: scale(1); }

@keyframes pulse-stream { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 0.9; transform: scale(1.05); } }
@keyframes dotFillSpring { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.35); opacity: 1; } 100% { transform: scale(1.2); opacity: 1; } }
@keyframes shakeError { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-8px); } 40% { transform: translateX(8px); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } }
@keyframes floatBreathing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
@keyframes pulseRing { 0%, 70%, 100% { box-shadow: none; } }
@keyframes contentStagger { 0% { opacity: 0; transform: translateY(20px) scale(0.96); filter: blur(5px); } 100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }
@keyframes borderGradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
@keyframes aerogelFloatIn { 0% { opacity: 0; transform: translate(-50%, -35%) scale(0.95); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
@keyframes iconScaleIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
@keyframes iconHover { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
@keyframes titleFadeUp { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
@keyframes textShineFlow { to { background-position: 200% center; } }
@keyframes subtitleExpand { 0% { opacity: 0; letter-spacing: 0em; filter: blur(4px); } 100% { opacity: 0.7; letter-spacing: 0.2em; filter: blur(0px); } }
@keyframes gridCardFadeUp { 0% { opacity: 0; transform: translate3d(0, 20px, 0); } 100% { opacity: 1; transform: translate3d(0, 0, 0); } }
@keyframes iosSlideUp { to { opacity: 1; transform: translateY(0); } }
@keyframes springPop { to { opacity: 1; transform: scale(1); } }
@keyframes buttonIdlePulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); border-color: rgba(255, 255, 255, 0.08); } 50% { box-shadow: 0 0 12px 0 rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); border-color: rgba(255, 255, 255, 0.08); } }
@keyframes appleWriteReveal { 0% { -webkit-mask-position: 130%; mask-position: 130%; opacity: 1; } 100% { -webkit-mask-position: 0%; mask-position: 0%; opacity: 1; } }
@keyframes spinnerFloatIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
@keyframes statusFadeIn { 0% { opacity: 0; transform: translateY(5px); } 100% { opacity: 0.7; transform: translateY(0); } }
@keyframes containerSpring { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
@keyframes iosSpinnerSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes fileTabSlideUp { 0% { opacity: 0; transform: translateY(100%) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes galvan-switch-on { 0% { transform: translateX(0) scale(1); width: var(--handle-size); } 40% { transform: translateX(10px) scale(1.1, 0.85); width: calc(var(--handle-size) + 10px); } 80% { transform: translateX(calc(var(--toggle-width) - var(--handle-size) - (var(--handle-padding) * 2) + 2px)) scale(0.95, 1.05); width: var(--handle-size); } 100% { transform: translateX(calc(var(--toggle-width) - var(--handle-size) - (var(--handle-padding) * 2))) scale(1); width: var(--handle-size); } }
@keyframes galvan-switch-off { 0% { transform: translateX(calc(var(--toggle-width) - var(--handle-size) - (var(--handle-padding) * 2))) scale(1); width: var(--handle-size); } 40% { transform: translateX(calc(var(--toggle-width) - var(--handle-size) - (var(--handle-padding) * 2) - 10px)) scale(1.1, 0.85); width: calc(var(--handle-size) + 10px); } 80% { transform: translateX(-2px) scale(0.95, 1.05); width: var(--handle-size); } 100% { transform: translateX(0) scale(1); width: var(--handle-size); } }
@keyframes modalIconFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
@keyframes contentGlideUp { 0% { opacity: 0; transform: translateY(16px) scale(0.97); filter: blur(4px); } 100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }
@keyframes bootTextFadeUp { to { opacity: 1; transform: translateY(0); } }
@keyframes bootGradientShine { to { background-position: 200% center; } }
@keyframes lockHubSlideUp { 0% { transform: translateY(-50px) scale(0.8); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
@keyframes lockPulse { 0% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.3); opacity: 0; } 100% { transform: scale(1); opacity: 0; } }
@keyframes spinRing { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes pulseIcon { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.9); opacity: 0.7; } }
@keyframes rippleEffect { 0% { width: 0; height: 0; opacity: 0.5; } 100% { width: 150px; height: 150px; opacity: 0; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes glassSlideUp { 0% { opacity: 0; transform: translateY(20px) scale(0.98); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes contentFogReveal { 0% { opacity: 0; filter: blur(12px); transform: translateY(10px); } 40% { opacity: 0.6; } 100% { opacity: 1; filter: blur(0px); transform: translateY(0); } }
@keyframes cardGlassReveal { 0% { opacity: 0; transform: translateY(20px) scale(0.94); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes cardGlassHide { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-10px) scale(0.96); } }
@keyframes smoothHubSlideUp { 0% { opacity: 0; transform: translateY(40px) scale(0.98); filter: blur(8px); } 100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }
@keyframes checkSpring { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 60% { transform: scale(1.2) rotate(10deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
@keyframes pickerBreathe { 0%, 100% { box-shadow: none; } 50% { box-shadow: none; } }
@keyframes spinEnter { 0% { opacity: 0; transform: scale(0.5) rotate(-90deg); } 100% { opacity: 1; transform: scale(1) rotate(0deg); } }
@keyframes slideUpList { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
@keyframes wpSpin { to { transform: rotate(360deg); } }
@keyframes checkPop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
@keyframes placeholderGlowRotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes blurReveal { 0% { opacity: 0; filter: blur(10px); transform: translateY(10px); } 100% { opacity: 1; filter: blur(0); transform: translateY(0); } }
@keyframes rippleWave { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.2); opacity: 0; } }
@keyframes iconBreath { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.9); } }
@keyframes soundWave { 0%, 100% { height: 8px; opacity: 0.5; } 50% { height: 16px; opacity: 1; } }
@keyframes qaSearchEnter { to { opacity: 1; transform: translateY(0); } }
@keyframes signHello { 0% { stroke-dashoffset: 5800; fill: transparent; } 90% { stroke-dashoffset: 0; fill: transparent; } 100% { stroke-dashoffset: 0; fill: transparent; } }
@keyframes bladeFade { 0% { opacity: 1; } 100% { opacity: 0.1; } }
@keyframes spinnerFadeIn { to { opacity: 0.7; } }
@keyframes pulse-speaking { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
@keyframes sway { 0%, 100% { transform: rotate(-6deg); } 50% { transform: rotate(6deg); } }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
@keyframes shinePass { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
@keyframes incognitoFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
@keyframes spyIconSwitch { 0% { transform: scale(1) rotate(0deg); } 40% { transform: scale(0.8) rotate(180deg); } 100% { transform: scale(1) rotate(360deg); } }
@keyframes spatialGradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
@keyframes spinCube { from { transform: rotateX(0) rotateY(0); } to { transform: rotateX(360deg) rotateY(360deg); } }
@keyframes metaDotPulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }
@keyframes pulseDot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes fingerPulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 1; } }

@media (max-width: 410px) { .galvan-container { border-radius: 0; } .galvan-confirm-box { width: 82%; padding: 28px 20px 20px; } }
@media (max-width: 380px) { .galvan-top-nav-island { padding: 3px; min-width: 190px; } .nav-island-backdrop { width: calc(50% - 3px); top: 3px; bottom: 3px; left: 3px; } }
@media (max-width: 360px) { .galvan-top-nav-island { min-width: 160px; padding: 3px; height: 44px; } .nav-island-backdrop { top: 3px; bottom: 3px; left: 3px; width: calc(50% - 3px); } .nav-island-btn span { display: none; } .nav-island-btn ion-icon { font-size: 1.3rem; } }
@media (max-width: 320px) { .nav-island-btn span { display: none; } .galvan-top-nav-island { min-width: 130px; } }
@media (max-width: 480px) { .galvan-chat-placeholder { width: 85%; padding: 30px 20px; } .placeholder-title { font-size: 1.8rem; } .placeholder-icon { font-size: 2.8rem; } .placeholder-subtitle { font-size: 0.75rem; } }
@media (max-height: 600px) { :root { --galvan-logo-vertical-gap: 140px; } .galvan-chat-placeholder { top: 55%; padding: 20px; gap: 8px; } .placeholder-title { font-size: 1.5rem; } .placeholder-icon { font-size: 2.2rem; margin-bottom: 5px; } }
@media (max-width: 600px) { .user-message .galvan-message-bubble { border-radius: 24px; padding: 12px 20px; width: auto; min-width: 50%; } }
@media (min-width: 768px) { .galvan-premium-grid { grid-template-columns: repeat(2, 1fr); overflow: visible; max-height: none; } }
@media (max-width: 767px) { .galvan-premium-grid { grid-template-columns: 1fr; max-height: 60vh; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding-bottom: 40px; scrollbar-width: none; } .galvan-premium-grid::-webkit-scrollbar { display: none; height: 10px; } }

</style>
</head>
<body>

<div id="galvan-wallpaper-layer"></div>
<div id="galvan-app-blocker" class="galvan-app-blocker"></div>
<div id="galvan-boot-screen"></div>
<div class="galvan-chat-background-blur"></div>
<div class="galvan-user-image-background-blur"></div>

<div class="galvan-container">
<div id="galvan-top-nav-island" class="galvan-top-nav-island" data-active="home">
<div class="nav-island-backdrop"></div>
<button id="nav-island-home" class="nav-island-btn active">
<ion-icon name="home-outline"></ion-icon>
<span>Home</span>
</button>
<button id="nav-island-chats" class="nav-island-btn">
<ion-icon name="mic-outline"></ion-icon>
<span>Chats</span>
</button>
</div>

<div id="galvan-chat-placeholder" class="galvan-chat-placeholder">
    <div class="placeholder-glow"></div>
    <div class="placeholder-icon-ring">
        <ion-icon name="sparkles" class="placeholder-icon"></ion-icon>
    </div>
    <h2 class="placeholder-title">Galvan AI</h2>
    <p class="placeholder-desc">How can I help you today?</p>
</div>

<div class="galvan-header-bar"></div>

<div class="galvan-main-content">
    <div class="galvan-welcome-screen">
        <h1 class="galvan-user-greeting"></h1>
        <div class="galvan-suggestions-wrapper">
            <div class="galvan-premium-grid" id="suggestions-track"></div>
        </div>
    </div>
    <div class="galvan-chats-container"></div>
</div>

<form class="galvan-prompt-form">
    <div class="vertical-suggestions-container" id="vertical-suggestions">
        <div class="glass-panel-backdrop"></div>
        <div class="suggestions-vertical-list" id="suggestions-list-content"></div>
    </div>
    <div class="galvan-file-upload-wrapper">
        <div class="galvan-file-preview-container">
            <svg class="file-preview-icon-svg" viewBox="0 0 24 24"></svg>
            <img src="#" alt="file preview" class="file-preview" />
            <p class="galvan-file-name">file_name.ext</p>
        </div>
        <button type="button" id="cancel-file-btn" aria-label="Cancel file">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="galvan-attachment-menu" id="attachment-menu">
        <div class="galvan-attachment-list">
            <button type="button" class="attach-option-btn" id="btn-opt-camera">
                <div class="attach-icon-box"><ion-icon name="camera-outline"></ion-icon></div>
                <div class="attach-text-content"><span class="attach-title">Camera</span><span class="attach-desc">Capture photo</span></div>
                <div class="attach-arrow"><ion-icon name="chevron-forward"></ion-icon></div>
            </button>
            <button type="button" class="attach-option-btn" id="btn-opt-gallery">
                <div class="attach-icon-box"><ion-icon name="images-outline"></ion-icon></div>
                <div class="attach-text-content"><span class="attach-title">Gallery</span><span class="attach-desc">Browse photos</span></div>
                <div class="attach-arrow"><ion-icon name="chevron-forward"></ion-icon></div>
            </button>
            <button type="button" class="attach-option-btn" id="btn-opt-files">
                <div class="attach-icon-box"><ion-icon name="folder-open-outline"></ion-icon></div>
                <div class="attach-text-content"><span class="attach-title">Files</span><span class="attach-desc">Upload documents</span></div>
                <div class="attach-arrow"><ion-icon name="chevron-forward"></ion-icon></div>
            </button>
        </div>
    </div>
    <input type="file" id="camera-input" hidden accept="image/*" capture="environment">
    <input type="file" id="gallery-input" hidden accept="image/*">

    <div class="galvan-prompt-container" id="interactive-prompt-container">
        <div class="galvan-shine-layer"></div>
        <div class="galvan-prompt-wrapper">
            <div class="prompt-input-row">
                <textarea class="prompt-input" placeholder="Ask Galvan..." required rows="1"></textarea>
            </div>
            <div class="prompt-controls-row">
                <div class="controls-left">
                    <button type="button" id="add-file-btn" class="prompt-btn" aria-label="Attach file">
                        <span class="icon-add"><ion-icon name="add-outline"></ion-icon></span>
                        <span class="icon-cancel-file"><ion-icon name="close"></ion-icon></span>
                    </button>
                    <button type="button" id="incognito-btn" class="prompt-btn" aria-label="Toggle Incognito">
                        <ion-icon name="shield-half-outline"></ion-icon>
                    </button>
                    <button type="button" id="new-chat-btn" class="prompt-btn" aria-label="New Chat">
                        <ion-icon name="flash-outline"></ion-icon>
                    </button>
                </div>
                <div class="controls-right">
                    <input type="file" id="file-input" hidden accept="image/*,.txt,.pdf,.csv,.doc,.docx,.xls,.xlsx,.rtf,.ppt,.pptx,.key,.pages,.numbers,.zip">
                    <button type="submit" id="send-btn" class="prompt-btn" aria-label="Send message" disabled>
                        <span class="btn-label-text">Cancel</span>
                        <span class="icon-container">
                            <span class="icon-send"><ion-icon name="arrow-up-outline"></ion-icon></span>
                            <span class="icon-stop"><ion-icon name="close"></ion-icon></span>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
</div>

<div id="galvan-customize-hub" class="galvan-notification-hub">
<div class="hub-icon-layer">
<div class="hub-pulse-ring" style="border-color: var(--current-icon-active);"></div>
<ion-icon name="menu-outline"></ion-icon>
</div>
<div class="hub-content-layer">
<div class="hub-sector studio-sector">
<div class="studio-header">
<div class="studio-title-stack">
<span class="studio-label">Customize</span>
</div>
<button id="customize-close-btn" class="hub-action-btn close-btn">
<ion-icon name="close-circle"></ion-icon>
</button>
</div>
<div class="hub-viewport-window" id="hub-viewport">
<div class="hub-views-track" id="hub-track" style="width: 100%;">
<div class="hub-view-pane" id="view-settings" style="width: 100%;">
<div class="customize-scroll-content">
<div class="studio-special-group">
<span class="studio-group-label">THEME REALITY</span>
<div class="galvan-color-palette-container" id="quick-color-palette-options" style="width: 100%;"></div>
</div>
<div id="quick-blur-control-row" class="studio-group" style="display: none;">
<div class="notice-setting-row column-layout">
<div class="row-header-split">
<div class="row-info">
<div class="icon-squircle" style="background: rgba(59, 130, 246, 0.15); color: #3b82f6;">
<ion-icon name="water"></ion-icon>
</div>
<span class="setting-label-small">Blur Depth</span>
</div>
<span id="quick-blur-value" class="value-badge">1.0x</span>
</div>
<div class="galvan-slider-container" style="width: 100%; margin-top: 12px;">
<input type="range" id="quick-blur-slider" min="0" max="2" step="0.1" value="1">
</div>
</div>
</div>
<div class="studio-group">
<div class="notice-setting-row">
<div class="row-info">
<div class="icon-squircle">
<ion-icon name="moon"></ion-icon>
</div>
<span class="setting-label-small">Dark Mode</span>
</div>
<label class="galvan-switch small-switch">
<input type="checkbox" id="quick-toggle-dark-mode">
<div class="slider"></div>
<div class="handle"></div>
</label>
</div>
<div class="notice-setting-row">
<div class="row-info">
<div class="icon-squircle" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
<ion-icon name="bulb"></ion-icon>
</div>
<span class="setting-label-small">Smart Hints</span>
</div>
<label class="galvan-switch small-switch">
<input type="checkbox" id="quick-toggle-suggestions">
<div class="slider"></div>
<div class="handle"></div>
</label>
</div>
</div>
<button id="quick-reset-btn" class="galvan-modal-btn secondary destructive small-reset">
<ion-icon name="refresh-outline"></ion-icon> Factory Reset
</button>
<div class="studio-group premium-glass-group">
<div class="premium-header">
<span class="premium-label">Wallpaper</span>
</div>
<div class="premium-preview-card" id="wp-upload-trigger">
<div class="preview-placeholder">
<div class="preview-icon-stack">
<ion-icon name="image-outline"></ion-icon>
<span id="wp-status-text">Select Image</span>
</div>
<img id="wp-preview-img" src="" style="display: none;">
</div>
<div class="preview-actions">
<button id="wp-upload-btn" class="ios-text-btn">Change</button>
<button id="wp-remove-btn" class="ios-text-btn destructive" style="display: none;">Remove</button>
</div>
</div>
<input type="file" id="wp-file-input" hidden accept="image/*">
<div class="premium-slider-section" id="wp-blur-section" style="opacity: 0.5; pointer-events: none;">
<div class="slider-header">
<span class="slider-label">Blur Effect</span>
<span id="wp-blur-val" class="slider-value">0%</span>
</div>
<div class="ios-slider-container">
<ion-icon name="water-outline" class="slider-icon small"></ion-icon>
<div class="slider-track-wrapper">
<input type="range" id="wp-blur-slider" min="0" max="100" step="1" value="0">
<div class="slider-ticks"></div>
</div>
<ion-icon name="water" class="slider-icon large"></ion-icon>
</div>
<p class="premium-caption">Increasing blur will reduce the wallpaper detail but improve chat readability.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="galvan-notification-hub" class="galvan-notification-hub">
<div class="hub-icon-layer">
<div class="hub-pulse-ring"></div>
<ion-icon name="notifications-outline"></ion-icon>
<div id="hub-badge-count" class="hub-badge">0</div>
</div>
<div class="hub-contents-layer">
<div class="hub-sector system-sector">
<div class="sector-header">
<span class="sector-label">General Messages</span>
<div class="sector-actions">
<button id="hub-mark-read-btn" class="hub-action-btn tick-btn" aria-label="Clear All">
<ion-icon name="checkmark-done-outline"></ion-icon>
</button>
<button id="hub-close-btn" class="hub-action-btn close-btn" aria-label="Close">
<ion-icon name="close-circle"></ion-icon>
</button>
</div>
</div>
<div id="hub-message-list" class="sector-body-list">
<div class="hub-empty-state">System initialized.</div>
</div>
</div>
<div id="hub-notice-sector" class="hub-sector notice-sector spatial-edition" data-notice-version="GOS 26.4(RC)">
<div class="spatial-preview" id="notice-trigger">
<div class="preview-left">
<div class="sys-icon-box">
<div class="icon-core">
<ion-icon name="cog-outline"></ion-icon>
</div>
</div>
<div class="sys-info">
<span class="sys-label">Changelog</span>
<span class="sys-ver">GOS 26.4</span>
</div>
</div>
<div class="preview-right">
<div class="status-pill">
<span class="pill-dot"></span>
<span>RC(final)</span>
</div>
</div>
<div class="scan-line"></div>
</div>
<div class="spatial-content-wrapper">
<div class="spatial-inner">
<div class="holo-deck">
<div class="holo-grid-bg"></div>
<div class="holo-obj">
<div class="cube-spinner">
<div class="face front"></div>
<div class="face back"></div>
<div class="face right"></div>
<div class="face left"></div>
<div class="face top"></div>
<div class="face bottom"></div>
</div>
</div>
<div class="holo-meta">
<h3>Galvan Ai</h3>
<p>Major Upgrade</p>
</div>
</div>
<div class="tech-specs-row">
<div class="spec-chip">
<span class="spec-key">Type</span>
<span class="spec-val">RC</span>
</div>
<div class="spec-chip">
<span class="spec-key">Build</span>
<span class="spec-val">26.2.1</span>
</div>
<div class="spec-chip">
<span class="spec-key">Version</span>
<span class="spec-val">26b7fg45a</span>
</div>
</div>
<div class="feature-manifest">
<div class="manifest-item">
<ion-icon name="hardware-chip-outline"></ion-icon>
<span>UI With Liquid Glass</span>
</div>
<div class="manifest-item">
<ion-icon name="wifi-outline"></ion-icon>
<span>Smooth Conversations</span>
</div>
<div class="manifest-item">
<ion-icon name="color-wand-outline"></ion-icon>
<span>Optimisations and Security Fixes</span>
</div>
</div>
<div class="interaction-zone">
<button id="spatial-install-btn" class="hold-trigger-btn">
<div class="hold-track">
<div class="hold-progress"></div>
</div>
<div class="hold-label">
<ion-icon name="speedometer-outline" class="finger-outline"></ion-icon>
<span class="label-text">Hold to Optimise</span>
</div>
<div class="success-layer">
<ion-icon name="checkmark-done-circle"></ion-icon>
<span>Optimised</span>
</div>
</button>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="quick-actions-hub" class="quick-actions-hub">
<div class="qa-backdrop-layer"></div>
<div class="qa-content-layer">
<div class="qa-action-row">
<div class="qa-quick-action" id="qa-add-page" style="--delay: 0s">
<div class="qa-icon-circle" style="background: rgba(16, 185, 129, 0.15); color: #10b981; border-color: rgba(16, 185, 129, 0.2);">
<ion-icon name="add-circle-outline"></ion-icon>
</div>
<span>New Page</span>
</div>
<div class="qa-quick-action" id="qa-clear" style="--delay: 0.05s">
<div class="qa-icon-circle destructive"><ion-icon name="trash-outline"></ion-icon></div>
<span>Clear</span>
</div>
<div class="qa-quick-action" id="qa-close" style="--delay: 0.1s">
<div class="qa-icon-circle"><ion-icon name="close-circle-outline"></ion-icon></div>
<span>Close</span>
</div>
</div>
<div class="qa-divider"></div>
<div class="qa-scroll-view" id="qa-list"></div>
</div>
</div>

<div id="galvan-reset-overlay">
<div class="reset-hud-container">
<svg class="apple-spinner-svg" viewBox="0 0 50 50">
<g transform="translate(25,25)">
<line y1="-12" y2="-21" transform="rotate(0)"></line>
<line y1="-12" y2="-21" transform="rotate(30)"></line>
<line y1="-12" y2="-21" transform="rotate(60)"></line>
<line y1="-12" y2="-21" transform="rotate(90)"></line>
<line y1="-12" y2="-21" transform="rotate(120)"></line>
<line y1="-12" y2="-21" transform="rotate(150)"></line>
<line y1="-12" y2="-21" transform="rotate(180)"></line>
<line y1="-12" y2="-21" transform="rotate(210)"></line>
<line y1="-12" y2="-21" transform="rotate(240)"></line>
<line y1="-12" y2="-21" transform="rotate(270)"></line>
<line y1="-12" y2="-21" transform="rotate(300)"></line>
<line y1="-12" y2="-21" transform="rotate(330)"></line>
</g>
</svg>
<div class="reset-info-wrapper">
<h2 class="reset-title">Resetting Galvan</h2>
<div id="reset-status-log" class="reset-status-log">Processing...</div>
<div class="reset-progress-track">
<div id="reset-progress-fill" class="reset-progress-fill"></div>
</div>
</div>
</div>
</div>

<div id="galvan-confirm-modal">
<div class="galvan-confirm-box">
<div class="galvan-confirm-icon">
<ion-icon name="alert-circle"></ion-icon>
</div>
<h3 id="galvan-confirm-title">Confirm</h3>
<p id="galvan-confirm-text">Are you sure you want to proceed?</p>
<div class="galvan-confirm-actions">
<button id="galvan-btn-cancel" class="galvan-modal-btn secondary">Cancel</button>
<button id="galvan-btn-confirm" class="galvan-modal-btn primary">Confirm</button>
</div>
</div>
</div>

<div id="galvan-lock-hub" class="galvan-lock-hub">
<div class="lock-icon-layer">
<div class="lock-pulse-ring"></div>
<ion-icon name="lock-closed" class="lock-main-icon"></ion-icon>
<div class="lock-badge-indicator"></div>
</div>
<div class="lock-content-layer">
<div id="lock-internal-loader" class="lock-internal-loader" style="display: none;">
<div class="reset-spinner-container">
<div class="reset-ripple"></div>
<div class="reset-ring"></div>
<ion-icon name="shield-checkmark" class="reset-shield-icon"></ion-icon>
</div>
<h4 id="lock-loader-text" style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--current-text-primary);">System Reset</h4>
<span id="lock-loader-sub" style="font-size: 0.85rem; color: var(--current-text-secondary); opacity: 0.8; margin-top: 8px;">Processing security wipe...</span>
</div>
<div class="lock-header-section">
<div class="lock-status-icon-wrapper">
<ion-icon name="shield-checkmark" class="status-shield"></ion-icon>
</div>
<div class="lock-text-stack">
<h3 id="pin-status-text">Security</h3>
<span id="pin-sub-text">Enter Passcode</span>
</div>
<button id="lock-close-btn" class="hub-action-btn close-btn">
<ion-icon name="close-circle"></ion-icon>
</button>
</div>
<div class="pin-interface-wrapper">
<div class="pin-dots-container" id="pin-dots">
<div class="pin-dot"></div>
<div class="pin-dot"></div>
<div class="pin-dot"></div>
<div class="pin-dot"></div>
</div>
<div class="pin-numpad-grid">
<button class="pin-key" data-val="1">1</button>
<button class="pin-key" data-val="2">2</button>
<button class="pin-key" data-val="3">3</button>
<button class="pin-key" data-val="4">4</button>
<button class="pin-key" data-val="5">5</button>
<button class="pin-key" data-val="6">6</button>
<button class="pin-key" data-val="7">7</button>
<button class="pin-key" data-val="8">8</button>
<button class="pin-key" data-val="9">9</button>
<button class="pin-key action delete" id="pin-del">
<ion-icon name="backspace"></ion-icon>
</button>
<button class="pin-key" data-val="0">0</button>
<button class="pin-key action confirm" id="pin-enter">
<ion-icon name="arrow-forward"></ion-icon>
</button>
</div>
<button id="biometric-btn" class="biometric-toggle-btn" style="display: none;">
<ion-icon name="finger-print-outline"></ion-icon>
<span>Use Biometrics</span>
</button>
<button id="lock-reset-flow" class="lock-text-link">Forgot Passcode?</button>
</div>
</div>
</div>

</body>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script>
const container = document.querySelector(".galvan-container");
const body = document.body;
const chatsContainer = document.querySelector(".galvan-chats-container");
const promptForm = document.querySelector(".galvan-prompt-form");
const promptWrapper = promptForm.querySelector(".galvan-prompt-wrapper");
const promptInput = promptForm.querySelector(".prompt-input");
const fileInput = promptForm.querySelector("#file-input");
const fileUploadWrapper = promptForm.querySelector(".galvan-file-upload-wrapper");
const filePreviewIconSVG = fileUploadWrapper.querySelector(".file-preview-icon-svg");
const filePreviewImage = fileUploadWrapper.querySelector(".file-preview");
const fileNameElement = fileUploadWrapper.querySelector(".galvan-file-name");
const cancelFileBtn = document.querySelector("#cancel-file-btn");
const themeToggleBtn = document.querySelector("#theme-toggle-btn");
const addFileBtn = promptForm.querySelector("#add-file-btn");
const mainContent = document.querySelector('.galvan-main-content');
const welcomeScreen = document.querySelector('.galvan-welcome-screen');
const suggestionsWrapper = document.querySelector('.galvan-suggestions-wrapper');
const suggestionsContainer = document.querySelector('.galvan-suggestions');
const navIslandContainer = document.getElementById('galvan-top-nav-island');
const navIslandHomeBtn = document.getElementById('nav-island-home');
const navIslandChatsBtn = document.getElementById('nav-island-chats');
const chatPlaceholder = document.getElementById('galvan-chat-placeholder');
const sendBtn = promptForm.querySelector('#send-btn');
const resetOverlay = document.getElementById('galvan-reset-overlay');
const userGreeting = document.querySelector('.galvan-user-greeting');
const chatBackgroundBlur = document.querySelector('.galvan-chat-background-blur');
const userImageBackgroundBlur = document.querySelector('.galvan-user-image-background-blur');
const settingToggleSuggestionsSwitch = document.querySelector('#quick-toggle-suggestions');
const settingToggleDarkModeSwitch = document.querySelector('#quick-toggle-dark-mode');
const settingToggleSystemThemeSwitch = document.getElementById('setting-toggle-system-theme');
const settingBlurSliderItem = document.getElementById('quick-blur-control-row');
const settingBlurSlider = document.querySelector('#quick-blur-slider');
const blurSliderValueDisplay = document.querySelector('#quick-blur-value');
const blurControlNotice = document.getElementById('blur-control-notice');
const settingResetAllBtn = document.querySelector('#quick-reset-btn');
const settingToggleAttachmentsSwitch = document.querySelector('#setting-toggle-attachments');
const settingToggleAutoUpdateSwitch = document.querySelector('#setting-toggle-auto-update');
const colorPaletteOptionsContainer = document.getElementById('color-palette-options');

let userPromptsHistory = [];
let promptHistoryIndex = -1;
const historyHub = document.getElementById('galvan-history-hub');
const API_KEY = "AIzaSyDNnHcliJ2T4--B1mBL8k8iowqFKQchvP4";
const IS_API_KEY_VALID = API_KEY && API_KEY !== "YOUR_API_KEY_HERE" && API_KEY.length > 30;
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
const STORAGE_KEY = 'galvanAi_v30_settings';
let controller, typingInterval, thinkingTimeout, toastTimeout, scrollTimeout;
let longPressTimeout, isLongPress = false, messageBeingEditedTimestamp = null;
let appSettings = {};
let currentChatSession = [];
const userData = { message: "", file: {} };
const isLocalStorageAvailable = (() => { try { localStorage.setItem('_test', '1'); localStorage.removeItem('_test'); return true; } catch (e) { return false; } })();
let messageCounter = 0;
const CURRENT_APP_VERSION_FOR_NOTICE = "";
let currentThemeIsLight = true;
const baseThemeVariables = { light: {}, dark: {} };
const paletteVariableMap = {
  appBodyBg: 'body-bg',
  appBgPrimary: 'bg-primary',
  appBgSecondary: 'bg-secondary',
  appBgTertiary: 'bg-tertiary',
  appTextPrimary: 'text-primary',
  appTextSecondary: 'text-secondary',
  appTextPlaceholder: 'text-placeholder',
  appBorderColor: 'border-color',
  appIconPrimary: 'icon-primary',
  appIconActive: 'icon-active',
  appIconStatic: 'icon-static',
  appUserMsgBg: 'user-msg-bg',
  appBotMsgBg: 'bot-msg-bg',
  appLogoStop1: 'logo-stop-1',
  appLogoStop2: 'logo-stop-2',
  appLogoStop3: 'logo-stop-3',
  appLogoGlowColor: 'logo-glow-color',
  appWaveColor: 'wave-color',
  appLogoBlurGrad: 'logo-blur-grad',
  appGreetingGrad: 'greeting-grad'
};

function captureBaseThemeVariables() {
  const root = document.documentElement;
  Object.keys(paletteVariableMap).forEach(paletteKey => {
    const cssSuffix = paletteVariableMap[paletteKey];
    baseThemeVariables.light[`--app-${cssSuffix}-light`] = getComputedStyle(root).getPropertyValue(`--app-${cssSuffix}-light`).trim();
    baseThemeVariables.dark[`--app-${cssSuffix}-dark`] = getComputedStyle(root).getPropertyValue(`--app-${cssSuffix}-dark`).trim();
  });
}

const COLOR_PALETTES = [
  { id: 'galvan', name: 'Galvan Glass', isDefault: true, preview: { bg: 'transparent', bubble: 'linear-gradient(135deg, #2563EB, #1d4ed8)', accent1: '#3B82F6', accent2: '#93C5FD' },
    light: { appBodyBg: '#f0f4ff', appBgPrimary: '#f0f4ff00', appBgSecondary: 'rgba(255, 255, 255, 0.6)', appBgTertiary: 'rgba(255, 255, 255, 0.4)', appTextPrimary: '#0f172a', appTextSecondary: '#334155', appTextPlaceholder: '#64748b', appBorderColor: 'rgba(59, 130, 246, 0.2)', appIconPrimary: '#2563eb', appIconActive: '#1d4ed8', appIconStatic: '#93c5fd', appUserMsgBg: 'linear-gradient(135deg, #2563eb, #1d4ed8)', appBotMsgBg: 'rgba(255, 255, 255, 0.4)', appLogoStop1: '#93c5fd', appLogoStop2: '#3b82f6', appLogoStop3: '#1d4ed8', appLogoGlowColor: '#60a5fa', appWaveColor: 'rgba(37, 99, 235, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #1d4ed8, #3b82f6)' },
    dark: { appBodyBg: '#0f172a', appBgPrimary: '#0f172a00', appBgSecondary: 'rgba(30, 41, 59, 0.6)', appBgTertiary: 'rgba(51, 65, 85, 0.4)', appTextPrimary: '#f8fafc', appTextSecondary: '#cbd5e1', appTextPlaceholder: '#94a3b8', appBorderColor: 'rgba(148, 163, 184, 0.1)', appIconPrimary: '#60a5fa', appIconActive: '#3b82f6', appIconStatic: '#1e293b', appUserMsgBg: 'linear-gradient(135deg, #3b82f6, #2563eb)', appBotMsgBg: 'rgba(0, 0, 0, 0.2)', appLogoStop1: '#1e40af', appLogoStop2: '#3b82f6', appLogoStop3: '#93c5fd', appLogoGlowColor: '#3b82f6', appWaveColor: 'rgba(59, 130, 246, 0.1)', appGreetingGrad: 'linear-gradient(120deg, #3b82f6, #60a5fa)' } },
  { id: 'frosted_rose', name: 'Frosted Rose', preview: { bg: '#4a044e', bubble: 'linear-gradient(135deg, #ec4899, #be185d)', accent1: '#f472b6', accent2: '#fbcfe8' },
    light: { appBodyBg: '#fff1f2', appBgPrimary: '#fff1f200', appBgSecondary: 'rgba(255, 255, 255, 0.6)', appBgTertiary: 'rgba(255, 228, 230, 0.5)', appTextPrimary: '#881337', appTextSecondary: '#9f1239', appTextPlaceholder: '#fb7185', appBorderColor: 'rgba(244, 63, 94, 0.2)', appIconPrimary: '#e11d48', appIconActive: '#be123c', appIconStatic: '#fda4af', appUserMsgBg: 'linear-gradient(135deg, #f43f5e, #e11d48)', appBotMsgBg: 'rgba(255, 255, 255, 0.5)', appLogoStop1: '#fbcfe8', appLogoStop2: '#f472b6', appLogoStop3: '#db2777', appLogoGlowColor: '#fb7185', appWaveColor: 'rgba(225, 19, 72, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #be123c, #f43f5e)' },
    dark: { appBodyBg: '#2e0215', appBgPrimary: '#2e021500', appBgSecondary: 'rgba(131, 24, 67, 0.15)', appBgTertiary: 'rgba(80, 7, 36, 0.3)', appTextPrimary: '#ffe4e6', appTextSecondary: '#fbcfe8', appTextPlaceholder: '#f472b6', appBorderColor: 'rgba(244, 114, 182, 0.15)', appIconPrimary: '#f472b6', appIconActive: '#ec4899', appIconStatic: '#831843', appUserMsgBg: 'linear-gradient(135deg, #db2777, #9d174d)', appBotMsgBg: 'rgba(60, 5, 25, 0.4)', appLogoStop1: '#fbcfe8', appLogoStop2: '#ec4899', appLogoStop3: '#831843', appLogoGlowColor: '#f472b6', appWaveColor: 'rgba(236, 72, 153, 0.1)', appGreetingGrad: 'linear-gradient(120deg, #db2777, #fbcfe8)' } },
  { id: 'aurora_borealis', name: 'Aurora Glass', preview: { bg: '#022c22', bubble: 'linear-gradient(135deg, #059669, #34d399)', accent1: '#34d399', accent2: '#a7f3d0' },
    light: { appBodyBg: '#f0fdf4', appBgPrimary: '#f0fdf400', appBgSecondary: 'rgba(255, 255, 255, 0.7)', appBgTertiary: 'rgba(220, 252, 231, 0.5)', appTextPrimary: '#064e3b', appTextSecondary: '#059669', appTextPlaceholder: '#34d399', appBorderColor: 'rgba(16, 185, 129, 0.2)', appIconPrimary: '#059669', appIconActive: '#047857', appIconStatic: '#6ee7b7', appUserMsgBg: 'linear-gradient(135deg, #10b981, #059669)', appBotMsgBg: 'rgba(255, 255, 255, 0.5)', appLogoStop1: '#6ee7b7', appLogoStop2: '#10b981', appLogoStop3: '#047857', appLogoGlowColor: '#34d399', appWaveColor: 'rgba(16, 185, 129, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #059669, #34d399)' },
    dark: { appBodyBg: '#02040a', appBgPrimary: '#02040a00', appBgSecondary: 'rgba(255, 255, 255, 0.04)', appBgTertiary: 'rgba(255, 255, 255, 0.02)', appTextPrimary: '#ccfbf1', appTextSecondary: '#5eead4', appTextPlaceholder: '#2dd4bf', appBorderColor: 'rgba(45, 212, 191, 0.1)', appIconPrimary: '#2dd4bf', appIconActive: '#14b8a6', appIconStatic: '#134e4a', appUserMsgBg: 'linear-gradient(135deg, #0f766e, #115e59)', appBotMsgBg: 'rgba(0, 0, 0, 0.3)', appLogoStop1: '#115e59', appLogoStop2: '#14b8a6', appLogoStop3: '#5eead4', appLogoGlowColor: '#2dd4bf', appWaveColor: 'rgba(20, 184, 166, 0.1)', appGreetingGrad: 'linear-gradient(120deg, #14b8a6, #5eead4)' } },
  { id: 'purple_haze', name: 'Purple Haze', preview: { bg: '#2e1065', bubble: 'linear-gradient(135deg, #7c3aed, #6d28d9)', accent1: '#a78bfa', accent2: '#ddd6fe' },
    light: { appBodyBg: '#f5f3ff', appBgPrimary: '#f5f3ff00', appBgSecondary: 'rgba(255, 255, 255, 0.65)', appBgTertiary: 'rgba(237, 233, 254, 0.5)', appTextPrimary: '#4c1d95', appTextSecondary: '#6d28d9', appTextPlaceholder: '#8b5cf6', appBorderColor: 'rgba(139, 92, 246, 0.2)', appIconPrimary: '#7c3aed', appIconActive: '#6d28d9', appIconStatic: '#c4b5fd', appUserMsgBg: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', appBotMsgBg: 'rgba(255, 255, 255, 0.5)', appLogoStop1: '#c4b5fd', appLogoStop2: '#8b5cf6', appLogoStop3: '#6d28d9', appLogoGlowColor: '#a78bfa', appWaveColor: 'rgba(124, 58, 237, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #6d28d9, #8b5cf6)' },
    dark: { appBodyBg: '#170c2e', appBgPrimary: '#170c2e00', appBgSecondary: 'rgba(139, 92, 246, 0.08)', appBgTertiary: 'rgba(109, 40, 217, 0.15)', appTextPrimary: '#ede9fe', appTextSecondary: '#c4b5fd', appTextPlaceholder: '#a78bfa', appBorderColor: 'rgba(167, 139, 250, 0.25)', appIconPrimary: '#a78bfa', appIconActive: '#c4b5fd', appIconStatic: '#5b21b6', appUserMsgBg: 'linear-gradient(135deg, #7c3aed, #5b21b6)', appBotMsgBg: 'rgba(23, 12, 46, 0.6)', appLogoStop1: '#6d28d9', appLogoStop2: '#8b5cf6', appLogoStop3: '#c4b5fd', appLogoGlowColor: '#8b5cf6', appWaveColor: 'rgba(139, 92, 246, 0.12)', appGreetingGrad: 'linear-gradient(120deg, #a78bfa, #c4b5fd)' } },
  { id: 'citrus_glass', name: 'Citrus Glass', preview: { bg: '#431407', bubble: 'linear-gradient(135deg, #ea580c, #c2410c)', accent1: '#fb923c', accent2: '#fed7aa' },
    light: { appBodyBg: '#fff7ed', appBgPrimary: '#fff7ed00', appBgSecondary: 'rgba(255, 255, 255, 0.6)', appBgTertiary: 'rgba(255, 237, 213, 0.5)', appTextPrimary: '#7c2d12', appTextSecondary: '#c2410c', appTextPlaceholder: '#f97316', appBorderColor: 'rgba(249, 115, 22, 0.2)', appIconPrimary: '#ea580c', appIconActive: '#c2410c', appIconStatic: '#fdba74', appUserMsgBg: 'linear-gradient(135deg, #f97316, #ea580c)', appBotMsgBg: 'rgba(255, 255, 255, 0.5)', appLogoStop1: '#fdba74', appLogoStop2: '#f97316', appLogoStop3: '#c2410c', appLogoGlowColor: '#fb923c', appWaveColor: 'rgba(249, 115, 22, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #c2410c, #f97316)' },
    dark: { appBodyBg: '#1a0a04', appBgPrimary: '#1a0a0400', appBgSecondary: 'rgba(255, 255, 255, 0.05)', appBgTertiary: 'rgba(255, 255, 255, 0.03)', appTextPrimary: '#ffedd5', appTextSecondary: '#fdba74', appTextPlaceholder: '#fb923c', appBorderColor: 'rgba(251, 146, 60, 0.1)', appIconPrimary: '#fb923c', appIconActive: '#f97316', appIconStatic: '#7c2d12', appUserMsgBg: 'linear-gradient(135deg, #ea580c, #c2410c)', appBotMsgBg: 'rgba(0, 0, 0, 0.3)', appLogoStop1: '#7c2d12', appLogoStop2: '#ea580c', appLogoStop3: '#fb923c', appLogoGlowColor: '#f97316', appWaveColor: 'rgba(249, 115, 22, 0.1)', appGreetingGrad: 'linear-gradient(120deg, #f97316, #fdba74)' } }
];

const getDefaultSettings = () => ({
  themeMode: 'light',
  showSuggestions: true,
  showAiThoughts: true,
  vvImage: null,
  blurIntensity: 1.0,
  lastSeenNotice: "0.0.0",
  vvShape: 'circle',
  fontFamily: 'default',
  fontSize: '16px',
  enableAttachments: true,
  autoUpdate: true,
  colorPalette: 'galvan',
  customSuggestions: [],
  chatHistory: []
});

const loadSettings = () => {
  if (!isLocalStorageAvailable) {
    appSettings = getDefaultSettings();
    return;
  }
  try {
    const storedSettings = JSON.parse(localStorage.getItem(STORAGE_KEY));
    appSettings = { ...getDefaultSettings(), ...storedSettings };
  } catch (e) {
    appSettings = getDefaultSettings();
  }
};

const saveSettings = () => {
  if (!isLocalStorageAvailable) return;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appSettings));
};

const getUserData = (key) => appSettings[key];
const setUserData = (key, value) => {
  appSettings[key] = value;
  saveSettings();
};

const hub = document.getElementById('galvan-notification-hub');
const hubBadgeCount = document.getElementById('hub-badge-count');
const hubMessageList = document.getElementById('hub-message-list');
const hubMarkReadBtn = document.getElementById('hub-mark-read-btn');
const hubCloseBtn = document.getElementById('hub-close-btn');
const hubNoticeSector = document.getElementById('hub-notice-sector');

let systemMessagesQueue = [];
let isNoticeUnread = false;

const updateHubBadge = () => {
  if (!hub || !hubBadgeCount) return;
  let totalCount = systemMessagesQueue.length;
  if (isNoticeUnread) totalCount++;
  hubBadgeCount.textContent = totalCount > 9 ? '9+' : totalCount;
  if (totalCount > 0) {
    hub.classList.add('has-unread');
    if (!hub.classList.contains('expanded')) hub.classList.add('pulsing');
  } else {
    hub.classList.remove('has-unread', 'pulsing');
  }
};

const showSystemMessage = (message) => {
  if (!hubMessageList) return;
  systemMessagesQueue.push(message);
  if (systemMessagesQueue.length > 10) systemMessagesQueue.shift();
  renderMessageList();
  updateHubBadge();
};
const renderMessageList = () => {
  hubMessageList.innerHTML = '';
  if (systemMessagesQueue.length === 0) {
    hubMessageList.innerHTML = '<div class="hub-empty-state">No new messages</div>';
    return;
  }
  [...systemMessagesQueue].reverse().forEach((msg, index) => {
    const div = document.createElement('div');
    div.className = 'hub-msg-item';
    div.style.animationDelay = `${index * 0.05}s`;
    div.innerHTML = `<span class="msg-dot"></span><span class="msg-text">${msg}</span>`;
    hubMessageList.appendChild(div);
  });
};

const checkForUpdates = () => {
  if (!hubNoticeSector) return;
  const currentVersion = hubNoticeSector.getAttribute('data-notice-version');
  const lastSeenVersion = localStorage.getItem('galvan_notice_seen_version');
  const newBadge = hubNoticeSector.querySelector('.new-badge');
  hubNoticeSector.style.display = 'block';
  if (currentVersion && currentVersion !== lastSeenVersion) {
    isNoticeUnread = true;
    if (newBadge) newBadge.style.display = 'inline-block';
    hubNoticeSector.classList.add('is-unread');
  } else {
    isNoticeUnread = false;
    if (newBadge) newBadge.style.display = 'none';
    hubNoticeSector.classList.remove('is-unread');
  }
  updateHubBadge();
};

if (hubMarkReadBtn) {
  hubMarkReadBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    systemMessagesQueue = [];
    renderMessageList();
    updateHubBadge();
    hubMarkReadBtn.style.color = "#34D399";
    setTimeout(() => {
      hub.classList.remove('expanded');
      hubMarkReadBtn.style.color = "";
    }, 400);
  });
}

if (hubNoticeSector) {
  const noticeTrigger = document.getElementById('notice-trigger');
  if (noticeTrigger) {
    const newTrigger = noticeTrigger.cloneNode(true);
    noticeTrigger.parentNode.replaceChild(newTrigger, noticeTrigger);
    newTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isActive = hubNoticeSector.classList.toggle('active');
      if (isActive && isNoticeUnread) {
        const currentVersion = hubNoticeSector.getAttribute('data-notice-version');
        localStorage.setItem('galvan_notice_seen_version', currentVersion);
        isNoticeUnread = false;
        const newBadge = hubNoticeSector.querySelector('.new-badge');
        if (newBadge) newBadge.style.display = 'none';
        hubNoticeSector.classList.remove('is-unread');
        updateHubBadge();
      }
    });
  }
}

if (hub) {
  hub.addEventListener('click', (e) => {
    if (e.target.closest('button') || e.target.closest('.notice-sector')) return;
    if (!hub.classList.contains('expanded')) {
      hub.classList.add('expanded');
      hub.classList.remove('pulsing');
    }
  });
}

if (hubCloseBtn) {
  hubCloseBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    hub.classList.remove('expanded');
  });
}

const newAutoUpdateSwitch = document.getElementById('setting-toggle-auto-update');
if (newAutoUpdateSwitch) {
  newAutoUpdateSwitch.addEventListener('change', (e) => {
    setUserData('autoUpdate', e.target.checked);
  });
}

renderMessageList();
checkForUpdates();

const showTemporaryToast = showSystemMessage;

const smartScrollToBottom = (container) => {
  if (!container) return;
  const threshold = 50;
  const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight <= threshold;
  if (isAtBottom) {
    requestAnimationFrame(() => {
      container.scrollTo({ top: container.scrollHeight, behavior: 'auto' });
    });
  }
};

const scrollToBottom = (behavior = "smooth") => {
  if (!chatsContainer) return;
  const isUserAtBottom = chatsContainer.scrollHeight - chatsContainer.scrollTop <= chatsContainer.clientHeight + 150;
  if (isUserAtBottom || behavior === "auto") {
    chatsContainer.scrollTo({ top: chatsContainer.scrollHeight, behavior: behavior });
  }
};

const updateBlurControlVisibility = () => {
  const hasUserImage = body.classList.contains('user-bg-active');
  if (settingBlurSliderItem) settingBlurSliderItem.style.display = 'flex';
  if (settingBlurSlider) settingBlurSlider.style.display = hasUserImage ? 'block' : 'none';
  if (blurSliderValueDisplay) blurSliderValueDisplay.style.display = hasUserImage ? 'block' : 'none';
  if (blurControlNotice) blurControlNotice.style.display = hasUserImage ? 'none' : 'block';
};

function _goHome(animateSuggestions = true) {
  body.classList.remove('chats-active', 'suggestions-scrolled');
  if (body.classList.contains("bot-responding")) stopResponseGeneration();
  updateTopNavVisuals('home');
  if (chatPlaceholder) chatPlaceholder.classList.remove('visible');
  if (suggestionsContainer && animateSuggestions && !body.classList.contains('hide-suggestions')) {
    suggestionsContainer.scrollTo({ top: 0, behavior: 'smooth' });
    suggestionsContainer.style.animation = 'none';
    void suggestionsContainer.offsetWidth;
    suggestionsContainer.style.animation = 'suggestionsEnterNew 1s var(--ease-soft-spring) 0.2s both';
  }
  messageBeingEditedTimestamp = null;
}

const resizeImage = (file, maxWidth, maxHeight, quality, callback) => {
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      let width = img.width;
      let height = img.height;
      if (width > height) {
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width *= maxHeight / height;
          height = maxHeight;
        }
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      callback(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
};

document.addEventListener('click', (e) => {
  if (e.target.closest('.copy-code-btn')) {
    const btn = e.target.closest('.copy-code-btn');
    const wrapper = btn.closest('.galvan-code-wrapper');
    const codeElement = wrapper.querySelector('code');
    if (!codeElement || btn.classList.contains('success')) return;
    const codeText = codeElement.textContent;
    const icon = btn.querySelector('ion-icon');
    const originalIconName = icon.getAttribute('name');
    navigator.clipboard.writeText(codeText).then(() => {
      btn.classList.add('success');
      icon.style.opacity = '0';
      icon.style.transform = 'scale(0.5) rotate(-45deg)';
      setTimeout(() => {
        icon.setAttribute('name', 'checkmark-circle');
        icon.style.opacity = '1';
        icon.style.transform = 'scale(1.2) rotate(0deg)';
      }, 150);
      setTimeout(() => {
        icon.style.opacity = '0';
        icon.style.transform = 'scale(0.5) rotate(45deg)';
        setTimeout(() => {
          btn.classList.remove('success');
          icon.setAttribute('name', originalIconName);
          icon.style.opacity = '1';
          icon.style.transform = 'scale(1) rotate(0deg)';
        }, 150);
      }, 2000);
    });
  }

  if (e.target.closest('.download-code-btn')) {
    const btn = e.target.closest('.download-code-btn');
    const wrapper = btn.closest('.galvan-code-wrapper');
    const codeElement = wrapper.querySelector('code');
    if (!codeElement || btn.classList.contains('success')) return;
    const lang = btn.dataset.lang || 'txt';
    const codeText = codeElement.textContent;
    const icon = btn.querySelector('ion-icon');
    const originalIconName = icon.getAttribute('name');
    btn.classList.add('success');
    icon.style.opacity = '0';
    icon.style.transform = 'translateY(10px)';
    setTimeout(() => {
      icon.setAttribute('name', 'checkmark-circle');
      icon.style.opacity = '1';
      icon.style.transform = 'translateY(0)';
    }, 150);
    const extensionMap = { 'javascript': 'js', 'python': 'py', 'html': 'html', 'css': 'css', 'json': 'json', 'text': 'txt' };
    const ext = extensionMap[lang.toLowerCase()] || lang || 'txt';
    const fileName = `galvan_code_${Date.now()}.${ext}`;
    try {
      const blob = new Blob([codeText], { type: 'text/plain;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 100);
    } catch (err) {}
    setTimeout(() => {
      icon.style.opacity = '0';
      icon.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        btn.classList.remove('success');
        icon.setAttribute('name', originalIconName);
        icon.style.opacity = '1';
        icon.style.transform = 'translateY(0)';
      }, 150);
    }, 2000);
  }
});

const updateSliderFill = (sliderElement) => {
  if (!sliderElement) return;
  const min = parseFloat(sliderElement.min) || 0;
  const max = parseFloat(sliderElement.max) || 1;
  const value = parseFloat(sliderElement.value);
  const percentage = ((value - min) / (max - min)) * 100;
  sliderElement.style.setProperty('--slider-fill-percent', `${percentage}%`);
};

const applyBlurIntensity = (intensity) => {
  document.documentElement.style.setProperty('--galvan-blur-intensity-multiplier', intensity);
  if (blurSliderValueDisplay) blurSliderValueDisplay.textContent = `${parseFloat(intensity).toFixed(1)}x`;
  setUserData('blurIntensity', intensity);
};

const loadBlurPreference = () => {
  let storedIntensity = getUserData('blurIntensity') ?? 1.0;
  if (settingBlurSlider) {
    settingBlurSlider.value = storedIntensity;
    updateSliderFill(settingBlurSlider);
  }
  applyBlurIntensity(storedIntensity);
  updateBlurControlVisibility();
};

if (settingBlurSlider) {
  settingBlurSlider.addEventListener('input', (e) => {
    applyBlurIntensity(e.target.value);
    updateSliderFill(e.target);
  });
}

const applyLightDarkMode = (isLight, forcePaletteUpdate = false) => {
  body.classList.toggle("light-mode", isLight);
  currentThemeIsLight = isLight;
  if (forcePaletteUpdate) {
    const currentPaletteId = getUserData('colorPalette') || 'galvan';
    applyColorPalette(currentPaletteId, false);
  }
  if (settingToggleDarkModeSwitch) settingToggleDarkModeSwitch.checked = !isLight;
  requestAnimationFrame(() => {});
};

const saveLightDarkModePreference = () => {
  setUserData('themeMode', currentThemeIsLight ? "light" : "dark");
};

const loadLightDarkModePreference = () => {
  let storedIsLight = (getUserData('themeMode') !== "dark");
  applyLightDarkMode(storedIsLight, true);
};

if (settingToggleDarkModeSwitch) {
  settingToggleDarkModeSwitch.addEventListener('change', (e) => {
    applyLightDarkMode(!e.target.checked, true);
    saveLightDarkModePreference();
  });
}

const saveFullChatHistory = () => {
  const fullChatHistory = getUserData('chatHistory');
  if (!fullChatHistory) return;
  const MAX_HISTORY_ITEMS = 100;
  if (fullChatHistory.length > MAX_HISTORY_ITEMS * 2) {
    let turnCount = 0;
    let pruneIndex = fullChatHistory.length;
    for (let i = fullChatHistory.length - 1; i >= 0; i--) {
      if (fullChatHistory[i].role === 'user') {
        turnCount++;
        if (turnCount > MAX_HISTORY_ITEMS) {
          pruneIndex = i;
          break;
        }
      }
      if (turnCount <= MAX_HISTORY_ITEMS && i === 0) {
        pruneIndex = 0;
      }
    }
    const prunedHistory = fullChatHistory.slice(pruneIndex);
    setUserData('chatHistory', prunedHistory);
  } else {
    setUserData('chatHistory', fullChatHistory);
  }
};

function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function parseMarkdownToHTML(text) {
  let html = text;
  html = escapeHtml(html);
  html = html.replace(/```(\w*)\n([\s\S]*?)\n```/g, (match, lang, code) => {
    const language = lang || 'text';
    return `<div class="galvan-code-wrapper">
      <div class="galvan-code-header">
        <span class="galvan-code-lang">${language}</span>
        <div class="galvan-code-actions">
          <button class="galvan-code-btn copy-code-btn" title="Copy Code"><ion-icon name="copy-outline"></ion-icon><span>Copy</span></button>
          <button class="galvan-code-btn download-code-btn" data-lang="${language}" title="Download File"><ion-icon name="download-outline"></ion-icon><span>Save</span></button>
        </div>
      </div>
      <pre><code class="language-${language}">${code}</code></pre>
    </div>`;
  });
  html = html.replace(/^#{1,6}\s(.*)$/gm, (match, hashes, content) => `<h${hashes.length}>${content}</h${hashes.length}>`);
  html = html.replace(/^>\s(.*)$/gm, '<blockquote>$1</blockquote>');
  html = html.replace(/^((\s*([*+-]|\d+\.)\s.*)+)$/gm, (match) => {
    const isOrdered = /^\s*\d+\./.test(match);
    const tag = isOrdered ? 'ol' : 'ul';
    const items = match.split('\n').filter(Boolean).map(item => `<li>${item.replace(/^\s*([*+-]|\d+\.)\s/, '')}</li>`).join('');
    return `<${tag}>${items}</${tag}>`;
  });
  html = html.replace(/^---\s*$/gm, '<hr>');
  html = html.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" class="galvan-img-attachment">');
  html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>');
  html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>');
  html = html.replace(/`(.*?)`/g, '<code>$1</code>');
  return html.replace(/\n/g, '<br>');
}

function renderChatHistoryToDOM(historyArrayToRender) {
  chatsContainer.innerHTML = "";
  messageCounter = 0;
  const hasMessages = historyArrayToRender && historyArrayToRender.length > 0;
  if (!hasMessages && body.classList.contains('chats-active')) {
    if (chatPlaceholder) chatPlaceholder.classList.add('visible');
  } else {
    if (chatPlaceholder) chatPlaceholder.classList.remove('visible');
  }
  if (!historyArrayToRender) return;
  historyArrayToRender.forEach((entry, index) => {
    if (!entry || !entry.role || !entry.parts) return;
    let messageHTML = '';
    const textPart = entry.parts.find(p => p.text);
    const filePart = entry.parts.find(p => p.fileData);
    if (textPart) {
      messageHTML += parseMarkdownToHTML(textPart.text).replace(/<br>/g, '\n');
    }
    if (filePart && filePart.fileData) {
      const fileData = filePart.fileData;
      const safeFileName = escapeHtml(fileData.fileName || 'attached_file');
      const mimeType = fileData.mime_type || 'application/octet-stream';
      const isImage = mimeType.startsWith('image/');
      const base64Data = fileData.data;
      if (isImage && base64Data) messageHTML += `<img src="data:${mimeType};base64,${base64Data}" alt="${safeFileName}" class="galvan-img-attachment" />`;
      else messageHTML += `<div class="galvan-file-attachment">${getFileIconSVG(mimeType, safeFileName)}<p>${safeFileName}</p></div>`;
    }
    const messageClass = entry.role === 'user' ? 'user-message' : 'bot-message';
    const messageDiv = createMessageElement(messageHTML || '<i>(content missing)</i>', messageClass);
    messageDiv.dataset.timestamp = entry.timestamp || Date.now();
    messageDiv.style.animationDelay = `${Math.min(index * 0.06, 0.6)}s`;
    if (entry.role === 'user') addPressAndHoldListener(messageDiv);
    chatsContainer.appendChild(messageDiv);
    if (entry.role === 'model') addResponseActionButtons(messageDiv);
  });
  if (historyArrayToRender.length > 0 && !body.classList.contains('chats-active')) body.classList.add("chats-active");
  scrollToBottom("auto");
}

const loadFullChatHistoryFromStorage = () => {
  const loadedHistory = getUserData('chatHistory');
  currentChatSession = [];
  renderChatHistoryToDOM(currentChatSession);
  return loadedHistory && loadedHistory.length > 0;
};

const clearAllChatHistory = () => {
  currentChatSession = [];
  setUserData('chatHistory', []);
  renderChatHistoryToDOM(currentChatSession);
  body.classList.remove('chats-active');
};

const loadChatTurnIntoSession = (startIndex, endIndex) => {
  const fullChatHistory = getUserData('chatHistory');
  currentChatSession = fullChatHistory.slice(startIndex, endIndex + 1);
  renderChatHistoryToDOM(currentChatSession);
  body.classList.add('chats-active');
};

const getRelativeDateString = (d) => {
  const date = new Date(d);
  const today = new Date();
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
  if (isSameDay(date, today)) return 'Today';
  if (isSameDay(date, yesterday)) return 'Yesterday';
  return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
};

const createHistoryItemElement = (startIndex, endIndex) => {
  const fullChatHistory = getUserData('chatHistory');
  const userEntry = fullChatHistory[startIndex];
  if (!userEntry) return document.createElement('div');
  const userText = userEntry.parts.find(p => p.text)?.text || "User query (no text)";
  const historyItemDiv = document.createElement('div');
  historyItemDiv.classList.add('galvan-history-item');
  historyItemDiv.dataset.turnStartIndex = startIndex;
  historyItemDiv.dataset.turnEndIndex = endIndex;
  const itemTimestamp = new Date(userEntry.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  historyItemDiv.innerHTML = `
    <div class="galvan-history-item-query">${escapeHtml(userText)}</div>
    <div class="galvan-history-item-header">
      <span class="galvan-history-item-timestamp"><ion-icon name="time-outline"></ion-icon> ${itemTimestamp}</span>
      <button class="galvan-history-item-delete-btn" aria-label="Delete this turn"><ion-icon name="trash-outline"></ion-icon></button>
    </div>`;
  const deleteBtn = historyItemDiv.querySelector('.galvan-history-item-delete-btn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      e.preventDefault();
      const confirmed = await showGalvanConfirm("Delete?", "Want to Delete?", true);
      if (confirmed) deleteHistoryTurnFromFull(startIndex, endIndex);
    });
  }
  historyItemDiv.addEventListener('click', () => {
    loadChatTurnIntoSession(startIndex, endIndex);
  });
  return historyItemDiv;
};

const deleteHistoryTurnFromFull = (startIndex, endIndex) => {
  let fullChatHistory = getUserData('chatHistory');
  const deletedTimestamp = fullChatHistory[startIndex].timestamp;
  fullChatHistory.splice(startIndex, (endIndex - startIndex + 1));
  setUserData('chatHistory', fullChatHistory);
  if (currentChatSession.length > 0 && currentChatSession[0].timestamp === deletedTimestamp) {
    currentChatSession = [];
    renderChatHistoryToDOM([]);
  }
  if (fullChatHistory.length === 0) body.classList.remove('chats-active');
};

const addPressAndHoldListener = (messageDiv) => {
  let pressTimer = null;
  const startPress = (e) => {
    isLongPress = false;
    pressTimer = setTimeout(() => {
      isLongPress = true;
      messageBeingEditedTimestamp = messageDiv.dataset.timestamp;
      messageDiv.classList.add('is-editing');
      const textElement = messageDiv.querySelector('.galvan-message-text, .galvan-message-bubble');
      if (textElement) {
        const historyEntry = currentChatSession.find(entry => String(entry.timestamp) === messageBeingEditedTimestamp);
        const rawTextToEdit = historyEntry?.parts?.find(p => p.text)?.text || textElement.innerText.trim();
        promptInput.value = rawTextToEdit;
        promptInput.focus();
        promptInput.dispatchEvent(new Event('input'));
        if (navigator.vibrate) navigator.vibrate(50);
      }
    }, 700);
  };
  const cancelPress = () => {
    clearTimeout(pressTimer);
  };
  const removeEditState = () => {
    if (messageDiv.classList.contains('is-editing')) {
      messageDiv.classList.remove('is-editing');
      messageBeingEditedTimestamp = null;
    }
  };
  messageDiv.addEventListener('mousedown', startPress);
  messageDiv.addEventListener('touchstart', startPress, { passive: true });
  messageDiv.addEventListener('mouseup', cancelPress);
  messageDiv.addEventListener('touchend', cancelPress);
  messageDiv.addEventListener('mouseleave', cancelPress);
  messageDiv.addEventListener('touchcancel', cancelPress);
  document.addEventListener('click', (e) => {
    if (!messageDiv.contains(e.target)) removeEditState();
  });
};

const createMessageElement = (htmlContent, ...classes) => {
  const div = document.createElement("div");
  div.classList.add("galvan-message", ...classes);
  const msgId = `msg-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
  div.id = msgId;
  const isBot = classes.includes('bot-message');
  const isLoading = classes.includes('loading');
  if (isLoading && isBot) {
    div.innerHTML = `
      <div class="galvan-message-bubble" id="bubble-${msgId}">
        <svg class="apple-spinner-svg" viewBox="0 0 50 50" style="width:20px; height:20px;">
          <g transform="translate(25,25)">${Array.from({length: 12}).map((_, i) => `<line y1="-10" y2="-18" transform="rotate(${i * 30})" opacity="${(i+1)/12}"></line>`).join('')}</g>
        </svg>
        <span>Wait...</span>
        <span id="fast-trigger-${msgId}"></span>
      </div>
      <div class="galvan-action-dock" id="dock-${msgId}"></div>`;
  } else {
    const content = htmlContent.includes('galvan-message-text') ? htmlContent : `<div class="galvan-message-text">${htmlContent}</div>`;
    div.innerHTML = `
      <div class="galvan-message-bubble" id="bubble-${msgId}">${content}</div>
      <div class="galvan-action-dock" id="dock-${msgId}"></div>`;
  }
  div.dataset.timestamp = Date.now();
  return div;
};

const clearThinkingAnimations = (textElement) => {
  clearTimeout(thinkingTimeout);
  if (textElement) {
    const dots = textElement.querySelector('.galvan-thinking-dots-pulse');
    const stage = textElement.querySelector('.galvan-thinking-stage-text');
    if (dots) dots.style.display = 'none';
    if (stage) stage.innerHTML = '';
    if (body.classList.contains('hide-ai-thoughts') && textElement.classList.contains('js-thinking-placeholder')) {
      textElement.classList.remove('js-thinking-placeholder');
    }
  }
};

const showThinkingStages = (textElement) => {
  clearThinkingAnimations(textElement);
  const showThoughts = getUserData('showAiThoughts');
  if (!showThoughts) {
    textElement.innerHTML = '';
    textElement.classList.add('js-thinking-placeholder');
    return;
  }
  let dotsPulse = textElement.querySelector('.galvan-thinking-dots-pulse');
  if (!dotsPulse) {
    dotsPulse = document.createElement('div');
    dotsPulse.className = 'galvan-thinking-dots-pulse';
    dotsPulse.innerHTML = '<span></span><span></span><span></span>';
    textElement.appendChild(dotsPulse);
  }
  dotsPulse.style.display = 'flex';
};

const typingEffect = (rawText, textElement, botMsgDiv, addActions = true) => {
  clearThinkingAnimations(textElement);
  textElement.innerHTML = "";
  botMsgDiv.classList.remove("loading");
  const renderedHtml = parseMarkdownToHTML(rawText);
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = renderedHtml;
  const allNodes = Array.from(tempDiv.childNodes);
  let nodeIndex = 0;
  let charIndex = 0;
  let lastTime = performance.now();
  const charsPerSecond = 1200;
  function typeLoop(currentTime) {
    if (controller && controller.signal.aborted) {
      resetSendButton();
      return;
    }
    const deltaTime = currentTime - lastTime;
    lastTime = currentTime;
    let charsToType = (charsPerSecond * deltaTime) / 1000;
    let batchCounter = 0;
    while (batchCounter < charsToType && nodeIndex < allNodes.length) {
      const node = allNodes[nodeIndex];
      if (node.nodeType === Node.TEXT_NODE) {
        const content = node.textContent;
        const remainingChars = content.length - charIndex;
        const take = Math.min(Math.ceil(charsToType - batchCounter), remainingChars);
        const textChunk = content.substring(charIndex, charIndex + take);
        if (textElement.lastChild && textElement.lastChild.nodeType === Node.TEXT_NODE) {
          textElement.lastChild.nodeValue += textChunk;
        } else {
          textElement.appendChild(document.createTextNode(textChunk));
        }
        charIndex += take;
        batchCounter += take;
        if (charIndex >= content.length) {
          nodeIndex++;
          charIndex = 0;
        }
      } else {
        textElement.appendChild(node.cloneNode(true));
        nodeIndex++;
      }
    }
    smartScrollToBottom(chatsContainer);
    if (nodeIndex < allNodes.length) {
      typingInterval = requestAnimationFrame(typeLoop);
    } else {
      if (addActions) addResponseActionButtons(botMsgDiv);
      resetSendButton();
      saveFullChatHistory();
      requestAnimationFrame(() => {
        chatsContainer.scrollTo({ top: chatsContainer.scrollHeight, behavior: 'smooth' });
      });
    }
  }
  typingInterval = requestAnimationFrame(typeLoop);
};

const getResponseActionSVG = (action) => {
  const svgs = { like: '<ion-icon name="thumbs-up-outline"></ion-icon>', dislike: '<ion-icon name="thumbs-down-outline"></ion-icon>', copy: '<ion-icon name="copy-outline"></ion-icon>', refresh: '<ion-icon name="sync-outline"></ion-icon>', copied_check: '<ion-icon name="checkmark-outline"></ion-icon>' };
  return svgs[action] || '';
};

const addResponseActionButtons = (botMsgDiv) => {
  const dock = botMsgDiv.querySelector('.galvan-action-dock');
  if (!dock || dock.children.length > 0) return;
  let userTs = null;
  let prev = botMsgDiv;
  while (prev.previousElementSibling) {
    prev = prev.previousElementSibling;
    if (prev.classList.contains('user-message')) {
      userTs = prev.dataset.timestamp;
      break;
    }
  }
  const btnCopy = document.createElement('button');
  btnCopy.className = 'ios-action-btn';
  btnCopy.innerHTML = `<ion-icon name="copy-outline"></ion-icon><span>Copy</span>`;
  btnCopy.onclick = () => {
    const text = botMsgDiv.querySelector('.galvan-message-text')?.innerText || "";
    navigator.clipboard.writeText(text).then(() => {
      const originalHTML = btnCopy.innerHTML;
      btnCopy.classList.add('success');
      btnCopy.innerHTML = `<ion-icon name="checkmark-circle"></ion-icon><span>Copied</span>`;
      setTimeout(() => {
        btnCopy.classList.remove('success');
        btnCopy.innerHTML = originalHTML;
      }, 2000);
    });
  };
  let btnEdit;
  if (userTs) {
    btnEdit = document.createElement('button');
    btnEdit.className = 'ios-action-btn';
    btnEdit.innerHTML = `<ion-icon name="pencil-outline"></ion-icon><span>Edit</span>`;
    btnEdit.onclick = () => {
      const userMsg = document.querySelector(`.user-message[data-timestamp="${userTs}"]`);
      if (userMsg) {
        const textToEdit = userMsg.querySelector('.galvan-message-bubble').innerText.trim();
        promptInput.value = textToEdit;
        promptInput.focus();
        const originalHTML = btnEdit.innerHTML;
        btnEdit.classList.add('success');
        btnEdit.innerHTML = `<ion-icon name="checkmark-circle"></ion-icon><span>Editing</span>`;
        setTimeout(() => {
          btnEdit.classList.remove('success');
          btnEdit.innerHTML = originalHTML;
        }, 2000);
      }
    };
  }
  let btnRegen;
  if (userTs) {
    btnRegen = document.createElement('button');
    btnRegen.className = 'ios-action-btn';
    btnRegen.innerHTML = `<ion-icon name="sync-outline"></ion-icon><span>Regenerate</span>`;
    btnRegen.dataset.action = 'regenerate';
    btnRegen.dataset.userMsgTimestamp = userTs;
    btnRegen.onclick = handleResponseActionClick;
  }
  dock.appendChild(btnCopy);
  if (btnEdit) dock.appendChild(btnEdit);
  if (btnRegen) dock.appendChild(btnRegen);
};

setTimeout(() => {
  if (document.body.contains(botMsgDiv) && botMsgDiv.classList.contains('loading')) {
    const triggerSpan = botMsgDiv.querySelector(`[id^="fast-trigger-"]`);
    if (triggerSpan) {
      const fastBtn = document.createElement('button');
      fastBtn.className = 'fast-btn-anim';
      fastBtn.innerHTML = 'FAST ';
      fastBtn.onclick = () => {
        fastBtn.style.background = '#34D399';
        fastBtn.innerHTML = 'BOOSTED';
      };
      triggerSpan.appendChild(fastBtn);
    }
  }
}, 5000);

const handleResponseActionClick = (e) => {
  const button = e.currentTarget;
  const action = button.dataset.action;
  const messageDiv = button.closest('.galvan-message');
  const botMsgDivToFade = button.closest('.bot-message');
  let responseText = '';
  if (messageDiv && messageDiv.dataset.timestamp) {
    const historyEntry = currentChatSession.find(entry => String(entry.timestamp) === messageDiv.dataset.timestamp && entry.role === 'model');
    responseText = historyEntry?.parts?.find(p => p.text)?.text || messageDiv.querySelector('.galvan-message-text')?.textContent.trim() || '';
  }
  if (action === 'regenerate' && botMsgDivToFade) {
    if (body.classList.contains("bot-responding")) return;
    const userMsgTimestamp = button.dataset.userMsgTimestamp;
    if (!userMsgTimestamp) return;
    let userMsgIndexInSession = currentChatSession.findIndex(entry => String(entry.timestamp) === userMsgTimestamp && entry.role === 'user');
    if (userMsgIndexInSession !== -1) {
      botMsgDivToFade.classList.add('message-regenerating-out');
      setTimeout(() => {
        if (botMsgDivToFade.parentNode) botMsgDivToFade.remove();
      }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--message-regen-out-duration') || '0.4') * 1000);
      let fullHistory = getUserData('chatHistory');
      const userMsgIndexInFull = fullHistory.findIndex(entry => String(entry.timestamp) === userMsgTimestamp && entry.role === 'user');
      if (userMsgIndexInFull !== -1) fullHistory.splice(userMsgIndexInFull + 1);
      currentChatSession.splice(userMsgIndexInSession + 1);
      setUserData('chatHistory', fullHistory);
      setSendButtonState('stop');
      messageCounter = 0;
      const newBotMsgDiv = createMessageElement(`<div class="galvan-thinking-dots-pulse"><span></span><span></span><span></span></div>`, "bot-message", "loading");
      chatsContainer.appendChild(newBotMsgDiv);
      scrollToBottom('smooth');
      const contextForApi = [...currentChatSession];
      if (IS_API_KEY_VALID) generateResponse_API(newBotMsgDiv, contextForApi);
      else {
        const targetUserEntry = currentChatSession[userMsgIndexInSession];
        const userTextPart = targetUserEntry.parts.find(p => p.text);
        const userFilePart = targetUserEntry.parts.find(p => p.fileData);
        simulateAIResponse_Simulated(userTextPart?.text || "", userFilePart?.fileData, newBotMsgDiv, contextForApi);
      }
    }
  }
};

const stopResponseGeneration = () => {
  if (!body.classList.contains("bot-responding")) return;
  controller?.abort();
  if (typingInterval) {
    clearTimeout(typingInterval);
    typingInterval = null;
  }
  const loadingMsg = chatsContainer.querySelector(".bot-message.loading");
  if (loadingMsg) loadingMsg.remove();
  const lastUserMsg = chatsContainer.querySelector(".user-message:last-child");
  if (lastUserMsg) lastUserMsg.remove();
  if (currentChatSession.length > 0 && currentChatSession[currentChatSession.length - 1].role === 'user') {
    currentChatSession.pop();
  }
  resetSendButton();
  scrollToBottom('auto');
 };

const setSendButtonState = (state) => {
  if (state === 'stop') {
    sendBtn.classList.add('stop-active');
    sendBtn.disabled = false;
    sendBtn.setAttribute('aria-label', 'Stop generating');
    body.classList.add("bot-responding");
    promptWrapper.classList.add("processing");
    promptInput.disabled = true;
    addFileBtn.disabled = true;
  } else {
    sendBtn.classList.remove('stop-active');
    sendBtn.disabled = (promptInput.value.trim() === '' && !userData.file.data);
    sendBtn.setAttribute('aria-label', 'Send message');
    body.classList.remove("bot-responding");
    promptWrapper.classList.remove("processing");
    promptInput.disabled = false;
    addFileBtn.disabled = false;
  }
};

const resetSendButton = () => {
  setSendButtonState('send');
};

const prepareBotMessageForTyping = (botMsgDiv) => {
  botMsgDiv.classList.remove('loading');
  botMsgDiv.innerHTML = '';
  const msgId = botMsgDiv.id.replace('message-', '');
  botMsgDiv.innerHTML = `
    <div class="galvan-message-bubble" id="bubble-${msgId}">
      <div class="galvan-message-text"></div>
    </div>
    <div class="galvan-action-dock" id="dock-${msgId}"></div>`;
  return botMsgDiv.querySelector('.galvan-message-text');
};

const generateResponse_API = async (botMsgDiv, contextHistory) => {
    if (!API_KEY || API_KEY.length < 10 || API_KEY === "YOUR_API_KEY_HERE") {
        const lastUserMsg = contextHistory[contextHistory.length - 1];
        simulateAIResponse_Simulated(
            lastUserMsg?.parts?.[0]?.text || "", 
            null, 
            botMsgDiv, 
            contextHistory
        );
        return;
    }

    controller = new AbortController();
    
    try {
        const apiHistory = contextHistory.map(entry => ({ 
            role: entry.role, 
            parts: entry.parts.map(part => part.fileData ? { 
                inline_data: { mime_type: part.fileData.mime_type, data: part.fileData.data } 
            } : part) 
        }));

        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                contents: apiHistory, 
                generationConfig: { temperature: 0.7, topK: 40, topP: 0.95 } 
            }),
            signal: controller.signal
        });

        if (controller.signal.aborted) return;

        if (!response.ok) {
            throw new Error(`API_FALLBACK_TRIGGER: ${response.status}`);
        }

        const data = await response.json();

        if (data.promptFeedback?.blockReason) {
             throw new Error("API_FALLBACK_TRIGGER: Blocked");
        }

        const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

        if (!responseText) {
            throw new Error("API_FALLBACK_TRIGGER: Empty Response");
        }

        const modelEntry = { role: "model", parts: [{ text: responseText }], timestamp: Date.now() };
        currentChatSession.push(modelEntry);

        if (!isIncognitoMode) {
            let fullHistory = getUserData('chatHistory') || [];
            const associatedUserMsg = currentChatSession[currentChatSession.length - 2];
            if (associatedUserMsg && associatedUserMsg.role === 'user') {
                fullHistory.push(associatedUserMsg);
                fullHistory.push(modelEntry);
                setUserData('chatHistory', fullHistory);
            }
        }

        const targetTextElement = prepareBotMessageForTyping(botMsgDiv);
        typingEffect(responseText, targetTextElement, botMsgDiv, true);

    } catch (error) {
        if (error.name === 'AbortError') return;

        botMsgDiv.classList.add('loading');
        
        const lastUserEntry = contextHistory[contextHistory.length - 1];
        const userText = lastUserEntry?.parts?.find(p => p.text)?.text || "";
        const userFile = lastUserEntry?.parts?.find(p => p.fileData)?.fileData || null;

        simulateAIResponse_Simulated(userText, userFile, botMsgDiv, contextHistory);
    } finally {
        if (!controller?.signal?.aborted) resetSendButton();
        controller = null;
    }
};
const handleFormSubmit = (e) => {
  e.preventDefault();
  if (sendBtn.classList.contains('stop-active')) {
    stopResponseGeneration();
    return;
  }
  const userMessageText = promptInput.value.trim();
  if (!userMessageText && !userData.file.data) return;
  if (!body.classList.contains('chats-active')) {
    body.classList.add("chats-active");
    updateTopNavVisuals('chats');
  }
  if (!body.classList.contains('suggestions-scrolled')) body.classList.add('suggestions-scrolled');
  if (chatPlaceholder) chatPlaceholder.classList.remove('visible');
  const fileToSend = userData.file.data ? { ...userData.file } : null;
  if (messageBeingEditedTimestamp || promptHistoryIndex !== -1) {
    let editTimestamp = messageBeingEditedTimestamp || userPromptsHistory[promptHistoryIndex]?.timestamp;
    if (editTimestamp) {
      const editIndexSession = currentChatSession.findIndex(entry => String(entry.timestamp) === String(editTimestamp) && entry.role === 'user');
      if (editIndexSession !== -1) currentChatSession.splice(editIndexSession);
    }
  }
  const turnTimestamp = Date.now();
  const userHistoryEntry = { role: "user", parts: [], timestamp: turnTimestamp };
  if (userMessageText) userHistoryEntry.parts.push({ text: userMessageText });
  if (fileToSend) userHistoryEntry.parts.push({ fileData: { fileName: fileToSend.fileName, mime_type: fileToSend.mime_type, data: fileToSend.data } });
  currentChatSession.push(userHistoryEntry);
  renderChatHistoryToDOM(currentChatSession);
  scrollToBottom('auto');
  promptInput.value = "";
  promptInput.style.height = 'auto';
  updateChatContainerPadding();
  fileUploadWrapper.classList.remove("active");
  userData.file = {};
  resetSendButton();
  messageBeingEditedTimestamp = null;
  setSendButtonState('stop');
  setTimeout(() => {
    const botMsgDiv = createMessageElement(`<div class="galvan-thinking-dots-pulse"><span></span><span></span><span></span></div>`, "bot-message", "loading");
    chatsContainer.appendChild(botMsgDiv);
    smartScrollToBottom(chatsContainer);
    if (IS_API_KEY_VALID) {
      generateResponse_API(botMsgDiv, [...currentChatSession]);
    } else {
      simulateAIResponse_Simulated(userMessageText, fileToSend, botMsgDiv, [...currentChatSession]);
    }
  }, 50);
};

const simulateAIResponse_Simulated = (prompt, fileInfo, botMsgDiv, contextHistory) => {
  setSendButtonState('stop');
  const delay = 400 + Math.random() * 1600;
  thinkingTimeout = setTimeout(() => {
    if (controller && controller.signal.aborted) return;
    if (document.body.classList.contains("bot-responding")) {
      let answer = `Simulated answer for "${prompt || 'your query'}"`;
      if (fileInfo && fileInfo.fileName) answer += ` analyzing *${fileInfo.fileName}*`;
      const randomAnswers = [
        `${answer}.\n\nThis is a **Simulation Mode** response because the API key is missing or invalid.\n\n### Layout Check\n1. Does the container look good?\n2. Did the "Wait" spinner vanish correctly?\n\n\`\`\`javascript\nconsole.log("Bug Fixed");\n\`\`\``,
        `**System Online.**\n\nI have processed your request: "${prompt}".\nSince I am running in simulation mode, I cannot access the live Gemini model, but I can confirm the UI transition from "Loading" to "Text" is now seamless.`,
        `${answer}\n\nHere is a list of improvements:\n* Centralized Layout\n* iOS Gradient Buttons\n* Smooth State Handover`
      ];
      const chosenAnswer = randomAnswers[Math.floor(Math.random() * randomAnswers.length)];
      const modelEntry = { role: "model", parts: [{ text: chosenAnswer }], timestamp: Date.now() };
      currentChatSession.push(modelEntry);
      let fullHistory = getUserData('chatHistory') || [];
      fullHistory.push(modelEntry);
      setUserData('chatHistory', fullHistory);
      const targetTextElement = prepareBotMessageForTyping(botMsgDiv);
      typingEffect(chosenAnswer, targetTextElement, botMsgDiv, true);
    }
  }, delay);
};

promptForm.addEventListener("submit", handleFormSubmit);
const getFileIconSVG = (mimeType, fileName = '') => {
    const name = fileName.toLowerCase();
    
    if (name.endsWith('.doc') || name.endsWith('.docx') || name.endsWith('.rtf') || name.endsWith('.pages') || name.endsWith('.txt') || mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('text/plain')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
        </svg>`;
    }

    if (name.endsWith('.xls') || name.endsWith('.xlsx') || name.endsWith('.csv') || name.endsWith('.numbers') || mimeType.includes('spreadsheet') || mimeType.includes('excel')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-4h2v4zm4 0h-2v-4h2v4zm4 0h-2v-4h2v4zm0-6H7V7h10v4z"/>
        </svg>`;
    }

    if (name.endsWith('.ppt') || name.endsWith('.pptx') || name.endsWith('.key') || mimeType.includes('presentation') || mimeType.includes('powerpoint')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M4 3h16c.55 0 1 .45 1 1v16c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1zm10 8.41L12.41 10 11 11.41 12.59 13 11 14.59 12.41 16 14 14.41 15.59 16 17 14.59 15.41 13 17 11.41 15.59 10 14 11.41zM6 5h2v2H6V5zm0 4h2v2H6V9zm0 4h2v2H6v-2zm0 4h2v2H6v-2z"/>
        </svg>`;
    }

    if (name.endsWith('.pdf') || mimeType === 'application/pdf') {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm11.5 1.5h1v-1h-1v1z"/>
        </svg>`;
    }

    if (name.match(/\.(js|jsx|ts|tsx|html|css|py|json|java|c|cpp|rb|php|sql)$/i) || mimeType.includes('json') || mimeType.includes('javascript')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
        </svg>`;
    }

    if (mimeType.startsWith('audio/') || name.endsWith('.mp3') || name.endsWith('.wav')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
        </svg>`;
    }

    if (mimeType.startsWith('video/') || name.endsWith('.mp4') || name.endsWith('.mov')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
        </svg>`;
    }

    if (name.endsWith('.zip') || name.endsWith('.rar') || name.endsWith('.7z') || name.endsWith('.tar') || mimeType.includes('zip') || mimeType.includes('compressed')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
             <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10zm-8-4h2v2h-2v-2zm-4 0h2v2h-2v-2zm8 0h2v2h-2v-2z"/>
        </svg>`;
    }

    if (mimeType.startsWith('image/')) {
        return `<svg viewBox="0 0 24 24" class="file-icon-svg">
            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
        </svg>`;
    }

    return `<svg viewBox="0 0 24 24" class="file-icon-svg">
        <path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"/>
    </svg>`;
};
cancelFileBtn.addEventListener("click", () => {
  userData.file = {};
  fileUploadWrapper.classList.remove("active");
  if (!body.classList.contains("bot-responding")) sendBtn.disabled = promptInput.value.trim() === '';
});

const updateChatContainerPadding = () => {
  if (!promptForm || !chatsContainer) return;
  const footerHeight = promptForm.offsetHeight;
  chatsContainer.style.paddingBottom = `${footerHeight + 20}px`;
};

promptInput.addEventListener('input', () => {
  promptInput.style.height = 'auto';
  const scrollHeight = promptInput.scrollHeight;
  const maxHeight = parseInt(getComputedStyle(promptInput).maxHeight) || 160;
  promptInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
  updateChatContainerPadding();
  if (!body.classList.contains("bot-responding")) sendBtn.disabled = promptInput.value.trim() === '' && !userData.file.data;
  promptWrapper.classList.toggle('has-text', promptInput.value.trim() !== '' || userData.file.data);
});

window.addEventListener('resize', updateChatContainerPadding);
requestAnimationFrame(updateChatContainerPadding);
sendBtn.disabled = promptInput.value.trim() === '' && !userData.file.data;

const setActiveNavButton = (activeBtn, navGroupEl) => {
  if (!navGroupEl) return;
  navGroupEl.querySelectorAll('.galvan-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (activeBtn) activeBtn.classList.add('active');
  const homeButtonInGroup = navGroupEl.querySelector('#home-btn') || navGroupEl.querySelector('#home-btn-cloned');
  if (homeButtonInGroup) {
    const isHomeActive = activeBtn === homeButtonInGroup;
    const currentHomeFilled = homeButtonInGroup.querySelector('.icon-home-filled');
    const currentHomeOutline = homeButtonInGroup.querySelector('.icon-home-outline');
    if (currentHomeFilled) currentHomeFilled.style.display = isHomeActive ? 'block' : 'none';
    if (currentHomeOutline) currentHomeOutline.style.display = isHomeActive ? 'none' : 'block';
  }
};

const updateTopNavVisuals = (activeTab) => {
  if (!navIslandContainer) return;
  navIslandContainer.setAttribute('data-active', activeTab);
  if (activeTab === 'home') {
    navIslandHomeBtn.classList.add('active');
    navIslandChatsBtn.classList.remove('active');
  } else {
    navIslandHomeBtn.classList.remove('active');
    navIslandChatsBtn.classList.add('active');
  }
};

if (navIslandHomeBtn) {
  navIslandHomeBtn.addEventListener('click', () => {
    if (body.classList.contains('chats-active')) _goHome();
  });
}

if (navIslandChatsBtn) {
  navIslandChatsBtn.addEventListener('click', () => {
    body.classList.add('chats-active');
    updateTopNavVisuals('chats');
    const storedHistory = getUserData('chatHistory') || [];
    currentChatSession = [...storedHistory];
    renderChatHistoryToDOM(currentChatSession);
    if (currentChatSession.length === 0) {
      if (chatPlaceholder) requestAnimationFrame(() => chatPlaceholder.classList.add('visible'));
    } else {
      if (chatPlaceholder) chatPlaceholder.classList.remove('visible');
      scrollToBottom("auto");
    }
  });
}

if (suggestionsContainer) {
  suggestionsContainer.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      body.classList.toggle('suggestions-scrolled', suggestionsContainer.scrollTop > 70);
    }, 50);
  }, { passive: true });
}

const performResetAll = () => {
  const overlay = document.getElementById('galvan-reset-overlay');
  const progressBar = document.getElementById('reset-progress-fill');
  const statusLog = document.getElementById('reset-status-log');
  document.body.classList.remove('app-locked');
  const blocker = document.getElementById('galvan-app-blocker');
  const lockHub = document.getElementById('galvan-lock-hub');
  if (blocker) blocker.classList.remove('active');
  if (lockHub) lockHub.classList.remove('expanded');
  overlay.classList.add('show');
  progressBar.style.width = '0%';
  statusLog.textContent = "Initializing...";
  const steps = [
    { time: 500, width: '20%', text: 'Halting AI Processes...' },
    { time: 1500, width: '45%', text: 'Clearing Security Credentials...' },
    { time: 2500, width: '70%', text: 'Wiping History & Settings...' },
    { time: 3500, width: '90%', text: 'Recompiling UI Assets...' },
    { time: 4200, width: '100%', text: 'Rebooting System...' }
  ];
  let stepIndex = 0;
  const runStep = () => {
    if (stepIndex >= steps.length) {
      finalizeReset();
      return;
    }
    const step = steps[stepIndex];
    setTimeout(() => {
      progressBar.style.width = step.width;
      statusLog.style.opacity = 0;
      setTimeout(() => {
        statusLog.textContent = step.text;
        statusLog.style.opacity = 1;
      }, 100);
      stepIndex++;
      runStep();
    }, stepIndex === 0 ? step.time : (step.time - steps[stepIndex - 1].time));
  };
  runStep();
  const finalizeReset = () => {
    setTimeout(() => {
      localStorage.removeItem('galvan_secure_pin_v1');
      localStorage.removeItem(STORAGE_KEY);
      appSettings = getDefaultSettings();
      currentChatSession = [];
      userPromptsHistory = [];
      renderChatHistoryToDOM([]);
      renderHistoryHubList();
      _goHome(true);
      loadLightDarkModePreference();
      loadBlurPreference();
      applyColorPalette('galvan', false);
      renderColorPaletteOptions();
      const defaultSettings = [
        { el: document.querySelector('#setting-toggle-suggestions'), key: 'showSuggestions', class: 'hide-suggestions', inverse: true },
        { el: document.querySelector('#setting-toggle-attachments'), key: 'enableAttachments', callback: (checked) => { const btn = document.querySelector('#add-file-btn'); if (btn) btn.style.display = checked ? 'flex' : 'none'; } },
        { el: document.querySelector('#setting-toggle-auto-update'), key: 'autoUpdate' }
      ];
      defaultSettings.forEach(s => {
        const defaultValue = getDefaultSettings()[s.key];
        if (s.el) s.el.checked = defaultValue;
        if (s.class) document.body.classList.toggle(s.class, s.inverse ? !defaultValue : defaultValue);
        if (s.callback) s.callback(defaultValue);
      });
      overlay.classList.remove('show');
      setTimeout(() => {
        location.reload();
      }, 500);
    }, 800);
  };
};

const applyColorPalette = (paletteId, savePreference = true) => {
  const palette = COLOR_PALETTES.find(p => p.id === paletteId);
  const rootStyle = document.documentElement.style;
  ['light', 'dark'].forEach(mode => {
    Object.keys(paletteVariableMap).forEach(paletteKeyInJS => {
      const cssSuffix = paletteVariableMap[paletteKeyInJS];
      const cssVarName = `--app-${cssSuffix}-${mode}`;
      let valueToSet;
      if (palette && !palette.isDefault && palette[mode] && palette[mode][paletteKeyInJS] !== undefined) {
        valueToSet = palette[mode][paletteKeyInJS];
      } else {
        valueToSet = baseThemeVariables[mode][cssVarName] || '';
      }
      rootStyle.setProperty(cssVarName, valueToSet);
    });
  });
  const currentIsLight = body.classList.contains('light-mode');
  body.classList.remove('light-mode');
  requestAnimationFrame(() => body.classList.add(currentIsLight ? 'light-mode' : 'dark-mode'));
  if (savePreference) setUserData('colorPalette', paletteId);
  renderColorPaletteOptions();
};

const renderColorPaletteOptions = () => {
  if (!colorPaletteOptionsContainer) return;
  colorPaletteOptionsContainer.innerHTML = '';
  const activePaletteId = getUserData('colorPalette') || 'galvan';
  COLOR_PALETTES.forEach(palette => {
    const btn = document.createElement('button');
    btn.classList.add('galvan-color-palette-item');
    if (palette.id === activePaletteId) btn.classList.add('active-palette');
    btn.dataset.paletteId = palette.id;
    const p = palette.preview;
    const preview = document.createElement('div');
    preview.className = 'galvan-palette-preview-wrapper';
    preview.style.backgroundColor = p.bg;
    preview.innerHTML = `
      <div class="preview-bubble" style="background: ${p.bubble};">Select!</div>
      <div class="preview-accent-bar">
        <span style="background-color: ${p.accent1};"></span>
        <span style="background-color: ${p.accent2};"></span>
      </div>`;
    const name = document.createElement('div');
    name.classList.add('galvan-palette-name');
    name.textContent = palette.name;
    btn.appendChild(preview);
    btn.appendChild(name);
    colorPaletteOptionsContainer.appendChild(btn);
  });
};

const getContextAwareCommands = () => {
  const isLightMode = document.body.classList.contains('light-mode');
  const allActions = [
    { id: 'cmd_toggle_mode', title: isLightMode ? 'Dark Mode' : 'Light Mode', subtitle: isLightMode ? 'Switch to dark theme' : 'Switch to light theme', icon: '<ion-icon name="contrast-outline"></ion-icon>', action: () => {
      const currentLight = document.body.classList.contains('light-mode');
      applyLightDarkMode(!currentLight, true);
      saveLightDarkModePreference();
      setTimeout(renderSuggestions, 300);
    }},
    { id: 'cmd_palette', title: 'Remix Color', subtitle: 'Surprise theme', icon: '<ion-icon name="color-filter-outline"></ion-icon>', action: () => {
      const palettes = COLOR_PALETTES.map(p => p.id);
      let randomPalette;
      do { randomPalette = palettes[Math.floor(Math.random() * palettes.length)]; } while (randomPalette === (getUserData('colorPalette') || 'galvan'));
      applyColorPalette(randomPalette, true);
      const pName = COLOR_PALETTES.find(p => p.id === randomPalette)?.name;
    }},
    { id: 'cmd_upload', title: 'Attach File', subtitle: 'Analyze document', icon: '<ion-icon name="add-outline"></ion-icon>', condition: () => getUserData('enableAttachments'), action: () => fileInput.click() },
    { id: 'cmd_history', title: 'Clear History', subtitle: 'Start fresh', icon: '<ion-icon name="trash-bin"></ion-icon>', condition: () => (getUserData('chatHistory') || []).length > 0, action: async () => {
      const confirmed = await showGalvanConfirm("Clear History?", "Delete all messages permanently?", true);
      if (confirmed) clearAllChatHistory();
    }},
    { id: 'cmd_reset', title: 'Factory Reset', subtitle: 'Restore defaults', icon: '<ion-icon name="refresh-outline"></ion-icon>', action: async () => {
      const confirmed = await showGalvanConfirm("Reset App?", "Restore default settings?", true);
      if (confirmed) performResetAll();
    }},
    { id: 'cmd_info', title: 'System Info', subtitle: 'Version & Status', icon: '<ion-icon name="information-outline"></ion-icon>', action: () => {
      const hub = document.getElementById('galvan-notification-hub');
      const updateSector = document.getElementById('hub-notice-sector');
      if (hub && updateSector) {
        hub.classList.add('expanded');
        updateSector.style.display = 'block';
        requestAnimationFrame(() => {
          document.body.classList.add('ios-update-focus');
          updateSector.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        const handleFocusClick = (e) => {
          if (updateSector.contains(e.target)) {
            document.body.classList.remove('ios-update-focus');
            document.removeEventListener('click', handleFocusClick, true);
          } else {
            document.body.classList.remove('ios-update-focus');
            hub.classList.remove('expanded');
            document.removeEventListener('click', handleFocusClick, true);
          }
          e.stopPropagation();
        };
        setTimeout(() => document.addEventListener('click', handleFocusClick, true), 100);
      } else {
      }
    }}
  ];
  let validActions = allActions.filter(cmd => cmd.condition ? cmd.condition() : true);
  for (let i = validActions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [validActions[i], validActions[j]] = [validActions[j], validActions[i]];
  }
  const maxItems = window.innerWidth < 600 ? 4 : 6;
  return validActions.slice(0, maxItems);
};

const renderSuggestions = () => {
  const track = document.getElementById('suggestions-track');
  if (!track) return;
  track.innerHTML = '';
  const commands = getContextAwareCommands();
  commands.forEach((cmd, index) => {
    const card = document.createElement('div');
    card.className = 'premium-card';
    card.dataset.type = cmd.type || 'system';
    card.style.animationDelay = `${index * 0.07}s`;
    card.innerHTML = `
      <div class="premium-icon-box">${cmd.icon}</div>
      <div class="premium-text-stack">
        <span class="premium-title">${cmd.title}</span>
        <span class="premium-subtitle">${cmd.subtitle}</span>
      </div>
      <ion-icon name="arrow-forward" style="margin-left:auto; opacity:0.3; font-size:18px;"></ion-icon>`;
    card.addEventListener('click', (e) => {
      e.stopPropagation();
      card.style.transform = 'scale(0.96)';
      setTimeout(() => {
        cmd.action();
        if (cmd.type === 'theme' || cmd.type === 'darktheme' || cmd.type === 'palette') setTimeout(() => renderSuggestions(), 200);
        card.style.transform = '';
      }, 100);
    });
    track.appendChild(card);
  });
};

let gridResizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(gridResizeTimer);
  gridResizeTimer = setTimeout(() => {}, 150);
});
const initializeApp = () => {
    console.log("Initializing Galvan AI...");
    
    try {
        captureBaseThemeVariables();
        loadSettings();
        loadLightDarkModePreference();
        loadBlurPreference();
        
        const palette = getUserData('colorPalette') || 'galvan';
        applyColorPalette(palette, false);
        
        if (typeof checkUnreadNotices === 'function') checkUnreadNotices();
        renderSuggestions();

        const initialSettings = [
            { el: settingToggleSuggestionsSwitch, key: 'showSuggestions', class: 'hide-suggestions', inverse: true },
            { el: settingToggleAttachmentsSwitch, key: 'enableAttachments', callback: (checked) => { if (addFileBtn) addFileBtn.style.display = checked ? 'flex' : 'none'; } }
        ];

        initialSettings.forEach(s => {
            if (s.el) {
                const value = getUserData(s.key) ?? getDefaultSettings()[s.key];
                s.el.checked = value;
                if (s.class) body.classList.toggle(s.class, s.inverse ? !value : value);
                if (s.callback) s.callback(value);
            }
        });

        const storedHistory = getUserData('chatHistory') || [];
        if (storedHistory.length > 0) {
            currentChatSession = [...storedHistory];
            renderChatHistoryToDOM(currentChatSession);
            body.classList.add('chats-active');
        }

        _goHome(true);

    } catch (err) {
        console.error("Initialization error (continuing anyway):", err);
    }

    requestAnimationFrame(() => {
        setTimeout(() => {
            document.body.classList.add('app-ready');
            console.log("App Ready!");
            
            const status = document.querySelector('.boot-status');
            if (status) status.textContent = "Ready";
            
            updateChatContainerPadding();
        }, 1200);
    });

    setTimeout(() => {
        if (!document.body.classList.contains('app-ready')) {
            document.body.classList.add('app-ready');
            console.warn("Boot sequence took too long, forced start.");
        }
    }, 3500);
};
initializeApp();

const showGalvanConfirm = (title, message, isDestructive = false) => {
  return new Promise((resolve) => {
    const modal = document.getElementById('galvan-confirm-modal');
    const titleEl = document.getElementById('galvan-confirm-title');
    const textEl = document.getElementById('galvan-confirm-text');
    const confirmBtn = document.getElementById('galvan-btn-confirm');
    const cancelBtn = document.getElementById('galvan-btn-cancel');
    titleEl.textContent = title;
    textEl.textContent = message;
    modal.classList.remove('closing');
    if (isDestructive) {
      confirmBtn.classList.add('destructive');
      confirmBtn.style.backgroundColor = 'var(--current-error-text)';
      confirmBtn.innerHTML = '<ion-icon name="trash-outline"></ion-icon> Delete';
    } else {
      confirmBtn.classList.remove('destructive');
      confirmBtn.style.backgroundColor = 'var(--current-icon-active)';
      confirmBtn.innerHTML = '<ion-icon name="checkmark-circle-outline"></ion-icon> Confirm';
    }
    const close = (result) => {
      modal.classList.add('closing');
      modal.classList.remove('visible');
      confirmBtn.onclick = null;
      cancelBtn.onclick = null;
      setTimeout(() => {
        modal.classList.remove('closing');
        resolve(result);
      }, 300);
    };
    confirmBtn.onclick = () => close(true);
    cancelBtn.onclick = () => close(false);
    requestAnimationFrame(() => modal.classList.add('visible'));
  });
};

const customizeHub = document.getElementById('galvan-customize-hub');
const customizeCloseBtn = document.getElementById('customize-close-btn');
const quickDarkModeToggle = document.getElementById('quick-toggle-dark-mode');
const quickSuggestionsToggle = document.getElementById('quick-toggle-suggestions');
const quickPaletteContainer = document.getElementById('quick-color-palette-options');
const quickResetBtn = document.getElementById('quick-reset-btn');
const quickBlurRow = document.getElementById('quick-blur-control-row');
const quickBlurSlider = document.getElementById('quick-blur-slider');
const quickBlurValue = document.getElementById('quick-blur-value');

const updateQuickHubUI = () => {
  if (quickDarkModeToggle) quickDarkModeToggle.checked = !body.classList.contains('light-mode');
  if (quickSuggestionsToggle) quickSuggestionsToggle.checked = getUserData('showSuggestions');
  if (quickBlurRow) {
    const hasUserImage = body.classList.contains('user-bg-active');
    quickBlurRow.style.display = hasUserImage ? 'flex' : 'none';
    if (hasUserImage && quickBlurSlider) {
      const val = getUserData('blurIntensity') ?? 1.0;
      quickBlurSlider.value = val;
      quickBlurValue.textContent = `${parseFloat(val).toFixed(1)}x`;
      updateSliderFill(quickBlurSlider);
    }
  }
};
const renderQuickPalettes = () => {
    const container = document.getElementById('quick-color-palette-options');
    if (!container) return;
    container.innerHTML = '';
    
    const activePaletteId = getUserData('colorPalette') || 'galvan';
    
    const wrapper = document.createElement('div');
    wrapper.className = 'oneui-palette-container';
    
    const tabs = document.createElement('div');
    tabs.className = 'oneui-tabs-wrapper';
    tabs.innerHTML = `
        <div class="oneui-tab-glider"></div>
        <button class="oneui-tab-btn active" data-tab="wallpaper">Default</button>
        <button class="oneui-tab-btn" data-tab="basic">Basic</button>
    `;

    const grid = document.createElement('div');
    grid.className = 'oneui-swatch-grid';

    const basicColors = [
        { id: 'basic_blue', color: '#3b82f6', name: 'Blue' },
        { id: 'basic_green', color: '#10b981', name: 'Green' },
        { id: 'basic_yellow', color: '#eab308', name: 'Yellow' },
        { id: 'basic_orange', color: '#f97316', name: 'Orange' },
        { id: 'basic_purple', color: '#8b5cf6', name: 'Purple' },
        { id: 'basic_pink', color: '#ec4899', name: 'Pink' },
        { id: 'basic_cyan', color: '#06b6d4', name: 'Cyan' }
    ];

    const renderSwatches = (mode) => {
        grid.innerHTML = '';
        const currentId = getUserData('colorPalette') || 'galvan';
        
        if (mode === 'wallpaper') {
            const presets = COLOR_PALETTES.filter(p => !p.id.startsWith('basic_') && p.id !== 'custom_generated');
            presets.forEach(palette => {
                const swatch = document.createElement('div');
                swatch.className = 'oneui-swatch';
                
                if (palette.preview.bubble.includes('gradient')) {
                    swatch.style.background = palette.preview.bubble;
                } else {
                    swatch.style.backgroundColor = palette.preview.bubble;
                }
                
                if (palette.id === currentId) swatch.classList.add('active');
                
                swatch.onclick = (e) => {
                    e.stopPropagation();
                    grid.querySelectorAll('.oneui-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    applyColorPalette(palette.id, true);
                };
                grid.appendChild(swatch);
            });
        } else {
            basicColors.forEach(basic => {
                const swatch = document.createElement('div');
                swatch.className = 'oneui-swatch';
                swatch.style.backgroundColor = basic.color;
                
                const customId = `custom_generated_${basic.color.replace('#','')}`;
                if (currentId === customId) {
                    swatch.classList.add('active');
                }

                swatch.onclick = (e) => {
                    e.stopPropagation();
                    grid.querySelectorAll('.oneui-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    generateAndApplyCustomTheme(basic.color);
                };
                grid.appendChild(swatch);
            });

            const dropper = document.createElement('div');
            dropper.className = 'oneui-swatch dropper';
            dropper.innerHTML = `
                <ion-icon name="color-filter"></ion-icon>
                <input type="color" class="oneui-color-input-hidden">
            `;
            
            const input = dropper.querySelector('input');
            input.addEventListener('input', (e) => {
                grid.querySelectorAll('.oneui-swatch').forEach(s => s.classList.remove('active'));
                dropper.classList.add('active');
                generateAndApplyCustomTheme(e.target.value);
            });
            input.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            grid.appendChild(dropper);
        }
    };

    const tabBtns = tabs.querySelectorAll('.oneui-tab-btn');
    tabBtns.forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const mode = btn.dataset.tab;
            if (mode === 'basic') tabs.classList.add('show-basic');
            else tabs.classList.remove('show-basic');
            renderSwatches(mode);
        };
    });

    wrapper.appendChild(tabs);
    wrapper.appendChild(grid);
    container.appendChild(wrapper);

    renderSwatches('wallpaper');
};
const generateAndApplyCustomTheme = (hexColor) => {
  const paletteId = 'custom_generated';
  const customPalette = {
    id: paletteId, name: 'Custom', preview: { bg: hexColor, bubble: `linear-gradient(135deg, ${hexColor}, ${adjustBrightness(hexColor, -20)})`, accent1: hexColor, accent2: adjustBrightness(hexColor, 20) },
    light: {
      appBodyBg: '#ffffff', appBgPrimary: '#ffffff00', appBgSecondary: adjustBrightness(hexColor, 180, 0.1), appBgTertiary: adjustBrightness(hexColor, 160, 0.2),
      appTextPrimary: adjustBrightness(hexColor, -100), appTextSecondary: adjustBrightness(hexColor, -50), appTextPlaceholder: hexColor, appBorderColor: adjustBrightness(hexColor, 0, 0.3),
      appIconPrimary: hexColor, appIconActive: adjustBrightness(hexColor, -20), appIconStatic: '#9ca3af',
      appUserMsgBg: `linear-gradient(135deg, ${hexColor}, ${adjustBrightness(hexColor, -20)})`, appBotMsgBg: '#f3f4f6',
      appLogoStop1: hexColor, appLogoStop2: adjustBrightness(hexColor, 20), appLogoStop3: adjustBrightness(hexColor, -20), appLogoGlowColor: hexColor,
      appWaveColor: `${hexColor}22`, appGreetingGrad: `linear-gradient(120deg, ${adjustBrightness(hexColor, -20)}, ${hexColor})`
    },
    dark: {
      appBodyBg: '#050505', appBgPrimary: '#00000000', appBgSecondary: adjustBrightness(hexColor, -150, 0.2), appBgTertiary: adjustBrightness(hexColor, -120, 0.3),
      appTextPrimary: '#f9fafb', appTextSecondary: adjustBrightness(hexColor, 150), appTextPlaceholder: adjustBrightness(hexColor, 50), appBorderColor: adjustBrightness(hexColor, 0, 0.3),
      appIconPrimary: adjustBrightness(hexColor, 50), appIconActive: hexColor, appIconStatic: '#4b5563',
      appUserMsgBg: `linear-gradient(135deg, ${hexColor}, ${adjustBrightness(hexColor, -30)})`, appBotMsgBg: 'rgba(255,255,255,0.08)',
      appLogoStop1: hexColor, appLogoStop2: adjustBrightness(hexColor, 40), appLogoStop3: adjustBrightness(hexColor, -40), appLogoGlowColor: hexColor,
      appWaveColor: `${hexColor}33`, appGreetingGrad: `linear-gradient(120deg, ${hexColor}, ${adjustBrightness(hexColor, 40)})`
    }
  };
  const existingIndex = COLOR_PALETTES.findIndex(p => p.id === paletteId);
  if (existingIndex > -1) COLOR_PALETTES[existingIndex] = customPalette;
  else COLOR_PALETTES.push(customPalette);
  applyColorPalette(paletteId, true);
};

function adjustBrightness(col, amt, alpha = 1) {
  let usePound = false;
  if (col[0] == "#") { col = col.slice(1); usePound = true; }
  let num = parseInt(col, 16);
  let r = (num >> 16) + amt; if (r > 255) r = 255; else if (r < 0) r = 0;
  let b = ((num >> 8) & 0x00FF) + amt; if (b > 255) b = 255; else if (b < 0) b = 0;
  let g = (num & 0x0000FF) + amt; if (g > 255) g = 255; else if (g < 0) g = 0;
  if (alpha !== 1) return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, 0);
}
if (customizeHub) {
  let lastDownX = null, lastDownY = null, dragging = false;
  let isScrolling = false, scrollTimer = null, lastScrollTime = 0;
  const startPointer = e => { lastDownX = e.clientX; lastDownY = e.clientY; dragging = false; };
  const movePointer = e => { if (lastDownX === null) return; if (Math.abs(e.clientX - lastDownX) > 6 || Math.abs(e.clientY - lastDownY) > 6) dragging = true; };
  const resetPointer = () => { lastDownX = null; lastDownY = null; dragging = false; };
  const markScroll = () => { isScrolling = true; lastScrollTime = Date.now(); clearTimeout(scrollTimer); scrollTimer = setTimeout(() => isScrolling = false, 250); };

  window.addEventListener('wheel', markScroll, { passive: true });
  window.addEventListener('scroll', markScroll, { passive: true });
  window.addEventListener('touchmove', markScroll, { passive: true });

  customizeHub.addEventListener('pointerdown', startPointer);
  customizeHub.addEventListener('pointermove', movePointer, { passive: true });
  customizeHub.addEventListener('pointerup', resetPointer);
  customizeHub.addEventListener('pointercancel', resetPointer);

  customizeHub.addEventListener('click', e => {
    if (dragging) { resetPointer(); return; }
    if (isScrolling) return;
    if (Date.now() - lastScrollTime < 300) return;
    if (e.target.closest('button,input,.galvan-switch,.galvan-color-palette-item')) return;
    if (customizeHub.classList.contains('expanded') && e.target.closest('.hub-content-layer')) return;
    if (!customizeHub.classList.contains('expanded')) {
      updateQuickHubUI();
      renderQuickPalettes();
      customizeHub.classList.add('expanded');
      if (hub && hub.classList.contains('expanded')) hub.classList.remove('expanded');
      if (historyHub && historyHub.classList.contains('expanded')) historyHub.classList.remove('expanded');
      requestAnimationFrame(() => updateViewportHeight('view-settings'));
    } else {
      customizeHub.classList.remove('expanded');
    }
  });

  if (customizeCloseBtn) {
    customizeCloseBtn.addEventListener('click', e => { e.stopPropagation(); customizeHub.classList.remove('expanded'); });
  }
}

if (quickDarkModeToggle) {
  quickDarkModeToggle.addEventListener('change', (e) => {
    applyLightDarkMode(!e.target.checked, true);
    saveLightDarkModePreference();
  });
}

if (quickBlurSlider) {
  quickBlurSlider.addEventListener('input', (e) => {
    applyBlurIntensity(e.target.value);
    quickBlurValue.textContent = `${parseFloat(e.target.value).toFixed(1)}x`;
    updateSliderFill(e.target);
    if (document.getElementById('setting-blur-slider')) {
      document.getElementById('setting-blur-slider').value = e.target.value;
      updateSliderFill(document.getElementById('setting-blur-slider'));
    }
  });
}

if (quickSuggestionsToggle) {
  quickSuggestionsToggle.addEventListener('change', (e) => {
    setUserData('showSuggestions', e.target.checked);
    body.classList.toggle('hide-suggestions', !e.target.checked);
    const mainSwitch = document.getElementById('setting-toggle-suggestions');
    if (mainSwitch) mainSwitch.checked = e.target.checked;
  });
}

if (quickResetBtn) {
  quickResetBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const confirmed = await showGalvanConfirm("Reset App?", "Restore default settings?", true);
    if (confirmed) {
      performResetAll();
      customizeHub.classList.remove('expanded');
    }
  });
}

const historyHubEl = document.getElementById('galvan-history-hub');
const historyListContainer = document.getElementById('history-list-container');
const historyCloseBtn = document.getElementById('history-close-btn');
const historyClearBtn = document.getElementById('history-clear-btn');

const formatHistoryDate = (timestamp) => {
  const date = new Date(timestamp);
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === today.toDateString()) return 'Today';
  if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
  return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
};

if (historyHubEl) {
  historyHubEl.addEventListener('click', (e) => {
    if (e.target.closest('.hub-content-layer') && !e.target.closest('button')) return;
    if (!historyHubEl.classList.contains('expanded')) {
      if (customizeHub && customizeHub.classList.contains('expanded')) customizeHub.classList.remove('expanded');
      if (hub && hub.classList.contains('expanded')) hub.classList.remove('expanded');
      renderHistoryHubList();
      historyHubEl.classList.add('expanded');
    } else {
      historyHubEl.classList.remove('expanded');
    }
  });
}

if (historyCloseBtn) {
  historyCloseBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    historyHubEl.classList.remove('expanded');
  });
}

if (historyClearBtn) {
  historyClearBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const confirmed = await showGalvanConfirm("Clear All?", "Delete entire chat history?", true);
    if (confirmed) {
      clearAllChatHistory();
      renderHistoryHubList();
    }
  });
}

const verticalSuggestionData = [
  { text: "Analyze this document", desc: "Extract key insights & summary", icon: "document-text-outline", trigger: "doc" },
  { text: "Fix my code", desc: "Debug and optimize syntax", icon: "bug-outline", trigger: "fix" },
  { text: "Generate Image", desc: "Create visuals from text", icon: "image-outline", trigger: "img" },
  { text: "Draft an Email", desc: "Professional communication", icon: "mail-open-outline", trigger: "mail" },
  { text: "Explain concept", desc: "Simplify complex topics", icon: "bulb-outline", trigger: "explain" },
  { text: "Translate text", desc: "Convert to another language", icon: "language-outline", trigger: "trans" },
  { text: "Write Python script", desc: "Automation and logic", icon: "logo-python", trigger: "py" },
  { text: "Design System", desc: "UI/UX principles & components", icon: "color-palette-outline", trigger: "ui" }
];

const verticalSuggestionsList = document.getElementById('suggestions-list-content');
const promptFormContainer = document.querySelector('.galvan-prompt-form');

const renderVerticalSuggestions = (filterText = "") => {
  verticalSuggestionsList.innerHTML = "";
  const filtered = filterText ? verticalSuggestionData.filter(s => s.text.toLowerCase().includes(filterText.toLowerCase()) || s.trigger.includes(filterText.toLowerCase())) : verticalSuggestionData;
  if (filtered.length === 0) {
    promptFormContainer.classList.remove('suggestions-active');
    return;
  }
  filtered.slice(0, 5).forEach((item, index) => {
    const row = document.createElement('div');
    row.className = 'vertical-suggestion-item';
    row.style.animation = `listGlideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) ${index * 0.06}s backwards`;
    row.innerHTML = `
      <div class="sugg-icon-box"><ion-icon name="${item.icon}"></ion-icon></div>
      <div class="sugg-text-content">
        <span class="sugg-title">${item.text}</span>
        <span class="sugg-desc">${item.desc}</span>
      </div>
      <div class="sugg-arrow"><ion-icon name="arrow-up-circle-outline" style="font-size: 24px;"></ion-icon></div>`;
    row.addEventListener('click', (e) => {
      e.stopPropagation();
      applyVerticalSuggestion(item.text);
    });
    verticalSuggestionsList.appendChild(row);
  });
  promptFormContainer.classList.add('suggestions-active');
};

const applyVerticalSuggestion = (text) => {
  const currentValue = promptInput.value;
  const separator = currentValue.length > 0 && !currentValue.endsWith(' ') ? ' ' : '';
  promptInput.value = currentValue + separator + text;
  promptInput.focus();
  promptInput.dispatchEvent(new Event('input'));
  promptFormContainer.classList.remove('suggestions-active');
};

promptInput.addEventListener('focus', () => {
  if (promptInput.value.trim() === "") renderVerticalSuggestions("");
});

promptInput.addEventListener('input', () => {
  const val = promptInput.value.trim();
  renderVerticalSuggestions(val);
});

document.addEventListener('click', (e) => {
  if (!promptFormContainer.contains(e.target)) promptFormContainer.classList.remove('suggestions-active');
});

promptFormContainer.addEventListener('submit', () => {
  promptFormContainer.classList.remove('suggestions-active');
});

const renderHistoryHubList = () => {
  const historyListContainer = document.getElementById('history-list-container');
  const internalClearBtn = document.getElementById('internal-history-clear');
  if (!historyListContainer) return;
  historyListContainer.innerHTML = '';
  const fullHistory = getUserData('chatHistory') || [];
  const userTurns = fullHistory.map((entry, index) => {
    if (entry.role === 'user') return { ...entry, originalIndex: index };
    return null;
  }).filter(item => item !== null).reverse();
  if (internalClearBtn) {
    internalClearBtn.style.display = userTurns.length === 0 ? 'none' : 'block';
  }
  if (userTurns.length === 0) {
    historyListContainer.innerHTML = `<div class="hub-empty-state" style="padding:40px 0; text-align:center; opacity:0.6;">
      <ion-icon name="chatbox-ellipses-outline" style="font-size:24px; margin-bottom:8px;"></ion-icon>
      <div>No conversations yet</div>
    </div>`;
    return;
  }
  userTurns.forEach((turn, animIndex) => {
    const turnText = turn.parts.find(p => p.text)?.text || "File Attachment";
    const card = document.createElement('div');
    card.className = 'galvan-history-entry';
    card.style.animationDelay = `${animIndex * 0.04}s`;
    card.innerHTML = `
      <div class="history-icon-box"><ion-icon name="chatbubble-outline"></ion-icon></div>
      <div class="history-info">
        <div class="history-text">${escapeHtml(turnText)}</div>
        <div class="history-meta">${formatHistoryDate(turn.timestamp)}</div>
      </div>
      <button class="history-delete-btn" style="background:transparent; border:none; opacity:0.6;"><ion-icon name="chevron-forward"></ion-icon></button>`;
    card.addEventListener('click', () => {
      let endIndex = turn.originalIndex;
      if (fullHistory[turn.originalIndex + 1] && fullHistory[turn.originalIndex + 1].role === 'model') endIndex = turn.originalIndex + 1;
      loadChatTurnIntoSession(turn.originalIndex, endIndex);
      if (customizeHub) customizeHub.classList.remove('expanded');
      if (historyHubEl) historyHubEl.classList.remove('expanded');
    });
    historyListContainer.appendChild(card);
  });
};

const promptFormEl = document.querySelector('.galvan-prompt-form');
const attachmentMenuEl = document.getElementById('attachment-menu');
const cameraInput = document.getElementById('camera-input');
const galleryInput = document.getElementById('gallery-input');
const btnOptCamera = document.getElementById('btn-opt-camera');
const btnOptGallery = document.getElementById('btn-opt-gallery');
const btnOptFiles = document.getElementById('btn-opt-files');

const existingAddBtn = document.getElementById('add-file-btn');
const newAddBtn = existingAddBtn.cloneNode(true);
existingAddBtn.parentNode.replaceChild(newAddBtn, existingAddBtn);
const finalAddFileBtn = document.getElementById('add-file-btn');
finalAddFileBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  e.preventDefault();
  
  const isCurrentlyActive = promptFormEl.classList.contains('attachment-active');
  
  if (isCurrentlyActive) {
    closeAttachmentMenu();
  } else {
    promptFormEl.classList.remove('suggestions-active');
    promptFormEl.classList.add('attachment-active');
    
    const listEl = promptFormEl.querySelector('.galvan-attachment-list');
    if(listEl) void listEl.offsetHeight; 

    if(window.FxFilter) window.FxFilter.scanElements();
    
    const iconAdd = finalAddFileBtn.querySelector('.icon-add');
    if (iconAdd) iconAdd.style.transform = 'rotate(45deg)';
  }
});
function closeAttachmentMenu() {
  promptFormEl.classList.remove('attachment-active');
  const iconAdd = finalAddFileBtn.querySelector('.icon-add');
  if (iconAdd) iconAdd.style.transform = 'rotate(0deg)';
}

promptInput.addEventListener('input', () => {
  if (promptInput.value.trim().length > 0) closeAttachmentMenu();
});

document.addEventListener('click', (e) => {
  if (!attachmentMenuEl.contains(e.target) && !finalAddFileBtn.contains(e.target)) closeAttachmentMenu();
});

const processSelectedFile = (file) => {
  if (!file) return;
  const MAX_FILE_SIZE = 15 * 1024 * 1024;
  if (file.size > MAX_FILE_SIZE) {
   return;
  }
  const isImage = file.type.startsWith("image/");
  const reader = new FileReader();
  reader.onload = (e) => {
    const base64String = e.target.result.split(",")[1];
    const safeFileName = file.name.replace(/</g, "<").replace(/>/g, ">");
    if (fileNameElement) fileNameElement.textContent = safeFileName;
    if (isImage) {
      filePreviewImage.src = e.target.result;
      filePreviewImage.style.display = 'block';
      filePreviewIconSVG.style.display = 'none';
    } else {
      filePreviewIconSVG.innerHTML = getFileIconSVG(file.type, file.name);
      filePreviewImage.style.display = 'none';
      filePreviewIconSVG.style.display = 'inline-block';
    }
    fileUploadWrapper.classList.add("active");
    userData.file = { fileName: file.name, data: base64String, mime_type: file.type || 'application/octet-stream', isImage };
    if (!body.classList.contains("bot-responding")) sendBtn.disabled = false;
    fileInput.value = "";
    cameraInput.value = "";
    galleryInput.value = "";
  };
  reader.readAsDataURL(file);
  closeAttachmentMenu();
};

const allAttachInputs = [fileInput, cameraInput, galleryInput];
allAttachInputs.forEach(input => {
  if (input) {
    const newInp = input.cloneNode(true);
    input.parentNode.replaceChild(newInp, input);
    if (input.id === 'file-input') window.fileInput = newInp;
    newInp.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) processSelectedFile(e.target.files[0]);
    });
  }
});

const activeCameraInput = document.getElementById('camera-input');
const activeGalleryInput = document.getElementById('gallery-input');
const activeFileInput = document.getElementById('file-input');

btnOptCamera.onclick = (e) => { e.stopPropagation(); activeCameraInput.click(); };
btnOptGallery.onclick = (e) => { e.stopPropagation(); activeGalleryInput.click(); };
btnOptFiles.onclick = (e) => { e.stopPropagation(); activeFileInput.click(); };

let isIncognitoMode = false;
const incognitoBtn = document.getElementById('incognito-btn');

if (incognitoBtn) {
  incognitoBtn.addEventListener('click', () => {
    isIncognitoMode = !isIncognitoMode;
    incognitoBtn.classList.toggle('active', isIncognitoMode);
    document.body.classList.toggle('incognito-mode', isIncognitoMode);
    const icon = incognitoBtn.querySelector('ion-icon');
    icon.setAttribute('name', isIncognitoMode ? 'shield-half-outline' : 'shield-half-outline');
  });
}

function getDisplacementMap({ height, width, radius, depth }) {
  const svg = `<svg height="${height}" width="${width}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
    <style>.mix{mix-blend-mode:screen}</style>
    <defs>
      <linearGradient id="Y" x1="0" x2="0" y1="${Math.ceil((radius / height) * 15)}%" y2="${Math.floor(100 - (radius / height) * 15)}%">
        <stop offset="0%" stop-color="#0F0"/>
        <stop offset="100%" stop-color="#000"/>
      </linearGradient>
      <linearGradient id="X" x1="${Math.ceil((radius / width) * 15)}%" x2="${Math.floor(100 - (radius / width) * 15)}%" y1="0" y2="0">
        <stop offset="0%" stop-color="#F00"/>
        <stop offset="100%" stop-color="#000"/>
      </linearGradient>
    </defs>
    <rect x="0" y="0" height="${height}" width="${width}" fill="#808080"/>
    <g filter="blur(2px)">
      <rect x="0" y="0" height="${height}" width="${width}" fill="#000080"/>
      <rect x="0" y="0" height="${height}" width="${width}" fill="url(#Y)" class="mix"/>
      <rect x="0" y="0" height="${height}" width="${width}" fill="url(#X)" class="mix"/>
      <rect x="${depth}" y="${depth}" height="${height - 2 * depth}" width="${width - 2 * depth}" fill="#808080" rx="${radius}" ry="${radius}" filter="blur(${depth}px)"/>
    </g>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}

function getDisplacementFilter({ height, width, radius, depth, strength = 100, chromaticAberration = 0 }) {
  const displacementMapUrl = getDisplacementMap({ height, width, radius, depth });
  const svg = `<svg height="${height}" width="${width}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <filter id="displace" color-interpolation-filters="sRGB">
        <feImage x="0" y="0" height="${height}" width="${width}" href="${displacementMapUrl}" result="displacementMap"/>
        <feDisplacementMap in="SourceGraphic" in2="displacementMap" scale="${strength + chromaticAberration * 2}" xChannelSelector="R" yChannelSelector="G"/>
        <feColorMatrix type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="displacedR"/>
        <feDisplacementMap in="SourceGraphic" in2="displacementMap" scale="${strength + chromaticAberration}" xChannelSelector="R" yChannelSelector="G"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="displacedG"/>
        <feDisplacementMap in="SourceGraphic" in2="displacementMap" scale="${strength}" xChannelSelector="R" yChannelSelector="G"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="displacedB"/>
        <feBlend in="displacedR" in2="displacedG" mode="screen"/>
        <feBlend in2="displacedB" mode="screen"/>
      </filter>
    </defs>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg) + "#displace";
}

window.DisplacementUtils = { getDisplacementMap, getDisplacementFilter };

document.addEventListener('DOMContentLoaded', () => {
  const scrollers = document.querySelectorAll('.customize-scroll-content, .history-list-scroll, .suggestions-vertical-list');
  scrollers.forEach(s => {
    s.style.touchAction = s.style.touchAction || 'pan-y';
    s.addEventListener('touchstart', (ev) => {
      s._startY = ev.touches ? ev.touches[0].clientY : 0;
    }, { passive: true });
    s.addEventListener('touchmove', (ev) => {
      ev.stopPropagation();
    }, { passive: false });
  });
});

let scrollTimer;
const panel = document.querySelector('.customize-panel');
if (panel) {
  panel.addEventListener('scroll', () => {
    panel.classList.add('is-scrolling');
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(() => panel.classList.remove('is-scrolling'), 120);
  }, { passive: true });
}

const PIN_KEY = "galvan_secure_pin_v1";
const elements = {
  hub: document.getElementById('galvan-lock-hub'),
  closeBtn: document.getElementById('lock-close-btn'),
  blocker: document.getElementById('galvan-app-blocker'),
  statusTitle: document.getElementById('pin-status-text'),
  statusSub: document.getElementById('pin-sub-text'),
  dots: document.querySelectorAll('.pin-dot'),
  keys: document.querySelectorAll('.pin-key'),
  resetBtn: document.getElementById('lock-reset-flow'),
  mainIcon: document.querySelector('.lock-main-icon'),
  dotsContainer: document.getElementById('pin-dots'),
  headerSection: document.querySelector('.lock-header-section'),
  interfaceWrapper: document.querySelector('.pin-interface-wrapper'),
  internalLoader: document.getElementById('lock-internal-loader'),
  loaderText: document.getElementById('lock-loader-text'),
  loaderSub: document.getElementById('lock-loader-sub')
};

let state = { mode: 'IDLE', input: '', tempPin: null, isLocked: false };
const bioBtn = document.getElementById('biometric-btn');
const BIO_STORAGE_KEY = 'galvan_bio_enabled';

class BiometricShield {
    constructor() {
        this.available = false;
        this.init();
    }

    async init() {
        if (window.PublicKeyCredential && await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()) {
            this.available = true;
            this.updateUI();
        }
    }

    updateUI() {
        const isEnabled = localStorage.getItem(BIO_STORAGE_KEY) === 'true';
        if (this.available && bioBtn) {
            bioBtn.style.display = 'flex';
            const icon = bioBtn.querySelector('ion-icon');
            const span = bioBtn.querySelector('span');
            if (isEnabled) {
                if(icon) icon.setAttribute('name', 'finger-print');
                if(span) span.textContent = 'Unlock with FaceID/TouchID';
                bioBtn.onclick = () => this.authenticate();
            } else {
                if(icon) icon.setAttribute('name', 'add-circle-outline');
                if(span) span.textContent = 'Enable Biometrics';
                bioBtn.onclick = () => this.register();
            }
        } else {
            if (bioBtn) bioBtn.style.display = 'none';
        }
    }

    async register() {
        if (!this.available) return;
        
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);
        
        const userId = new Uint8Array(16);
        window.crypto.getRandomValues(userId);

        const options = {
            publicKey: {
                challenge: challenge,
                rp: { name: "Galvan Secure" },
                user: {
                    id: userId,
                    name: "galvan_user",
                    displayName: "Galvan User"
                },
                pubKeyCredParams: [
                    { type: "public-key", alg: -7 },
                    { type: "public-key", alg: -257 }
                ],
                authenticatorSelection: {
                    authenticatorAttachment: "platform",
                    userVerification: "required",
                    requireResidentKey: false
                },
                timeout: 60000,
                attestation: "none"
            }
        };

        try {
            await navigator.credentials.create(options);
            localStorage.setItem(BIO_STORAGE_KEY, 'true');
            if(typeof updateText === 'function') updateText("Success", "Biometrics Enabled");
            this.updateUI();
            setTimeout(() => {
                if(typeof lockApp === 'function') lockApp();
            }, 500);
        } catch (err) {
            if(typeof triggerError === 'function') triggerError("Setup Failed", "Cancelled or Error");
        }
    }

    async authenticate() {
        if (!this.available) return;

        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);

        const options = {
            publicKey: {
                challenge: challenge,
                rpId: window.location.hostname === 'localhost' ? 'localhost' : undefined,
                userVerification: "required",
                timeout: 60000
            }
        };

        try {
            const assertion = await navigator.credentials.get(options);
            if (assertion) {
                if(typeof unlockApp === 'function') unlockApp();
            }
        } catch (err) {
            if(typeof triggerError === 'function') triggerError("Failed", "Use PIN");
        }
    }

    async autoPrompt() {
        if (this.available && localStorage.getItem(BIO_STORAGE_KEY) === 'true') {
            await this.authenticate();
        }
    }
}

const bioShield = new BiometricShield();

function initLockSystem() {
    const storedPin = localStorage.getItem(PIN_KEY);
    
    if (storedPin) {
        lockApp();
        setTimeout(() => {
            bioShield.updateUI();
            bioShield.autoPrompt();
        }, 300);
    } else {
        setMode('SETUP_1');
    }
}function setMode(newMode) {
  state.mode = newMode;
  clearInput();
  if (state.mode === 'SETUP_1' || state.mode === 'SETUP_2') {
    if (elements.resetBtn) elements.resetBtn.style.display = 'none';
  } else {
    if (elements.resetBtn) elements.resetBtn.style.display = 'block';
  }
  switch (newMode) {
    case 'SETUP_1': updateText("Set Passcode", "Create a 4-digit PIN"); break;
    case 'SETUP_2': updateText("Confirm", "Re-enter to verify"); break;
    case 'LOCKED': updateText("Locked", "Enter Passcode"); break;
  }
}

function lockApp() {
  state.isLocked = true;
  setMode('LOCKED');
  if (elements.hub) elements.hub.classList.add('expanded');
  if (elements.blocker) elements.blocker.classList.add('active');
  document.body.classList.add('app-locked');
  if (elements.mainIcon) {
    elements.mainIcon.setAttribute('name', 'lock-closed');
    elements.mainIcon.style.color = "var(--current-text-primary)";
  }
}

function unlockApp() {
  state.isLocked = false;
  if (elements.mainIcon) {
    elements.mainIcon.setAttribute('name', 'lock-open');
    elements.mainIcon.style.color = "var(--current-like-color)";
  }
  updateText("Unlocked", "Welcome back");
  setTimeout(() => {
    if (elements.hub) elements.hub.classList.remove('expanded');
    if (elements.blocker) elements.blocker.classList.remove('active');
    document.body.classList.remove('app-locked');
    clearInput();
    if (elements.mainIcon) {
      elements.mainIcon.style.color = "";
      elements.mainIcon.setAttribute('name', 'lock-closed');
    }
  }, 800);
}

function handleInput(val) {
  if (state.input.length < 4) {
    state.input += val;
    renderDots();
    if (state.input.length === 4) setTimeout(processSubmission, 100);
  }
}

function processSubmission() {
  const input = state.input;
  if (state.mode === 'SETUP_1') {
    state.tempPin = input;
    setMode('SETUP_2');
  } else if (state.mode === 'SETUP_2') {
    if (input === state.tempPin) {
  localStorage.setItem(PIN_KEY, input);
  updateText("Success", "Passcode Set");
  
  if (bioShield.available) {
      showGalvanConfirm("Enable Biometrics?", "Secure with FaceID/TouchID?", false)
      .then(confirmed => {
          if(confirmed) {
              bioShield.register();
          } else {
              setTimeout(lockApp, 500);
          }
      });
  } else {
      setTimeout(lockApp, 500);
  }
    
      checkBiometricAvailability().then(available => {
          if(available) {
               showGalvanConfirm("Enable Biometrics?", "Use FaceID/TouchID to unlock?", false)
               .then(confirmed => {
                   if(confirmed) {
                       registerBiometric().then(() => {
                           setTimeout(lockApp, 500);
                       });
                   } else {
                       setTimeout(lockApp, 500);
                   }
               });
          } else {
              setTimeout(lockApp, 500);
          }
      });

    } else {
      triggerError("Mismatch", "Try again");
      setTimeout(() => setMode('SETUP_1'), 1000);
    }
  } else if (state.mode === 'LOCKED') {
    const stored = localStorage.getItem(PIN_KEY);
    if (input === stored) unlockApp();
    else {
      triggerError("Incorrect", "Try again");
      clearInput();
    }
  }
}

function deleteDigit() {
  if (state.input.length > 0) {
    state.input = state.input.slice(0, -1);
    renderDots();
  }
}

document.addEventListener('keydown', (e) => {
  if (!elements.hub.classList.contains('expanded')) return;
  if (e.key >= '0' && e.key <= '9') handleInput(e.key);
  if (e.key === 'Backspace') deleteDigit();
  if (e.key === 'Enter' && state.input.length === 4) processSubmission();
});

if (elements.resetBtn) {
  elements.resetBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const confirmed = await showGalvanConfirm("Factory Reset?", "Wipe PIN & History?", true);
    if (confirmed) startFactoryResetSequence();
  });
}

function startFactoryResetSequence() {
  if (elements.headerSection) elements.headerSection.style.display = 'none';
  if (elements.interfaceWrapper) elements.interfaceWrapper.style.display = 'none';
  if (elements.internalLoader) elements.internalLoader.style.display = 'flex';
  const sequence = [
    { t: 0, title: "Authenticating...", sub: "Verifying secure enclave" },
    { t: 1500, title: "Wiping Data...", sub: "Removing chat history" },
    { t: 3000, title: "Clearing Keys...", sub: "Resetting security PIN" },
    { t: 4000, title: "Restoring...", sub: "Applying default settings" },
    { t: 5000, title: "Complete", sub: "Rebooting System" }
  ];
  sequence.forEach(step => {
    setTimeout(() => {
      if (elements.loaderText) elements.loaderText.textContent = step.title;
      if (elements.loaderSub) elements.loaderSub.textContent = step.sub;
      if (step.t === 5000) performSystemWipe();
    }, step.t);
  });
}
function performSystemWipe() {
  localStorage.removeItem(PIN_KEY);
  localStorage.removeItem(BIOMETRIC_KEY); 
  localStorage.removeItem('galvanAi_v30_settings');
  localStorage.clear();
  window.location.reload();
}
function updateText(title, sub) {
  if (elements.statusTitle) {
    elements.statusTitle.textContent = title;
    elements.statusTitle.style.color = "";
  }
  if (elements.statusSub) elements.statusSub.textContent = sub;
}

function renderDots() {
  if (elements.dots) {
    elements.dots.forEach((dot, index) => {
      dot.classList.toggle('filled', index < state.input.length);
      dot.classList.remove('error');
    });
  }
}

function clearInput() {
  state.input = "";
  renderDots();
}

function triggerError(msgTitle, msgSub) {
  if (elements.dotsContainer) {
    elements.dotsContainer.style.animation = 'none';
    elements.dotsContainer.offsetHeight;
    elements.dotsContainer.style.animation = 'shakeError 0.4s ease-in-out';
  }
  if (elements.dots) elements.dots.forEach(d => d.classList.add('error'));
  if (elements.statusTitle) {
    elements.statusTitle.style.color = "var(--current-dislike-color)";
    if (msgTitle) elements.statusTitle.textContent = msgTitle;
  }
  if (elements.statusSub && msgSub) elements.statusSub.textContent = msgSub;
  if (navigator.vibrate) navigator.vibrate(200);
}

if (elements.hub) {
  elements.hub.addEventListener('click', (e) => {
    if (e.target.closest('.lock-content-layer')) return;
    if (!elements.hub.classList.contains('expanded')) {
      if (!localStorage.getItem(PIN_KEY)) setMode('SETUP_1');
      else if (!state.isLocked) lockApp();
      elements.hub.classList.add('expanded');
    }
  });
}

if (elements.closeBtn) {
  elements.closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (state.isLocked) triggerError("Locked", "Auth Required");
    else {
      elements.hub.classList.remove('expanded');
      if (state.mode.includes('SETUP')) setMode('SETUP_1');
    }
  });
}

if (elements.keys) {
  elements.keys.forEach(key => {
    key.addEventListener('click', (e) => {
      e.stopPropagation();
      if (key.classList.contains('delete')) deleteDigit();
      else if (key.classList.contains('confirm') && state.input.length === 4) processSubmission();
      else {
        const val = key.dataset.val;
        if (val !== undefined) handleInput(val);
      }
    });
  });
}

initLockSystem();

document.addEventListener('DOMContentLoaded', () => {
    const sector = document.getElementById('hub-notice-sector');
    const trigger = document.getElementById('notice-trigger');
    const btn = document.getElementById('spatial-install-btn');
    
    if (trigger && sector) {
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isActive = sector.classList.toggle('active');
            if (isActive) {
                setTimeout(() => {
                    sector.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        });
    }

    if (btn) {
        let holdTimer;
        let isComplete = false;

        const startHold = (e) => {
            if (isComplete) return;
            e.preventDefault();
            btn.classList.add('held');
            
            holdTimer = setTimeout(() => {
                isComplete = true;
                btn.classList.remove('held');
                btn.classList.add('complete');
                if(navigator.vibrate) navigator.vibrate(50);
            }, 1500);
        };

        const endHold = (e) => {
            if (isComplete) return;
            clearTimeout(holdTimer);
            btn.classList.remove('held');
        };

        btn.addEventListener('mousedown', startHold);
        btn.addEventListener('touchstart', startHold);
        
        btn.addEventListener('mouseup', endHold);
        btn.addEventListener('mouseleave', endHold);
        btn.addEventListener('touchend', endHold);
    }
});
const modalsToFix = ['galvan-confirm-modal', 'galvan-reset-overlay'];
modalsToFix.forEach(id => {
    const element = document.getElementById(id);
    if (element && element.parentNode !== document.body) {
        document.body.appendChild(element);
    }
});
const newChatBtn = document.getElementById('new-chat-btn');

if (newChatBtn) {
    newChatBtn.addEventListener('click', () => {
        if (body.classList.contains("bot-responding")) {
            stopResponseGeneration();
        }

        currentChatSession = [];
        messageCounter = 0;
        messageBeingEditedTimestamp = null;
        promptHistoryIndex = -1;

        renderChatHistoryToDOM([]);
        
        promptInput.value = '';
        promptInput.style.height = 'auto';
        userData.file = {};
        fileUploadWrapper.classList.remove("active");
        if (fileNameElement) fileNameElement.textContent = "";
        
        body.classList.add('chats-active');
        if (chatPlaceholder) chatPlaceholder.classList.add('visible');
        updateTopNavVisuals('chats');
        
        resetSendButton();
        sendBtn.disabled = true;

        promptInput.focus();
    });
}
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    
    const text = unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");

    return text.replace(/javascript:/gi, "blocked:")
               .replace(/on\w+=/gi, "blocked-event=");
}
(function() {
    const hub = document.getElementById('quick-actions-hub');
    const oldTrigger = document.getElementById('new-chat-btn');
    const triggerBtn = oldTrigger.cloneNode(true);
    oldTrigger.parentNode.replaceChild(triggerBtn, oldTrigger);

    const listContainer = document.getElementById('qa-list');
    const closeBtn = document.getElementById('qa-close');
    const clearBtn = document.getElementById('qa-clear');
    const addPageBtn = document.getElementById('qa-add-page'); 
    
    let isExpanded = false;
    let initialRect = null;
    const STORAGE_KEY = 'galvanAi_v30_settings';

    function getHistory() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)).chatHistory || []; } catch { return []; }
    }
    function saveHistory(h) {
        try {
            const s = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            s.chatHistory = h;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        } catch {}
    }

    function renderContent() {
        listContainer.innerHTML = '';
        const history = getHistory();
        const chats = history.map((c, i) => ({...c, idx: i})).filter(c => c.role === 'user').reverse();

        if (chats.length === 0) {
            listContainer.innerHTML = '<div class="qa-empty">No Recent Chats</div>';
            return;
        }

        chats.slice(0, 8).forEach((chat, index) => {
            const item = document.createElement('div');
            item.className = 'qa-list-item';
            item.style.animationDelay = `${0.15 + (index * 0.05)}s`;
            
            const txt = chat.parts[0]?.text || "Attachment";
            item.innerHTML = `
                <ion-icon name="chatbubble-outline" class="qa-list-icon"></ion-icon>
                <span class="qa-list-text">${txt}</span>
                <button class="qa-list-delete"><ion-icon name="close"></ion-icon></button>
            `;

            item.querySelector('.qa-list-delete').addEventListener('click', (e) => {
                e.stopPropagation();
                item.style.transform = 'scale(0.9) translateX(-10px)';
                item.style.opacity = '0';
                item.style.height = '0';
                item.style.margin = '0';
                item.style.padding = '0';
                setTimeout(() => {
                    const curHist = getHistory();
                    let end = chat.idx;
                    if(curHist[end+1] && curHist[end+1].role === 'model') end++;
                    curHist.splice(chat.idx, (end - chat.idx + 1));
                    saveHistory(curHist);
                    if(typeof loadFullChatHistoryFromStorage === 'function') loadFullChatHistoryFromStorage();
                    renderContent(); 
                }, 300);
            });

            item.addEventListener('click', () => {
                if(typeof loadChatTurnIntoSession === 'function') {
                    const curHist = getHistory();
                    let end = chat.idx;
                    if(curHist[end+1] && curHist[end+1].role === 'model') end++;
                    loadChatTurnIntoSession(chat.idx, end);
                    collapse();
                }
            });
            listContainer.appendChild(item);
        });
    }

    function expand() {
        if(isExpanded) return;
        isExpanded = true;
        renderContent();

        const rect = triggerBtn.getBoundingClientRect();
        initialRect = rect; 

        hub.style.transition = 'none';
        hub.style.top = `${rect.top}px`;
        hub.style.left = `${rect.left}px`;
        hub.style.width = `${rect.width}px`;
        hub.style.height = `${rect.height}px`;
        hub.style.borderRadius = '50%';
        hub.style.opacity = '1';
        
        hub.offsetHeight; 

        requestAnimationFrame(() => {
            hub.style.transition = ''; 
            
            triggerBtn.style.transition = 'opacity 0.1s, transform 0.2s';
            triggerBtn.style.opacity = '0';
            triggerBtn.style.transform = 'scale(0.5) rotate(-90deg)';

            const w = 280;
            const h = Math.min(400, window.innerHeight * 0.5);
            
            const screenW = window.innerWidth;
            let l, t;
            
            t = rect.top - h + rect.height;
            if (t < 20) t = rect.bottom + 10;

            const btnCenter = rect.left + (rect.width / 2);
            l = btnCenter - (w / 2);

            if (l < 16) l = 16;
            if (l + w > screenW - 16) l = screenW - w - 16;

            hub.classList.add('active');
            
            hub.style.width = `${w}px`;
            hub.style.height = `${h}px`;
            hub.style.top = `${t}px`;
            hub.style.left = `${l}px`;
            hub.style.borderRadius = '24px';
        });
    }

    function collapse() {
        if(!isExpanded) return;
        isExpanded = false;
        
        hub.classList.remove('active');

        if(initialRect) {
            hub.style.width = `${initialRect.width}px`;
            hub.style.height = `${initialRect.height}px`;
            hub.style.top = `${initialRect.top}px`;
            hub.style.left = `${initialRect.left}px`;
            hub.style.borderRadius = '50%';
        }

        setTimeout(() => {
            hub.style.opacity = '0';
            triggerBtn.style.transition = 'opacity 0.1s ease-out, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
            triggerBtn.style.opacity = '1';
            triggerBtn.style.transform = 'scale(1) rotate(0deg)';
        }, 250);
    }

    triggerBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if(isExpanded) collapse();
        else expand();
    });

    closeBtn.addEventListener('click', collapse);
    
    clearBtn.addEventListener('click', async () => {
        const confirmed = await showGalvanConfirm(
            "Clear History?", 
            "This will delete all recent chats permanently.", 
            true
        );
        
        if (confirmed) {
            saveHistory([]);
            renderContent();
            if(typeof clearAllChatHistory === 'function') clearAllChatHistory();
        }
    });

    addPageBtn.addEventListener('click', () => {
        if(typeof stopResponseGeneration === 'function') stopResponseGeneration();
        
        if(typeof currentChatSession !== 'undefined') currentChatSession = [];
        if(typeof renderChatHistoryToDOM === 'function') renderChatHistoryToDOM([]);
        
        const promptInput = document.querySelector('.prompt-input');
        if(promptInput) {
            promptInput.value = '';
            promptInput.focus();
        }

        collapse();
        
        const ph = document.getElementById('galvan-chat-placeholder');
        if(ph) ph.classList.add('visible');
    });

    document.addEventListener('click', (e) => {
        if(isExpanded && !hub.contains(e.target) && !triggerBtn.contains(e.target)) {
            collapse();
        }
    });
})();
(function() {
    const UI = {
        layer: document.getElementById('galvan-wallpaper-layer'),
        input: document.getElementById('wp-file-input'),
        trigger: document.getElementById('wp-upload-trigger'),
        uploadBtn: document.getElementById('wp-upload-btn'),
        removeBtn: document.getElementById('wp-remove-btn'),
        previewImg: document.getElementById('wp-preview-img'),
        statusText: document.getElementById('wp-status-text'),
        blurSection: document.getElementById('wp-blur-section'),
        blurSlider: document.getElementById('wp-blur-slider'),
        blurVal: document.getElementById('wp-blur-val'),
        previewCard: document.querySelector('.premium-preview-card')
    };

    const KEYS = {
        BLUR: 'galvan_wallpaper_blur'
    };

    const DB_CONFIG = {
        NAME: 'GalvanMediaDB',
        VERSION: 1,
        STORE: 'wallpapers',
        KEY: 'current_wallpaper'
    };

    let activeObjectUrl = null;
    let loaderOverlay = null;
    let progressFill = null;
    let statusLabel = null;

    function initLoader() {
        if (!UI.previewCard) return;
        const existing = UI.previewCard.querySelector('.wp-loader-overlay');
        if (existing) existing.remove();

        loaderOverlay = document.createElement('div');
        loaderOverlay.className = 'wp-loader-overlay';
        loaderOverlay.innerHTML = `
            <div class="wp-spinner"></div>
            <div class="wp-loading-text">Initializing</div>
            <div class="wp-progress-track"><div class="wp-progress-fill"></div></div>
        `;
        UI.previewCard.appendChild(loaderOverlay);
        if(window.FxFilter) window.FxFilter.scanElements();
        progressFill = loaderOverlay.querySelector('.wp-progress-fill');
        statusLabel = loaderOverlay.querySelector('.wp-loading-text');
    }

    function setLoaderState(active, text = 'Processing', progress = 0) {
        if (!UI.previewCard || !loaderOverlay) return;
        if (active) {
            UI.previewCard.classList.add('is-loading');
            if (statusLabel) statusLabel.textContent = text;
            if (progressFill) progressFill.style.width = `${progress}%`;
        } else {
            if (progressFill) progressFill.style.width = '100%';
            setTimeout(() => {
                UI.previewCard.classList.remove('is-loading');
                setTimeout(() => { if (progressFill) progressFill.style.width = '0%'; }, 400);
            }, 500);
        }
    }

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_CONFIG.NAME, DB_CONFIG.VERSION);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(DB_CONFIG.STORE)) db.createObjectStore(DB_CONFIG.STORE);
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async function storeBlob(blob) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(DB_CONFIG.STORE, 'readwrite');
            const req = tx.objectStore(DB_CONFIG.STORE).put(blob, DB_CONFIG.KEY);
            req.onsuccess = () => resolve();
            req.onerror = (e) => reject(e.target.error);
        });
    }

    async function getBlob() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(DB_CONFIG.STORE, 'readonly');
            const req = tx.objectStore(DB_CONFIG.STORE).get(DB_CONFIG.KEY);
            req.onsuccess = () => resolve(req.result);
            req.onerror = (e) => reject(e.target.error);
        });
    }

    async function clearBlob() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(DB_CONFIG.STORE, 'readwrite');
            const req = tx.objectStore(DB_CONFIG.STORE).delete(DB_CONFIG.KEY);
            req.onsuccess = () => resolve();
            req.onerror = (e) => reject(e.target.error);
        });
    }

    function updateSliderVisuals(slider) {
        if (!slider) return;
        const min = parseFloat(slider.min) || 0;
        const max = parseFloat(slider.max) || 100;
        const val = parseFloat(slider.value);
        const percent = ((val - min) / (max - min)) * 100;
        slider.style.setProperty('--slider-fill-percent', `${percent}%`);
    }

    async function preloadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = url;
        });
    }

    async function applyVisualState(blobUrl, blur, animate = false) {
        if (blobUrl) {
            
            if (animate) {
                UI.layer.classList.remove('active');
                
                void UI.layer.offsetWidth; 

                UI.layer.style.backgroundImage = `url(${blobUrl})`;
                
                UI.layer.style.filter = `blur(60px) saturate(150%)`;
                UI.layer.style.transform = `scale(1.1)`;

                requestAnimationFrame(() => {
                    document.body.classList.add('wallpaper-active');
                    UI.layer.classList.add('active');
                    
                    setTimeout(() => {
                         UI.layer.style.filter = ''; 
                         UI.layer.style.transform = '';
                         if(blur > 0) {
                             UI.layer.style.filter = `blur(${blur}px)`;
                             UI.layer.style.webkitFilter = `blur(${blur}px)`;
                         }
                    }, 50);
                });

            } else {
                UI.layer.style.backgroundImage = `url(${blobUrl})`;
                document.body.classList.add('wallpaper-active');
                UI.layer.classList.add('active');
                if(blur > 0) {
                    UI.layer.style.filter = `blur(${blur}px)`;
                    UI.layer.style.webkitFilter = `blur(${blur}px)`;
                }
            }

            if (UI.previewImg) {
                UI.previewImg.style.opacity = '0';
                setTimeout(() => {
                    UI.previewImg.src = blobUrl;
                    UI.previewImg.style.display = 'block';
                    requestAnimationFrame(() => UI.previewImg.style.opacity = '1');
                }, 200);
            }
            if (UI.statusText) UI.statusText.style.display = 'none';
            if (UI.removeBtn) UI.removeBtn.style.display = 'inline-block';
            if (UI.uploadBtn) UI.uploadBtn.textContent = 'Change';
            if (UI.blurSection) {
                UI.blurSection.style.opacity = '1';
                UI.blurSection.style.pointerEvents = 'auto';
            }
            if (UI.blurSlider) {
                UI.blurSlider.value = blur;
                updateSliderVisuals(UI.blurSlider);
            }
            if (UI.blurVal) UI.blurVal.textContent = `${blur}%`;

        } else {
            
            document.body.classList.remove('wallpaper-active');
            
            UI.layer.style.zIndex = '0'; 
            
            UI.layer.classList.remove('active');
            
            setTimeout(() => {
                if(!UI.layer.classList.contains('active')) {
                    UI.layer.style.backgroundImage = '';
                    UI.layer.style.filter = '';
                    UI.layer.style.webkitFilter = '';
                    UI.layer.style.zIndex = ''; 
                }
            }, 1200);

            if (UI.previewImg) {
                UI.previewImg.src = '';
                UI.previewImg.style.display = 'none';
            }
            if (UI.statusText) UI.statusText.style.display = 'block';
            if (UI.removeBtn) UI.removeBtn.style.display = 'none';
            if (UI.uploadBtn) UI.uploadBtn.textContent = 'Select';
            if (UI.blurSection) {
                UI.blurSection.style.opacity = '0.5';
                UI.blurSection.style.pointerEvents = 'none';
            }
            if (UI.blurSlider) {
                UI.blurSlider.value = 0;
                updateSliderVisuals(UI.blurSlider);
            }
            if (UI.blurVal) UI.blurVal.textContent = '0%';
        }
    }

    function revokeCurrentUrl() {
        if (activeObjectUrl) {
            URL.revokeObjectURL(activeObjectUrl);
            activeObjectUrl = null;
        }
    }

    async function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        try {
            if (UI.input) UI.input.disabled = true;
            setLoaderState(true, 'Analyzing...', 15);
            await new Promise(r => setTimeout(r, 400));
            setLoaderState(true, 'Saving...', 45);
            await storeBlob(file);
            setLoaderState(true, 'Rendering...', 75);
            revokeCurrentUrl();
            activeObjectUrl = URL.createObjectURL(file);
            await preloadImage(activeObjectUrl);
            setLoaderState(true, 'Applying...', 100);
            const currentBlur = UI.blurSlider ? UI.blurSlider.value : 0;
            localStorage.setItem(KEYS.BLUR, currentBlur);
            await applyVisualState(activeObjectUrl, currentBlur, true);
            await new Promise(r => setTimeout(r, 600));
            setLoaderState(false);
        } catch (err) {
            console.error("Wallpaper Error:", err);
            setLoaderState(false);
            alert("Unable to process image.");
        } finally {
            if (UI.input) {
                UI.input.disabled = false;
                UI.input.value = ''; 
            }
        }
    }

    async function init() {
        initLoader();
        try {
            const blob = await getBlob();
            const savedBlur = localStorage.getItem(KEYS.BLUR) || 0;
            if (blob) {
                revokeCurrentUrl();
                activeObjectUrl = URL.createObjectURL(blob);
                applyVisualState(activeObjectUrl, savedBlur, false);
            } else {
                applyVisualState(null, 0, false);
            }
        } catch (e) {
            applyVisualState(null, 0, false);
        }

        if (UI.trigger) UI.trigger.onclick = () => UI.input && UI.input.click();
        if (UI.uploadBtn) UI.uploadBtn.onclick = (e) => { e.stopPropagation(); UI.input && UI.input.click(); };
        if (UI.input) {
            UI.input.removeEventListener('change', handleFileSelect);
            UI.input.addEventListener('change', handleFileSelect);
        }
        if (UI.removeBtn) {
            UI.removeBtn.onclick = async (e) => {
                e.stopPropagation();
                await clearBlob();
                localStorage.removeItem(KEYS.BLUR);
                revokeCurrentUrl();
                applyVisualState(null, 0, false); 
            };
        }
        if (UI.blurSlider) {
            UI.blurSlider.oninput = (e) => {
                const val = e.target.value;
                if (UI.layer) {
                    UI.layer.style.filter = `blur(${val}px)`;
                    UI.layer.style.webkitFilter = `blur(${val}px)`;
                }
                if (UI.blurVal) UI.blurVal.textContent = `${val}%`;
                updateSliderVisuals(e.target);
                localStorage.setItem(KEYS.BLUR, val);
            };
        }
    }

    init();
})();
class FxFilter {
    static elements = new WeakMap(); 
    static filters = new Map(); 
    static filterOptions = new Map(); 
    static running = false;

    static add(options) {
        if (typeof options === 'string') {
            const name = arguments[0];
            const callback = arguments[1];
            this.filters.set(name, callback);
            this.filterOptions.set(name, { name, callback, updatesOn: [] });
            console.log(` Registered filter: "${name}"`);
        } else {
            const { name, callback, updatesOn = [] } = options;
            this.filters.set(name, callback);
            this.filterOptions.set(name, { name, callback, updatesOn });
            console.log(` Registered filter: "${name}" with updatesOn: [${updatesOn.join(', ')}]`);
        }
    }

    static init() {
        console.log(' FxFilter.init() called');

        if ('CSS' in window && 'registerProperty' in CSS) {
            try {
                CSS.registerProperty({
                    name: '--fx-filter',
                    syntax: '*',
                    inherits: false,
                    initialValue: ''
                });
                console.log(' --fx-filter property registered');
            } catch (e) {
                console.log(' CSS registerProperty not supported or already registered');
            }
        }

        if (!this.running) {
            console.log(' Starting FxFilter animation loop');
            this.running = true;
            this.tick();
        } else {
            console.log(' FxFilter already running - skipping duplicate initialization');
        }
    }

    static tick() {
        this.scanElements();
        requestAnimationFrame(() => this.tick());
    }

    static scanElements() {
        document.querySelectorAll('*:not(.fx-container):not(svg)').forEach(element => {
            const fxFilter = this.getFxFilterValue(element);
            const storedState = this.elements.get(element);

            if (fxFilter) {
                let parsedFilter;
                if (storedState && storedState.filter === fxFilter && storedState.parsedFilter) {
                    parsedFilter = storedState.parsedFilter;
                } else {
                    parsedFilter = this.parseFilterValue(fxFilter);
                }

                const currentStyles = this.getTrackedStyles(element, fxFilter, parsedFilter);

                if (!storedState) {
                    this.addFxContainer(element, fxFilter, parsedFilter);
                    this.elements.set(element, {
                        filter: fxFilter,
                        hasContainer: true,
                        trackedStyles: currentStyles,
                        parsedFilter: parsedFilter
                    });
                } else if (storedState.filter !== fxFilter || this.stylesChanged(storedState.trackedStyles, currentStyles)) {
                    this.removeFxContainer(element);
                    this.addFxContainer(element, fxFilter, parsedFilter);
                    this.elements.set(element, {
                        filter: fxFilter,
                        hasContainer: true,
                        trackedStyles: currentStyles,
                        parsedFilter: parsedFilter
                    });
                }
            } else {
                if (storedState && storedState.hasContainer) {
                    this.removeFxContainer(element);
                    this.elements.delete(element);
                }
            }
        });
    }

    static getFxFilterValue(element) {
        const computed = getComputedStyle(element);
        return computed.getPropertyValue('--fx-filter').trim() || null;
    }
static addFxContainer(element, filterValue, parsedFilter) {
    if (element.querySelector('.fx-container')) {
        return;
    }

    const computedStyle = getComputedStyle(element);
    if (computedStyle.position === 'static') {
        element.style.position = 'relative';
    }
    if (computedStyle.isolation === 'auto') {
        element.style.isolation = 'isolate';
    }

    const { orderedFilters, customFilters } = parsedFilter || this.parseFilterValue(filterValue);
    console.log('Parsed filters:', { orderedFilters, customFilters });

    const filterParts = [];
    let svgContent = '';

    orderedFilters.forEach(item => {
        if (item.type === 'custom') {
            const filter = item.filter;
            const callback = this.filters.get(filter.name);

            if (callback) {
                const filterId = `fx-${filter.name}-${Math.random().toString(36).substr(2, 6)}`;
                const filterContent = callback(element, ...filter.params);

                svgContent += `<filter id="${filterId}"
                 x="0" y="0" width="100%" height="100%" color-interpolation-filters="sRGB"
                 >${filterContent}</filter>`;

                filterParts.push(`url(#${filterId})`);
            }
        } else if (item.type === 'css') {
            filterParts.push(item.filter);
        }
    });

    const backdropFilter = filterParts.join(' ');

    if (backdropFilter.trim()) {
        const htmlToInject = `
            <svg class="fx-svg-definitions" style="position: absolute; width: 0; height: 0; pointer-events: none;">
                ${svgContent}
            </svg>
            <div class="fx-container" style="
                position: absolute; 
                inset: 0; 
                backdrop-filter: ${backdropFilter}; 
                -webkit-backdrop-filter: ${backdropFilter}; 
                background: transparent; 
                pointer-events: none; 
                z-index: -1; 
                overflow: hidden; 
                border-radius: inherit;
            "></div>
        `;

        element.insertAdjacentHTML('beforeend', htmlToInject);

        console.log('Applied combined filter:', backdropFilter);
        this.elements.set(element, { filter: filterValue, hasContainer: true });
    } else {
        console.log('No valid filters found');
    }
}

static removeFxContainer(element) {
    const container = element.querySelector('.fx-container');
    const svg = element.querySelector('.fx-svg-definitions');
    
    if (container) container.remove();
    if (svg) svg.remove();
}
    static createUnifiedSVG(customFilters) {
        console.log('createUnifiedSVG called with:', customFilters);

        const svg = document.createElement('svg');
        svg.style.cssText = 'position: absolute; width: 0; height: 0; pointer-events: none;';

        const filterIds = [];
        let svgContent = '';

        customFilters.forEach((filter, index) => {
            console.log('Processing filter:', filter.name, 'with params:', filter.params);
            const callback = this.filters.get(filter.name);
            console.log('Callback found:', !!callback);

            if (callback) {
                const filterId = `fx-${filter.name}-${Math.random().toString(36).substr(2, 6)}`;
                filterIds.push(filterId);

                const filterContent = callback(...filter.params);
                console.log('Filter content generated:', filterContent);
                svgContent += `<filter id="${filterId}" x="-20%" y="-20%" width="140%" height="140%">${filterContent}</filter>`;
            }
        });

        console.log('Final SVG content:', svgContent);
        svg.innerHTML = svgContent;
        console.log('SVG element created:', svg);
        return { svg, filterIds };
    }


    static removeFxContainer(element) {
        element.querySelectorAll('.fx-container, svg').forEach(el => el.remove());
    }

    static parseFilterValue(filterValue) {

        console.log(' Parsing filter value:', filterValue);

        const orderedFilters = []; 
        const customFilters = [];

        const filterRegex = /(\w+(?:-\w+)*)\s*\(([^)]*)\)/g;

        let match;
        while ((match = filterRegex.exec(filterValue)) !== null) {
            const filterName = match[1];
            const params = match[2];

            console.log(` Found filter: ${filterName} with params: "${params}"`);

            if (this.filters.has(filterName)) {
                console.log(` Custom filter "${filterName}" found in registry`);
                let paramArray = [];
                if (params.trim() !== '') {
                    paramArray = params.split(',').map(p => {
                        const trimmed = p.trim();
                        if (trimmed === '') return undefined;
                        const number = parseFloat(trimmed);
                        return !isNaN(number) ? number : trimmed;
                    }).filter(p => p !== undefined);
                }
                console.log(` Parsed params for "${filterName}":`, paramArray);
                const customFilter = { name: filterName, params: paramArray };
                customFilters.push(customFilter);
                orderedFilters.push({ type: 'custom', filter: customFilter });
            } else {
                console.log(` CSS filter: ${filterName}(${params})`);
                orderedFilters.push({ type: 'css', filter: `${filterName}(${params})` });
            }
        }

        console.log(' Parse results:', { orderedFilters, customFilters });
        return {
            orderedFilters: orderedFilters,
            customFilters: customFilters
        };
    }

    static getTrackedStyles(element, filterValue, parsedFilter) {
        const { customFilters } = parsedFilter || this.parseFilterValue(filterValue);
        const trackedStyles = new Map();

        customFilters.forEach(filter => {
            const filterOptions = this.filterOptions.get(filter.name);
            if (filterOptions && filterOptions.updatesOn) {
                const computed = getComputedStyle(element);
                filterOptions.updatesOn.forEach(styleProp => {
                    const value = computed.getPropertyValue(styleProp);
                    trackedStyles.set(styleProp, value);
                });
            }
        });

        return trackedStyles;
    }

    static stylesChanged(oldStyles, newStyles) {
        if (!oldStyles || !newStyles) return true;
        if (oldStyles.size !== newStyles.size) return true;

        for (const [prop, value] of newStyles) {
            if (oldStyles.get(prop) !== value) {
                console.log(` Style change detected: ${prop} changed from "${oldStyles.get(prop)}" to "${value}"`);
                return true;
            }
        }

        return false;
    }
}
FxFilter.add({
    name: "noise",
    callback: (element, saturation = 0, intensity = 1, opacity = .25) => {
        const canvas = document.createElement('canvas');
        canvas.width = element.clientWidth;
        canvas.height = element.clientHeight;
        const ctx = canvas.getContext('2d');

        ctx.imageSmoothingEnabled = false;

        const imageDataAdd = ctx.createImageData(canvas.width, canvas.height);
        const dataAdd = imageDataAdd.data;
        const additiveIntensity = intensity;

        for (let i = 0; i < dataAdd.length; i += 4) {
            const noiseValue1 = Math.random() * additiveIntensity * 255;
            const noiseValue2 = Math.random() * additiveIntensity * 255;
            const noiseValue3 = Math.random() * additiveIntensity * 255;

            const baseNoise = noiseValue1; 
            dataAdd[i] = baseNoise * (1 - saturation) + noiseValue1 * saturation;     
            dataAdd[i + 1] = baseNoise * (1 - saturation) + noiseValue2 * saturation;   
            dataAdd[i + 2] = baseNoise * (1 - saturation) + noiseValue3 * saturation; 
            dataAdd[i + 3] = 255 * opacity; 
        }

        ctx.putImageData(imageDataAdd, 0, 0);
        const noiseAdditiveURL = canvas.toDataURL();

        return `
                <feImage href="${noiseAdditiveURL}" result="noiseAdd" image-rendering="pixelated"/>
                <feBlend in="SourceGraphic" in2="noiseAdd" mode="overlay" image-rendering="pixelated" result="brightened"/>
                `;
    },
    updatesOn: ['width', 'height']  
});
FxFilter.add({
    name: "liquid-glass",
    callback: (element, refraction = 1, offset = 10, chromatic = 0) => {
        const width = Math.round(element.offsetWidth);
        const height = Math.round(element.offsetHeight);
        const refractionValue = parseFloat(refraction) / 2 || 0;
        const offsetValue = (parseFloat(offset) || 0) / 2;
        const chromaticValue = parseFloat(chromatic) || 0;
        const borderRadiusStr = window.getComputedStyle(element).borderRadius || '0';
        let borderRadius = 0;

        if (borderRadiusStr.includes('%')) {
            const percentage = parseFloat(borderRadiusStr);
            const elementSize = Math.min(element.offsetWidth, element.offsetHeight);
            borderRadius = (percentage / 100) * elementSize;
        } else {
            borderRadius = parseFloat(borderRadiusStr);
        }

        function createDisplacementMap(refractionMod) {
            const adjustedRefraction = refractionValue + refractionMod;
            const imageData = new ImageData(maxDimension, maxDimension);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                data[i] = 127;     
                data[i + 1] = 127; 
                data[i + 2] = 127; 
                data[i + 3] = 255; 
            }

            const topOffset = Math.floor(maxDimension / 2);
            for (let y = 0; y < topOffset; y++) {
                for (let x = 0; x < maxDimension; x++) {
                    const gradientSegment = (topOffset - y) / topOffset; 
                    const pixelIndex = (y * maxDimension + x) * 4;
                    const vyValue = 1 * adjustedRefraction;
                    data[pixelIndex + 2] = Math.max(0, Math.min(255, Math.round(127 + 127 * vyValue * Math.pow(gradientSegment, 1))));
                }
            }

            for (let y = maxDimension - topOffset; y < maxDimension; y++) {
                for (let x = 0; x < maxDimension; x++) {
                    const gradientSegment = (y - (maxDimension - topOffset)) / topOffset; 
                    const pixelIndex = (y * maxDimension + x) * 4;
                    const vyValue = -1 * adjustedRefraction;
                    data[pixelIndex + 2] = Math.max(0, Math.min(255, Math.round(127 + 127 * vyValue * Math.pow(gradientSegment, 1))));
                }
            }

            const leftOffset = Math.floor(maxDimension / 2);
            for (let y = 0; y < maxDimension; y++) {
                for (let x = 0; x < leftOffset; x++) {
                    const gradientSegment = (leftOffset - x) / leftOffset; 
                    const pixelIndex = (y * maxDimension + x) * 4;
                    const vxValue = 1 * adjustedRefraction;
                    data[pixelIndex] = Math.max(0, Math.min(255, Math.round(127 + 127 * vxValue * Math.pow(gradientSegment, 1))));
                }
            }

            for (let y = 0; y < maxDimension; y++) {
                for (let x = maxDimension - leftOffset; x < maxDimension; x++) {
                    const gradientSegment = (x - (maxDimension - leftOffset)) / leftOffset; 
                    const pixelIndex = (y * maxDimension + x) * 4;
                    const vxValue = -1 * adjustedRefraction;
                    data[pixelIndex] = Math.max(0, Math.min(255, Math.round(127 + 127 * vxValue * Math.pow(gradientSegment, 1))));
                }
            }

            return imageData;
        }

        function createCanvasFromImageData(imageData) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            const offsetX = (maxDimension - width) / 2;
            const offsetY = (maxDimension - height) / 2;
            ctx.putImageData(imageData, -Math.round(offsetX), -Math.round(offsetY)); console.log('Displacement map applied to canvas', width, height, canvas.toDataURL());
            if (borderRadius > 0) {
                const maskCanvas = new OffscreenCanvas(width, height);
                const maskCtx = maskCanvas.getContext('2d');
                maskCtx.fillStyle = "rgb(127, 127, 127)";
                maskCtx.beginPath();
                const inset = offsetValue * 1; 
                maskCtx.roundRect(inset, inset, width - (inset * 2), height - (inset * 2), Math.max(0, borderRadius - inset));
                maskCtx.clip();
                maskCtx.fillRect(0, 0, width, height);

                ctx.filter = `blur(${offsetValue}px)`;
                ctx.drawImage(maskCanvas, 0, 0, width, height);
            } else if (offsetValue > 0) {
                ctx.filter = `blur(${offsetValue}px)`;
                ctx.drawImage(canvas, 0, 0);
            }

            const dataURL = canvas.toDataURL();
            canvas.remove();
            return dataURL;
        }

        const maxDimension = Math.ceil(Math.max(width, height));

        if (chromaticValue === 0) {
            const imageData = createDisplacementMap(0);
            const dataURL = createCanvasFromImageData(imageData);

            return `
                <feImage result="FEIMG" href="${dataURL}" color-interpolation-filters="sRGB"/>
                <feDisplacementMap in="SourceGraphic" in2="FEIMG" scale="127" yChannelSelector="B" xChannelSelector="R" color-interpolation-filters="sRGB"/>
            `;
        } else {
            const chromaticOffset = chromaticValue * 0.25; 

            const redImageData = createDisplacementMap(chromaticOffset);  
            const greenImageData = createDisplacementMap(0);             
            const blueImageData = createDisplacementMap(-chromaticOffset); 

            const redDataURL = createCanvasFromImageData(redImageData);
            const greenDataURL = createCanvasFromImageData(greenImageData);
            const blueDataURL = createCanvasFromImageData(blueImageData);

            return `
                <!-- Red channel displacement -->
                <feImage result="redImg" href="${redDataURL}" color-interpolation-filters="sRGB"/>
                <feDisplacementMap in="SourceGraphic" in2="redImg" scale="127" yChannelSelector="B" xChannelSelector="R" color-interpolation-filters="sRGB" result="redDisplaced"/>
                <feComponentTransfer in="redDisplaced" result="redChannel">
                    <feFuncR type="identity"/>
                    <feFuncG type="discrete" tableValues="0"/>
                    <feFuncB type="discrete" tableValues="0"/>
                    <feFuncA type="identity"/>
                </feComponentTransfer>

                <!-- Green channel displacement -->
                <feImage result="greenImg" href="${greenDataURL}" color-interpolation-filters="sRGB"/>
                <feDisplacementMap in="SourceGraphic" in2="greenImg" scale="127" yChannelSelector="B" xChannelSelector="R" color-interpolation-filters="sRGB" result="greenDisplaced"/>
                <feComponentTransfer in="greenDisplaced" result="greenChannel">
                    <feFuncR type="discrete" tableValues="0"/>
                    <feFuncG type="identity"/>
                    <feFuncB type="discrete" tableValues="0"/>
                    <feFuncA type="identity"/>
                </feComponentTransfer>

                <!-- Blue channel displacement -->
                <feImage result="blueImg" href="${blueDataURL}" color-interpolation-filters="sRGB"/>
                <feDisplacementMap in="SourceGraphic" in2="blueImg" scale="127" yChannelSelector="B" xChannelSelector="R" color-interpolation-filters="sRGB" result="blueDisplaced"/>
                <feComponentTransfer in="blueDisplaced" result="blueChannel">
                    <feFuncR type="discrete" tableValues="0"/>
                    <feFuncG type="discrete" tableValues="0"/>
                    <feFuncB type="identity"/>
                    <feFuncA type="identity"/>
                </feComponentTransfer>

                <!-- Combine all channels -->
                <feComposite in="redChannel" in2="greenChannel" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="redGreen"/>
                <feComposite in="redGreen" in2="blueChannel" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="final"/>
            `;
        }
    },
    updatesOn: ['border-radius', 'width', 'height']
});

FxFilter.add({
    name: 'color-overlay',
    callback: (element, color = 'black', opacity = 0.5) => {
        const alpha = typeof opacity === 'string' ? parseFloat(opacity) : opacity;
        return `
            <feFlood flood-color="${color}" flood-opacity="${alpha}" result="flood"/>
            <feComposite in="flood" in2="SourceGraphic" operator="atop"/>
        `;
    },
    updatesOn: [] 
});

FxFilter.init()

;
(function() {
    class GalvanSpeechEngine {
        constructor() {
            this.SILENCE_DELAY_MS = 3000;
            this.COUNTDOWN_DURATION = 5;
            this.LANG = 'en-US';
            this.isActiveUserIntent = false;
            this.isActuallyListening = false;
            this.silenceTimer = null;
            this.countdownInterval = null;
            this.baseInputValue = '';
            this.controlsLeft = document.querySelector('.controls-left');
            this.input = document.querySelector('.prompt-input');
            this.form = document.querySelector('.galvan-prompt-form');
            this.btn = null;
            this.statusEl = null;
            this.recognition = null;
            this.init();
        }

        init() {
            this.injectButton();
            this.injectStatusElement();
            this.setupRecognition();
            this.form.addEventListener('submit', () => {
                this.stop(true);
            });
        }

        injectButton() {
            if (document.getElementById('mic-btn')) {
                this.btn = document.getElementById('mic-btn');
            } else if (this.controlsLeft) {
                const btn = document.createElement('button');
                btn.id = 'mic-btn';
                btn.className = 'prompt-btn';
                btn.type = 'button';
                btn.setAttribute('aria-label', 'Voice Input');
                btn.innerHTML = '<ion-icon name="mic-outline"></ion-icon>';
                this.controlsLeft.appendChild(btn);
                this.btn = btn;
            }

            if (this.btn) {
                const newBtn = this.btn.cloneNode(true);
                this.btn.parentNode.replaceChild(newBtn, this.btn);
                this.btn = newBtn;
                this.btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.toggle();
                });
            }
        }

        injectStatusElement() {
            const existing = document.querySelector('.voice-status-overlay');
            if (existing) existing.remove();
            this.statusEl = document.createElement('div');
            this.statusEl.className = 'voice-status-overlay';
            this.statusEl.innerHTML = `
                <div class="voice-wave-bar"></div>
                <div class="voice-wave-bar"></div>
                <div class="voice-wave-bar"></div>
                <span id="voice-status-text">Start Speaking</span>
            `;
            document.body.appendChild(this.statusEl);
        }

        setupRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                if (this.btn) this.btn.style.display = 'none';
                return;
            }

            this.recognition = new SpeechRecognition();
            this.recognition.continuous = true;
            this.recognition.interimResults = true;
            this.recognition.lang = this.LANG;

            this.recognition.onstart = () => {
                this.isActuallyListening = true;
                this.updateUI(true);
                this.resetSilenceWatchdog();
            };

            this.recognition.onend = () => {
                this.isActuallyListening = false;
                if (this.isActiveUserIntent) {
                    try {
                        this.recognition.start();
                    } catch (e) {
                        this.stop(true);
                    }
                } else {
                    this.updateUI(false);
                }
            };

            this.recognition.onresult = (e) => this.handleResult(e);

            this.recognition.onerror = (e) => {
                if (e.error === 'no-speech') return;
                if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
                    alert("Microphone access denied.");
                    this.stop(true);
                }
            };
        }

        toggle() {
            if (this.isActiveUserIntent) {
                this.stop(true);
            } else {
                this.start();
            }
        }

        start() {
            if (this.isActiveUserIntent) return;
            this.isActiveUserIntent = true;
            this.baseInputValue = this.input.value;
            if (this.baseInputValue.length > 0 && !/\s$/.test(this.baseInputValue)) {
                this.baseInputValue += ' ';
            }
            try {
                this.recognition.start();
            } catch (e) {
                this.isActiveUserIntent = false;
            }
        }

        stop(forceFullStop = false) {
            if (forceFullStop) {
                this.isActiveUserIntent = false;
            }
            this.recognition.stop();
            clearTimeout(this.silenceTimer);
            clearInterval(this.countdownInterval);
        }

        handleResult(event) {
            this.resetSilenceWatchdog();
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            const totalText = this.smartCapitalize(finalTranscript || interimTranscript);
            
            requestAnimationFrame(() => {
                this.input.value = this.baseInputValue + totalText;
                this.adjustInputHeight();
                this.input.scrollTop = this.input.scrollHeight;
                this.input.dispatchEvent(new Event('input', { bubbles: true }));
                this.updateStatus(true, "Listening...", false);
            });

            if (finalTranscript) {
                this.baseInputValue += finalTranscript + ' ';
                this.input.value = this.baseInputValue;
            }
        }

        smartCapitalize(str) {
            if (!str) return '';
            if (this.baseInputValue.trim().length === 0) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }
            return str;
        }

        adjustInputHeight() {
            this.input.style.height = 'auto';
            this.input.style.height = Math.min(this.input.scrollHeight, 150) + 'px';
        }

        updateUI(isListening) {
            if (isListening) {
                this.btn.classList.add('listening');
                this.btn.innerHTML = '<ion-icon name="mic"></ion-icon>';
                this.updateStatus(true, "Start Speaking", false);
                if (navigator.vibrate) navigator.vibrate(50);
            } else {
                this.btn.classList.remove('listening');
                this.btn.innerHTML = '<ion-icon name="mic-outline"></ion-icon>';
                this.updateStatus(false);
                this.adjustInputHeight();
            }
        }

        updateStatus(visible, text, isCountdown) {
            if (visible) {
                this.statusEl.classList.add('visible');
                const textSpan = this.statusEl.querySelector('#voice-status-text');
                const bars = this.statusEl.querySelectorAll('.voice-wave-bar');
                if (textSpan) textSpan.textContent = text;
                
                if (isCountdown) {
                    this.statusEl.classList.add('countdown-mode');
                    bars.forEach(b => b.style.display = 'none');
                } else {
                    this.statusEl.classList.remove('countdown-mode');
                    bars.forEach(b => b.style.display = 'block');
                }
            } else {
                this.statusEl.classList.remove('visible');
                this.statusEl.classList.remove('countdown-mode');
            }
        }

        resetSilenceWatchdog() {
            clearTimeout(this.silenceTimer);
            clearInterval(this.countdownInterval);
            this.silenceTimer = setTimeout(() => {
                this.startCountdown();
            }, this.SILENCE_DELAY_MS);
        }

        startCountdown() {
            let timeLeft = this.COUNTDOWN_DURATION;
            this.updateStatus(true, `Pausing in ${timeLeft}...`, true);
            this.countdownInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(this.countdownInterval);
                    this.stop(true);
                    if (navigator.vibrate) navigator.vibrate([50, 50]);
                } else {
                    this.updateStatus(true, `Pausing in ${timeLeft}...`, true);
                }
            }, 1000);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => window.GalvanSpeech = new GalvanSpeechEngine());
    } else {
        setTimeout(() => {
            window.GalvanSpeech = new GalvanSpeechEngine();
        }, 100);
    }
})();
(function() {
    const container = document.getElementById('galvan-top-nav-island');
    const backdrop = container.querySelector('.nav-island-backdrop');
    const homeBtn = document.getElementById('nav-island-home');
    const chatsBtn = document.getElementById('nav-island-chats');
    
    const STATE = {
        isDragging: false,
        isPressing: false,
        startX: 0,
        startY: 0,
        containerWidth: 0,
        backdropWidth: 0,
        maxTranslate: 0,
        activeTab: 'home',
        hasMoved: false
    };

    container.addEventListener('pointerdown', startPress);
    window.addEventListener('pointermove', onDrag);
    window.addEventListener('pointerup', endPress);
    window.addEventListener('pointercancel', endPress);
    
    requestAnimationFrame(measureDimensions);
    window.addEventListener('resize', measureDimensions);

    function measureDimensions() {
        const rect = container.getBoundingClientRect();
        STATE.containerWidth = rect.width;
        STATE.backdropWidth = (rect.width / 2) - 4; 
        STATE.maxTranslate = STATE.containerWidth - STATE.backdropWidth - 8;
        
        const currentAttr = container.getAttribute('data-active') || 'home';
        const startX = (currentAttr === 'chats') ? STATE.maxTranslate : 0;
        
        backdrop.style.width = `${STATE.backdropWidth}px`;
        updateBackdropTransform(startX, 1);
    }

    function updateBackdropTransform(x, scale) {
        backdrop.style.transform = `translate3d(${x}px, 0, 0) scale(${scale})`;
    }

    function startPress(e) {
        if (e.button !== 0) return;
        
        measureDimensions();

        STATE.isPressing = true;
        STATE.isDragging = true;
        STATE.hasMoved = false;
        STATE.startX = e.clientX;
        STATE.startY = e.clientY;
        STATE.activeTab = container.getAttribute('data-active') || 'home';
        
        container.classList.add('is-dragging', 'is-pressing');
        container.classList.remove('is-snapping');
        
        const currentPos = (STATE.activeTab === 'chats') ? STATE.maxTranslate : 0;
        
        updateBackdropTransform(currentPos, 1.15);
        
        container.setPointerCapture(e.pointerId);
        
        if (navigator.vibrate) navigator.vibrate(10);
    }

    function onDrag(e) {
        if (!STATE.isDragging) return;

        const deltaX = e.clientX - STATE.startX;
        const deltaY = Math.abs(e.clientY - STATE.startY);

        if (!STATE.hasMoved && deltaY > Math.abs(deltaX) && deltaY > 5) {
            STATE.isDragging = false;
            STATE.isPressing = false;
            container.classList.remove('is-dragging', 'is-pressing');
            const currentPos = (STATE.activeTab === 'chats') ? STATE.maxTranslate : 0;
            updateBackdropTransform(currentPos, 1);
            return;
        }

        if (Math.abs(deltaX) > 4) STATE.hasMoved = true;

        const startPos = (STATE.activeTab === 'chats') ? STATE.maxTranslate : 0;
        let rawPos = startPos + deltaX;
        
        let pillX = rawPos;
        let containerShiftX = 0;
        let containerStretchX = 1;

        if (rawPos < 0) {
            pillX = 0;
            const overflow = Math.abs(rawPos);
            containerStretchX = 1 + (overflow * 0.001); 
            containerShiftX = -((STATE.containerWidth * (containerStretchX - 1)) / 2);
        } 
        else if (rawPos > STATE.maxTranslate) {
            pillX = STATE.maxTranslate;
            const overflow = rawPos - STATE.maxTranslate;
            containerStretchX = 1 + (overflow * 0.001);
            containerShiftX = ((STATE.containerWidth * (containerStretchX - 1)) / 2);
        }

        updateBackdropTransform(pillX, 1.15);
        
        container.style.transformOrigin = (rawPos < 0) ? 'right center' : 'left center';
        if (rawPos >= 0 && rawPos <= STATE.maxTranslate) container.style.transformOrigin = 'center center';
        
        container.style.transform = `translateX(calc(-50% + ${containerShiftX}px)) scaleX(${containerStretchX})`;
    }

    function endPress(e) {
        if (!STATE.isDragging) return;
        STATE.isDragging = false;
        STATE.isPressing = false;

        container.classList.remove('is-dragging', 'is-pressing');
        container.classList.add('is-snapping');

        container.style.transform = '';

        if (!STATE.hasMoved) {
            const target = (STATE.activeTab === 'home') ? 'chats' : 'home';
            triggerSwitch(target);
            return;
        }

        const deltaX = e.clientX - STATE.startX;
        const startPos = (STATE.activeTab === 'chats') ? STATE.maxTranslate : 0;
        const finalPos = startPos + deltaX;
        const midpoint = STATE.maxTranslate / 2;

        if (finalPos > midpoint) {
            if (STATE.activeTab !== 'chats') triggerSwitch('chats');
            else snapToPosition('chats');
        } else {
            if (STATE.activeTab !== 'home') triggerSwitch('home');
            else snapToPosition('home');
        }
    }

    function snapToPosition(target) {
        const destX = (target === 'chats') ? STATE.maxTranslate : 0;
        updateBackdropTransform(destX, 1);
    }

    function triggerSwitch(target) {
        STATE.activeTab = target;
        container.setAttribute('data-active', target);
        
        if (target === 'home' && homeBtn) homeBtn.click();
        if (target === 'chats' && chatsBtn) chatsBtn.click();
        
        const destX = (target === 'chats') ? STATE.maxTranslate : 0;
        
        updateBackdropTransform(destX, 1.05);
        
        setTimeout(() => {
            updateBackdropTransform(destX, 1);
        }, 150);

        if (navigator.vibrate) navigator.vibrate(15);
    }
})();

;(function() {
    try {
        const storedSettings = JSON.parse(localStorage.getItem('galvanAi_v30_settings'));
        if (storedSettings && storedSettings.themeMode === 'light') {
            document.body.classList.add('light-mode');
        } else {
            document.body.classList.remove('light-mode');
        }
    } catch (e) {}

    const bootScreen = document.getElementById('galvan-boot-screen');
    
    if (bootScreen) {
        const blades = Array.from({length: 12}).map(() => `<div class="as-blade"></div>`).join('');
        
        bootScreen.innerHTML = `
            <div class="hello-container">
                <svg class="hello-svg" viewBox="0 0 1230.94 414.57">
                    <defs>
                        <!-- Dark Mode Gradient: Pastel Purple to Teal -->
                        <linearGradient id="gradDark" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#c4b5fd;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#a78bfa;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2dd4bf;stop-opacity:1" />
                        </linearGradient>
                        
                        <!-- Light Mode Gradient: Vibrant Blue to Sky -->
                        <linearGradient id="gradLight" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#3b82f6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#0ea5e9;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path class="hello-path" d="M-293.58-104.62S-103.61-205.49-60-366.25c9.13-32.45,9-58.31,0-74-10.72-18.82-49.69-33.21-75.55,31.94-27.82,70.11-52.22,377.24-44.11,322.48s34-176.24,99.89-183.19c37.66-4,49.55,23.58,52.83,47.92a117.06,117.06,0,0,1-3,45.32c-7.17,27.28-20.47,97.67,33.51,96.86,66.93-1,131.91-53.89,159.55-84.49,31.1-36.17,31.1-70.64,19.27-90.25-16.74-29.92-69.47-33-92.79,16.73C62.78-179.86,98.7-93.8,159-81.63S302.7-99.55,393.3-269.92c29.86-58.16,52.85-114.71,46.14-150.08-7.44-39.21-59.74-54.5-92.87-8.7-47,65-61.78,266.62-34.74,308.53S416.62-58,481.52-130.31s133.2-188.56,146.54-256.23c14-71.15-56.94-94.64-88.4-47.32C500.53-375,467.58-229.49,503.3-127a73.73,73.73,0,0,0,23.43,33.67c25.49,20.23,55.1,16,77.46,6.32a111.25,111.25,0,0,0,30.44-19.87c37.73-34.23,29-36.71,64.58-127.53C724-284.3,785-298.63,821-259.13a71,71,0,0,1,13.69,22.56c17.68,46,6.81,80-6.81,107.89-12,24.62-34.56,42.72-61.45,47.91-23.06,4.45-48.37-.35-66.48-24.27a78.88,78.88,0,0,1-12.66-25.8c-14.75-51,4.14-88.76,11-101.41,6.18-11.39,37.26-69.61,103.42-42.24,55.71,23.05,100.66-23.31,100.66-23.31" transform="translate(311.08 476.02)" />
                </svg>
            </div>
            <div class="apple-spinner-wrap">
                ${blades}
            </div>
        `;
        
        bootScreen.style.display = 'flex';
        bootScreen.style.opacity = '1';
        bootScreen.style.visibility = 'visible';
        bootScreen.classList.remove('boot-complete');

        setTimeout(() => {
            bootScreen.classList.add('boot-complete');
            document.body.classList.add('app-ready');
            
            setTimeout(() => {
                bootScreen.style.display = 'none';
                bootScreen.innerHTML = '';
            }, 800);
            
        }, 4000); 
    }
})();

;(function() {
    const NAV_PHYSICS = { tension: 320, friction: 26, mass: 1.8 };
    
    const BTN_PHYSICS = { tension: 450, friction: 18, mass: 0.5 };

    const NAV_LIMIT = 50; 
    const BTN_LIMIT = 20;

    class TitaniumEngine {
        constructor() {
            this.targets = new Map();
            this.activeDrag = null;
            this.rafId = null;
            this.lastTime = 0;

            this.init();
        }

        init() {
            this.register('galvan-top-nav-island', 'nav');
            this.register('galvan-notification-hub', 'btn');
            this.register('galvan-customize-hub', 'btn');

            window.addEventListener('pointermove', this.onMove.bind(this), { passive: false });
            window.addEventListener('pointerup', this.onUp.bind(this), { passive: true });
            window.addEventListener('pointercancel', this.onUp.bind(this), { passive: true });
        }

        register(id, type) {
            const el = document.getElementById(id);
            if (!el) return;

            el.classList.add('ios-titanium');
            
            this.targets.set(el, {
                el: el,
                type: type,
                phys: type === 'nav' ? NAV_PHYSICS : BTN_PHYSICS,
                limit: type === 'nav' ? NAV_LIMIT : BTN_LIMIT,
                x: 0, y: 0, 
                vx: 0, vy: 0,
                scaleX: 1, scaleY: 1,
                isDragging: false,
                startX: 0, startY: 0,
                lastDragTime: 0, lastDragX: 0, lastDragY: 0
            });

            el.addEventListener('pointerdown', (e) => this.onDown(e, el), { passive: false });
        }

        onDown(e, el) {
            const s = this.targets.get(el);
            
            if (e.button !== 0 || el.classList.contains('expanded')) return;
            if (e.target.closest('button')) return;

            if (e.cancelable) e.preventDefault();

            el.setPointerCapture(e.pointerId);
            el.classList.add('titanium-active');
            
            s.isDragging = true;
            s.startX = e.clientX;
            s.startY = e.clientY;
            
            s.lastDragX = e.clientX;
            s.lastDragY = e.clientY;
            s.lastDragTime = performance.now();
            s.vx = 0; s.vy = 0;

            this.activeDrag = s;
            
            if (!this.rafId) {
                this.lastTime = performance.now();
                this.rafId = requestAnimationFrame(this.loop.bind(this));
            }
        }

        onMove(e) {
            if (!this.activeDrag) return;
            const s = this.activeDrag;

            if (e.cancelable) e.preventDefault();

            const rawDx = e.clientX - s.startX;
            const rawDy = e.clientY - s.startY;

            if (s.type === 'btn') {
                s.x = this.rubberBand(rawDx, s.limit);
                s.y = this.rubberBand(rawDy, s.limit);
                
                const stress = 0.008;
                s.scaleX = 1 + (Math.abs(s.x) * stress) - (Math.abs(s.y) * stress * 0.5);
                s.scaleY = 1 + (Math.abs(s.y) * stress) - (Math.abs(s.x) * stress * 0.5);
            } 
            else if (s.type === 'nav') {
                s.x = this.rubberBand(rawDx, 5); 
                
                if (rawDy > 0) {
                    s.y = this.rubberBand(rawDy, s.limit);
                    s.scaleY = 1 + (s.y * 0.003); 
                    s.scaleX = 1 - (s.y * 0.001);
                } else {
                    s.y = this.rubberBand(rawDy, 5);
                    s.scaleY = 1; s.scaleX = 1;
                }
            }

            const now = performance.now();
            const dt = now - s.lastDragTime;
            if (dt > 8) {
                const mult = s.type === 'nav' ? 8 : 12;
                s.vx = (e.clientX - s.lastDragX) / dt * mult;
                s.vy = (e.clientY - s.lastDragY) / dt * mult;
                s.lastDragTime = now;
                s.lastDragX = e.clientX;
                s.lastDragY = e.clientY;
            }
        }

        onUp(e) {
            if (!this.activeDrag) return;
            const s = this.activeDrag;

            s.isDragging = false;
            s.el.classList.remove('titanium-active');
            
            if(e.pointerId) s.el.releasePointerCapture(e.pointerId);

            if (Math.abs(s.x) > 4 || Math.abs(s.y) > 4) {
                const kill = (ev) => { ev.stopPropagation(); ev.preventDefault(); };
                s.el.addEventListener('click', kill, { capture: true, once: true });
            }

            this.activeDrag = null;
        }

        rubberBand(offset, limit) {
            if (limit === 0) return 0;
            return (offset * limit * 2.5) / (Math.abs(offset) + (limit * 3));
        }

        loop(now) {
            const dt = Math.min((now - this.lastTime) / 1000, 0.05); 
            this.lastTime = now;
            
            let activeCount = 0;

            for (const s of this.targets.values()) {
                
                if (s.isDragging) {
                    this.render(s);
                    activeCount++;
                    continue;
                }

                if (Math.abs(s.x) < 0.05 && Math.abs(s.y) < 0.05 && 
                    Math.abs(s.vx) < 0.05 && Math.abs(s.vy) < 0.05 &&
                    Math.abs(s.scaleX - 1) < 0.001) {
                    
                    if (s.x !== 0) { 
                        s.x = 0; s.y = 0; s.vx = 0; s.vy = 0; s.scaleX = 1; s.scaleY = 1;
                        this.render(s);
                    }
                    continue;
                }

                activeCount++;

                const p = s.phys;

                const ax = (-p.tension * s.x - p.friction * s.vx) / p.mass;
                s.vx += ax * dt;
                s.x += s.vx * dt;

                const ay = (-p.tension * s.y - p.friction * s.vy) / p.mass;
                s.vy += ay * dt;
                s.y += s.vy * dt;

                const decay = s.type === 'nav' ? 0.2 : 0.15;
                s.scaleX += (1 - s.scaleX) * decay;
                s.scaleY += (1 - s.scaleY) * decay;

                this.render(s);
            }

            if (activeCount > 0) {
                this.rafId = requestAnimationFrame(this.loop.bind(this));
            } else {
                this.rafId = null;
            }
        }

        render(s) {
            const sx = Math.max(0.6, Math.min(1.4, s.scaleX));
            const sy = Math.max(0.6, Math.min(1.4, s.scaleY));
            
            if (s.type === 'nav') {
                s.el.style.transform = `translate3d(calc(-50% + ${s.x.toFixed(2)}px), ${s.y.toFixed(2)}px, 0) scale(${sx.toFixed(3)}, ${sy.toFixed(3)})`;
            } else {
                s.el.style.transform = `translate3d(${s.x.toFixed(2)}px, ${s.y.toFixed(2)}px, 0) scale(${sx.toFixed(3)}, ${sy.toFixed(3)})`;
            }
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => new TitaniumEngine());
    } else {
        new TitaniumEngine();
    }
})();

;(function() {
    const setupQASearch = () => {
        const hubContent = document.querySelector('#quick-actions-hub .qa-content-layer');
        if (!hubContent) return;

        if (hubContent.querySelector('.qa-search-box')) return;

        const searchContainer = document.createElement('div');
        searchContainer.className = 'qa-search-box';
        searchContainer.innerHTML = `
            <ion-icon name="search" class="qa-search-icon"></ion-icon>
            <input type="text" class="qa-search-input" placeholder="Search recent chats..." autocomplete="off">
            <button class="qa-search-clear"><ion-icon name="close"></ion-icon></button>
        `;

        const actionRow = hubContent.querySelector('.qa-action-row');
        const divider = hubContent.querySelector('.qa-divider');
        
        if (actionRow && divider) {
            hubContent.insertBefore(searchContainer, divider);
        } else if (actionRow) {
            hubContent.insertBefore(searchContainer, actionRow.nextSibling);
        } else {
            hubContent.prepend(searchContainer);
        }

        const input = searchContainer.querySelector('.qa-search-input');
        const clearBtn = searchContainer.querySelector('.qa-search-clear');
        const listView = document.getElementById('qa-list');

        const filterList = (term) => {
            if (!listView) return;
            const items = listView.querySelectorAll('.qa-list-item');
            const lowerTerm = term.toLowerCase();
            let hasVisible = false;

            items.forEach(item => {
                const textEl = item.querySelector('.qa-list-text');
                if (textEl) {
                    const text = textEl.textContent.toLowerCase();
                    if (text.includes(lowerTerm)) {
                        item.style.display = 'flex';
                        hasVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                }
            });

            let noRes = listView.querySelector('.qa-no-results');
            if (!noRes) {
                noRes = document.createElement('div');
                noRes.className = 'qa-no-results';
                noRes.textContent = 'No matching chats';
                listView.appendChild(noRes);
            }
            
            noRes.style.display = (term && !hasVisible) ? 'block' : 'none';
        };

        input.addEventListener('input', (e) => filterList(e.target.value));
        
        clearBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            input.value = '';
            input.focus();
            filterList('');
        });

        input.addEventListener('click', (e) => e.stopPropagation());
        
        input.addEventListener('focus', () => {
        });
    };

    const hub = document.getElementById('quick-actions-hub');
    if (hub) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((m) => {
                if (m.type === 'attributes' && m.attributeName === 'class') {
                    if (hub.classList.contains('active')) {
                        setTimeout(setupQASearch, 50);
                    }
                }
            });
        });
        
        observer.observe(hub, { attributes: true });
        
        setupQASearch();
    }
})();

;(function() {
    class ElasticTabSystem {
        constructor(wrapper) {
            this.wrapper = wrapper;
            this.glider = wrapper.querySelector('.oneui-tab-glider');
            this.btns = wrapper.querySelectorAll('.oneui-tab-btn');
            
            this.state = {
                dragging: false,
                startX: 0,
                currentX: 0,     
                wrapperScale: 1, 
                wrapperX: 0,     
                maxTranslate: 0, 
                activeTab: 0     
            };

            this.measure();
            this.bindEvents();
            
            window.addEventListener('resize', () => this.measure());
        }

        measure() {
            const rect = this.wrapper.getBoundingClientRect();
            this.state.maxTranslate = (rect.width / 2); 
            
            if (this.wrapper.classList.contains('show-basic')) {
                this.state.activeTab = 1;
                this.state.currentX = this.state.maxTranslate;
            } else {
                this.state.activeTab = 0;
                this.state.currentX = 0;
            }
        }

        bindEvents() {
            this.wrapper.addEventListener('pointerdown', this.onDown.bind(this));
            window.addEventListener('pointermove', this.onMove.bind(this));
            window.addEventListener('pointerup', this.onUp.bind(this));
            window.addEventListener('pointercancel', this.onUp.bind(this));
            
            this.btns.forEach((btn, index) => {
                btn.addEventListener('click', (e) => {
                    if (!this.state.dragging) {
                        this.snapTo(index);
                    }
                });
            });
        }

        onDown(e) {
            if (e.button !== 0) return;
            e.preventDefault();

            this.state.dragging = true;
            this.state.startX = e.clientX;
            
            this.wrapper.classList.add('is-dragging');
            this.wrapper.classList.remove('is-snapping');
            
            this.measure();
            
            this.state.initialDragX = this.state.currentX; 
            this.wrapper.setPointerCapture(e.pointerId);
        }

        onMove(e) {
            if (!this.state.dragging) return;

            const deltaX = e.clientX - this.state.startX;
            let rawPos = this.state.initialDragX + deltaX;

            let visualGliderX = rawPos;
            let containerShift = 0;
            let containerScale = 1;

            if (rawPos < 0) {
                visualGliderX = 0; 
                const overflow = Math.abs(rawPos);
                
                containerScale = 1 + (overflow * 0.002);
                containerShift = (this.wrapper.offsetWidth * (containerScale - 1)) / 4;
            } 
            else if (rawPos > this.state.maxTranslate) {
                visualGliderX = this.state.maxTranslate; 
                const overflow = rawPos - this.state.maxTranslate;
                
                containerScale = 1 + (overflow * 0.002);
                containerShift = -(this.wrapper.offsetWidth * (containerScale - 1)) / 4;
            } else {
                visualGliderX = rawPos;
            }

            this.glider.style.transform = `translateX(${visualGliderX}px)`;
            
            this.wrapper.style.transform = `translateX(${containerShift}px) scaleX(${containerScale})`;
            
            if (containerScale > 1.15) {
            }
        }

        onUp(e) {
            if (!this.state.dragging) return;
            this.state.dragging = false;
            
            this.wrapper.classList.remove('is-dragging');
            this.wrapper.classList.add('is-snapping');
            this.wrapper.releasePointerCapture(e.pointerId);

            const delta = e.clientX - this.state.startX;
            const threshold = 20; 

            let targetTab = this.state.activeTab;

            if (Math.abs(delta) > threshold) {
                if (delta > 0) targetTab = 1; 
                else targetTab = 0;           
            }

            this.snapTo(targetTab);
        }

        snapTo(index) {
            this.state.activeTab = index;
            
            this.wrapper.style.transform = '';
            
            const targetX = index === 0 ? 0 : this.state.maxTranslate;
            this.glider.style.transform = `translateX(${targetX}px)`;
            
            if (index === 1) {
this.wrapper.classList.add('show-basic');
            } else {
                this.wrapper.classList.remove('show-basic');
            }
            
            const targetBtn = this.btns[index];
            if(targetBtn) {
                this.btns.forEach(b => b.classList.remove('active'));
                targetBtn.classList.add('active');
                
                const mode = targetBtn.dataset.tab; 
                const event = new CustomEvent('tab-switch', { detail: mode });
                this.wrapper.dispatchEvent(event);
                
                if (navigator.vibrate) navigator.vibrate(10);
            }
        }
    }

    const observer = new MutationObserver((mutations) => {
        mutations.forEach((m) => {
            m.addedNodes.forEach((node) => {
                if (node.nodeType === 1) {
                    let wrapper = null;
                    if (node.classList.contains('oneui-tabs-wrapper')) wrapper = node;
                    else wrapper = node.querySelector('.oneui-tabs-wrapper');

                    if (wrapper && !wrapper.dataset.physicsInit) {
                        wrapper.dataset.physicsInit = "true";
                        new ElasticTabSystem(wrapper);
                    }
                }
            });
        });
    });

    const container = document.getElementById('quick-color-palette-options');
    if (container) {
        observer.observe(container, { childList: true, subtree: true });
    }
    
    const existing = document.querySelector('.oneui-tabs-wrapper');
    if(existing && !existing.dataset.physicsInit) {
        existing.dataset.physicsInit = "true";
        new ElasticTabSystem(existing);
    }

})();
</script>
